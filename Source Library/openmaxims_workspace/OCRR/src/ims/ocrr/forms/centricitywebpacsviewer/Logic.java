//#############################################################################
//#                                                                           #
//#  Copyright (C) <2015>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#  IMS MAXIMS provides absolutely NO GUARANTEE OF THE CLINICAL SAFTEY of    #
//#  this program.  Users of this software do so entirely at their own risk.  #
//#  IMS MAXIMS only ensures the Clinical Safety of unaltered run-time        #
//#  software that it builds, deploys and maintains.                          #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Rory Fitzpatrick using IMS Development Environment (version 1.71 build 3763.19232)
// Copyright (C) 1995-2010 IMS MAXIMS. All rights reserved.

package ims.ocrr.forms.centricitywebpacsviewer;


import ims.configuration.gen.ConfigFlag;
import ims.core.resource.people.vo.MemberOfStaffRefVo;
import ims.core.vo.PacsConfigurationVo;
import ims.core.vo.PatientId;
import ims.core.vo.PatientIdCollection;
import ims.core.vo.lookups.PACSClientType;
import ims.core.vo.lookups.PatIdType;
import ims.domain.exceptions.StaleObjectException;
import ims.framework.enumerations.DialogResult;
import ims.framework.enumerations.SystemLogLevel;
import ims.framework.enumerations.SystemLogType;
import ims.framework.exceptions.PresentationLogicException;
import ims.framework.utils.DateTime;
import ims.ocrr.vo.PACSLaunchAuditVo;

import org.apache.log4j.Logger;

public class Logic extends BaseLogic
{
	private static final long serialVersionUID = 1L;
	private static final Logger	LOG	= Logger.getLogger(ims.ocrr.forms.centricitywebpacsviewer.Logic.class);

	@Override
	protected void onFormOpen(Object[] args) throws ims.framework.exceptions.PresentationLogicException
	{
		PacsConfigurationVo tempVo = domain.getPACSConfigVo();
		String userName = engine.getLoggedInUser().getUsername();
		if(tempVo == null)
		{
			engine.showMessage("No PACS Configuration found.");
			return;
		}
			
		StringBuffer sbURL = new StringBuffer();
		String accessionNumber=null;
		String identifierValue=null;
		String typeCode=null;

		if (form.getGlobalContext().OCRR.CentricityWebPACS.getAccessionNumberIsNotNull())
		{
			accessionNumber=form.getGlobalContext().OCRR.CentricityWebPACS.getAccessionNumber();
		}
		else if(form.getGlobalContext().Core.getPatientShortIsNotNull())
		{
			PatientIdCollection ids= form.getGlobalContext().Core.getPatientShort().getIdentifiers();
			for (PatientId patientId : ids)
			{
				if(patientId.getTypeIsNotNull()
					&&tempVo.getPrimaryIdentifier()!=null	
					&&patientId.getType().getID()==tempVo.getPrimaryIdentifier().getID())
				{
					if (patientId.getType().equals(PatIdType.NHSN)) //http://jira/browse/WDEV-21158
						identifierValue=(patientId.getValue()!=null)?patientId.getValue().replace(" ", ""):null;
					else
						identifierValue=patientId.getValue();
					typeCode=tempVo.getPrimaryIdentifierCodeIsNotNull()?tempVo.getPrimaryIdentifierCode():"";
					break;
					
				}
			}
			if(identifierValue==null) //try secondary  type
			{
				for (PatientId patientId : ids)
				{
					if(patientId.getTypeIsNotNull()
						&&tempVo.getSecondaryIdentifier()!=null
						&&patientId.getType().getID()==tempVo.getSecondaryIdentifier().getID())
					{
						if (patientId.getType().equals(PatIdType.NHSN)) //http://jira/browse/WDEV-21158
							identifierValue=(patientId.getValue()!=null)?patientId.getValue().replace(" ", ""):null;
						else
							identifierValue=patientId.getValue();
						typeCode=tempVo.getSecondaryIdentifierCodeIsNotNull()?tempVo.getSecondaryIdentifierCode():"";
						break;
						
					}
				}
				
			}
		}
		else
		{
			engine.showMessage("Patient must be selected.");
			return;
		}
		sbURL.append(tempVo.getServerAddress());
		if(tempVo.getUseEncryptedTokenIsNotNull()
			&&tempVo.getUseEncryptedToken().equals(true))
		{
			sbURL.append(tempVo.getEncryptedTokenParam());
			try
			{
				sbURL.append(ims.admin.forms.pacsconfig.Logic.encrypt(tempVo.buildParameterList(accessionNumber,userName,identifierValue,typeCode),tempVo.getAESKey()));
			} catch (Exception e)
			{
				String message="Error encrypting patient details"+e.getMessage()!=null?e.getMessage():"";
				LOG.error(message, e);
				engine.showMessage(message);
				engine.createSystemLogEntry(SystemLogType.APPLICATION, SystemLogLevel.FATALERROR, message);
			}
		}
		else
		{
			sbURL.append("&");	
			sbURL.append(tempVo.buildParameterList(accessionNumber,userName,identifierValue,typeCode));
		}
		
		if (form.getGlobalContext().Core.getPatientShort() != null)
		{
			PACSLaunchAuditVo voPacs = new PACSLaunchAuditVo();
			voPacs.setPatient(form.getGlobalContext().Core.getPatientShort());
			voPacs.setAccessionNo(form.getGlobalContext().OCRR.CentricityWebPACS.getAccessionNumber());
			voPacs.setLaunchDateTime(new DateTime());
			if (engine.getLoggedInUser() != null
				&& engine.getLoggedInUser().getMosId() != null	)
				voPacs.setLaunchingUser(new MemberOfStaffRefVo(engine.getLoggedInUser().getMosId(), 0));
			voPacs.setPACSClientType(tempVo.getPACSClientType());
			
			voPacs.validate();

			String[] arrErrors = voPacs.validate();
			if (arrErrors != null)
			{
				engine.showErrors(arrErrors);
				return;
			}

			try 
			{
				domain.savePACSAuditRecord(voPacs);
			} 
			catch (StaleObjectException e) 
			{
				engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
				return;
			}
		}
				
		if (tempVo.getPACSClientTypeIsNotNull())
		{
			if (tempVo.getPACSClientType().equals(PACSClientType.CENTRICITY))
			{
				form.htmView().setIFrameValue(sbURL.toString());
				System.out.println(sbURL.toString());
			}
			else if (tempVo.getPACSClientType().equals(PACSClientType.CARESTREAM))
			{
				StringBuffer html = new StringBuffer();				
				html.append("<OBJECT ID=\"ChromeFrame\" width=\"100%\" height =\"100%\" CODEBASE=\"http://www.google.com\"");
				html.append("CLASSID=\"CLSID:E0A900DF-9611-4446-86BD-4B1D47E7DB2A\">");
				html.append("<PARAM NAME=\"src\" VALUE=\"" + sbURL.toString() +"\">");
				html.append("</OBJECT>");
				form.htmView().setHTML(html.toString(), true);
				System.out.println(html.toString());
			}
		}
		else
		{
			form.htmView().setIFrameValue(sbURL.toString());
		}
	}
	
	//WDEV-22914
	@Override
	protected void onBtnCloseClick() throws PresentationLogicException
	{
		engine.close(DialogResult.CANCEL);		
	}
}
