//#############################################################################
//#                                                                           #
//#  Copyright (C) <2015>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#  IMS MAXIMS provides absolutely NO GUARANTEE OF THE CLINICAL SAFTEY of    #
//#  this program.  Users of this software do so entirely at their own risk.  #
//#  IMS MAXIMS only ensures the Clinical Safety of unaltered run-time        #
//#  software that it builds, deploys and maintains.                          #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Neil McAnaspie using IMS Development Environment (version 1.54 build 2706.27392)
// Copyright (C) 1995-2007 IMS MAXIMS plc. All rights reserved.

package ims.emergency.forms.attendancedetails;

import ims.admin.vo.EDAttendanceControlsConfigVoCollection;
import ims.admin.vo.lookups.EDAttendenceControlType;
import ims.configuration.gen.ConfigFlag;
import ims.core.admin.vo.EmergencyAttendanceRefVo;
import ims.core.admin.vo.EmergencyEpisodeRefVo;
import ims.core.helper.ResetPIDBarHelper;
import ims.core.vo.CareContextShortVo;
import ims.core.vo.CareSpellVo;
import ims.core.vo.EDAttendanceformsConfigVo;
import ims.core.vo.EpisodeofCareLiteVo;
import ims.core.vo.LocSiteLiteVo;
import ims.core.vo.LocSiteShortVo;
import ims.core.vo.LocationLiteVo;
import ims.core.vo.Patient;
import ims.core.vo.PatientShort;
import ims.core.vo.lookups.LocationType;
import ims.domain.exceptions.StaleObjectException;
import ims.emergency.forms.attendancedetails.GenForm.grdPreviousHistoryRow;
import ims.emergency.vo.AttendanceDetailsVo;
import ims.emergency.vo.ChartRequestedVo;
import ims.emergency.vo.EmergencyAttendanceBillingVo;
import ims.emergency.vo.EmergencyAttendanceNonInsuranceHealthCoverVo;
import ims.emergency.vo.EmergencyAttendanceShortVo;
import ims.emergency.vo.EmergencyEpisodeShortVo;
import ims.emergency.vo.EmergencyEpisodeShortVoCollection;
import ims.emergency.vo.EpisodeDetailsVo;
import ims.emergency.vo.EpisodeOfcareLiteVo;
import ims.emergency.vo.TrackingSendToAreaVo;
import ims.emergency.vo.enums.EmergencyAttendanceEvent;
import ims.framework.Control;
import ims.framework.FormName;
import ims.framework.LayerBridge;
import ims.framework.MessageButtons;
import ims.framework.enumerations.DialogResult;
import ims.framework.enumerations.FormMode;
import ims.framework.enumerations.SortOrder;
import ims.framework.exceptions.FormOpenException;
import ims.framework.exceptions.PresentationLogicException;
import ims.framework.utils.Color;
import ims.framework.utils.DateTime;

import java.util.Comparator;

public class Logic extends BaseLogic
{
	private static final long serialVersionUID = 1L;
	
	@Override
	//WDEV-16673
	protected void onContextMenuItemClick(int menuItemID, Control sender) throws PresentationLogicException 
	{
		switch(menuItemID)
		{
			case GenForm.ContextMenus.EmergencyNamespace.AttendanceDetails.NewEpisode:
				form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().newInstance();
				form.getLocalContext().setIsNewAttendanceInstance(true); //WDEV-22801
				break;
			case GenForm.ContextMenus.EmergencyNamespace.AttendanceDetails.EditEpisode:
				form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().editInstance();
				break;
			case GenForm.ContextMenus.EmergencyNamespace.AttendanceDetails.AddAttendance:
				form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().newInstance();
				form.getLocalContext().setIsNewAttendanceInstance(true); //WDEV-22801
				break;
			case GenForm.ContextMenus.EmergencyNamespace.AttendanceDetails.EditAttendance:
				form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().editInstance();
				break;	
			case GenForm.ContextMenus.EmergencyNamespace.AttendanceDetails.CancelAttendance:		//wdev-19040
				cancelAttendanceDetails();
				break;
		}
	}
	//wdev-19040
	private void cancelAttendanceDetails()
	{
		grdPreviousHistoryRow selectedRow = form.grdPreviousHistory().getSelectedRow();
		if( selectedRow != null && selectedRow.getValue() != null)
		{
			if( selectedRow.getValue() instanceof EmergencyAttendanceShortVo)
			{
				EmergencyAttendanceShortVo tempVo  = (EmergencyAttendanceShortVo) selectedRow.getValue(); 
				form.getLocalContext().setCanceAttendanceMessageBox(engine.showMessage("Are you sure you want to Cancel this attendance for patient " + form.getGlobalContext().Core.getPatientShort().getName().toString() + " for Registration date: " + tempVo.getRegistrationDateTime().toString() + " and Arrival date: " + tempVo.getArrivalDateTime().toString() + " ?", "Warning", MessageButtons.YESNO));
			}
		} 
		
	}
	
	protected void onFormModeChanged() 
	{	
		//WDEV-16673
		updateControlState();
	}

	@Override
	protected void onFormOpen(Object[] args) throws PresentationLogicException 
	{
		EDAttendanceControlsConfigVoCollection attendanceControlsConfig = domain.getEDAttendanceControlsConfig(EDAttendenceControlType.ATTEND_CONTROLS);
		
		//WDEV-17804
		if (attendanceControlsConfig==null || attendanceControlsConfig.size()==0)
		{	
			throw new PresentationLogicException("The Script to populate EDConfig form should be run first !");
		}
		
		initialize();		//wdev-14420
		if(	getLoc() == null)
		{
			engine.showMessage(" The current location should be of type Emergency. ");
			
		}
		open();	
		form.getLocalContext().setOpenFirstTime(Boolean.TRUE); //wdev-14420
		
	}
	
	//WDEV-16673
	private void initialize() 
	{
		form.getLocalContext().setOpenFirstTime(Boolean.FALSE);
		
		EDAttendanceformsConfigVo formsConfig = domain.getEDAttendanceformsConfig();
		form.getLocalContext().setEDAttendanceformsConfigVo(formsConfig);//WDEV-22943
		if(formsConfig != null)
			form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().setLocalCondextDisplayPrintReport(formsConfig.getDisplayPrintDialog());//WDEV-22943
		
		if (ConfigFlag.UI.SVUH_MANDATORY_DEMOGRAPHIC_ATTRIBUTES.getValue()) //WDEV-22956
		{
			initializeFinalTab(formsConfig); 
		}
		
		form.getLocalContext().setIsPatientInEd(null);
		form.getLocalContext().setAttendanceOfPatientInEd(null);
	}

	//WDEV-22956
	private void initializeFinalTab(EDAttendanceformsConfigVo formsConfig)
	{
		if (formsConfig==null)
			return;
		
		if (Boolean.TRUE.equals(formsConfig.getInsuranceTabVisible()))
		{
			form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().setIsFinalTab(true);
		}
		else if (Boolean.TRUE.equals(formsConfig.getChartRequestedTabVisible()))
		{
			form.lyrEmergencyAttendance().tabChart().ccChatRequested().setIsFinalTab(true);
		}
		else if (Boolean.TRUE.equals(formsConfig.getInvoicesBillingTabVisible()))
		{
			form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().setIsFinalTab(true);
		}
		else
		{
			form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().setIsFinalTab(true);
		}
		
	}
	private void open() throws PresentationLogicException 
	{	
		//WDEV-16673
		form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().clearAttendanceDetails();	
		//get PatientVo and put it in local context
		getPatient(form.getGlobalContext().Core.getPatientShort());
		
		// List all the Emergency history for the patient
		EmergencyEpisodeShortVoCollection emergencyHistory = domain.listEmergencyEpisodes(form.getGlobalContext().Core.getPatientShort(), new Integer(200), null, null, null);
		
		AttendanceDetailsVo attendVo = domain.getAttendanceDetails(getLastEmergencyAttendance(emergencyHistory));
//		if(form.getGlobalContext().Core.getPatientShortIsNotNull())
//		{
//			attendVo = domain.getLastAttendance(form.getGlobalContext().Core.getPatientShort());
//		}
		if(attendVo != null)
		{
			if(attendVo.getDischargeDateTimeIsNotNull())
			{
				int hours = hoursDiff(new DateTime(),attendVo.getDischargeDateTime() );
				if(hours > 48 && hours <= 72)
				{
					form.lbl24h().setValue("Patient has been departed in last 72 hrs");//WDEV-17920
					form.lbl24h().setVisible(true);
				}
				else if(hours > 24 && hours <= 48)
				{
					form.lbl24h().setValue("Patient has been departed in last 48 hrs");//WDEV-17920
					form.lbl24h().setVisible(true);
				}
				else if(hours <= 24)
				{
					form.lbl24h().setValue("Patient has been departed in last 24 hrs");//WDEV-17920
					form.lbl24h().setVisible(true);
				}
				else
				{
					form.lbl24h().setValue("");
					form.lbl24h().setVisible(false);
				}
			}
			else
			{
				form.lbl24h().setValue("");
				form.lbl24h().setVisible(false);
			}
			
			//WDEV-17008
			form.lblAttendingAsAdultPaediatric().setValue((attendVo.getAgeAtAttendanceIsNotNull() && attendVo.getAgeAtAttendance()<= ConfigFlag.GEN.PAEDIATRIC_AGE.getValue()) ? "Attending as Paediatric patient" : "Attending as Adult patient");
		}
		else
		{			
			form.lbl24h().setValue("");	
			form.lbl24h().setVisible(false);
						
		}
		
		//is the patient currenlty in Emergency Department
		TrackingSendToAreaVo trackVo = isPatientCurrentlyInEmergencyDepartment();  //wdev-14420
		if( trackVo != null)  //wdev-14420
		{
			//wdev-14420
			form.getLocalContext().setAllowNewAttendance(Boolean.FALSE); 
			
			if(	Boolean.FALSE.equals(form.getLocalContext().getOpenFirstTime()))	
				form.getGlobalContext().Emergency.setCurrentEmergencyAttendance(trackVo.getAttendance());
			
			form.getLocalContext().setAttendanceOfPatientInEd(trackVo.getAttendance());
			form.getLocalContext().setIsPatientInEd(Boolean.TRUE);
		
			form.lblDischargeWarning().setVisible(true);	
			String nameOfArea = trackVo.getCurrentAreaIsNotNull() ? trackVo.getCurrentArea().getAreaDisplayName():"";
			form.lblDischargeWarning().setValue("Patient is currently in " + nameOfArea);							
		}
		else if(attendVo!=null && Boolean.TRUE.equals(attendVo.getIsExpectedArrival())) //WDEV-17278
		{
			//We need to also check here to see if the patient is a pending arrival.
			//if they are treat them as if they are in tracking already
			
			form.getLocalContext().setAllowNewAttendance(Boolean.FALSE);

			if(	Boolean.FALSE.equals(form.getLocalContext().getOpenFirstTime()))	
				form.getGlobalContext().Emergency.setCurrentEmergencyAttendance(attendVo);
			
			form.lblDischargeWarning().setVisible(true);		
			form.getLocalContext().setIsPatientInEd(Boolean.FALSE);
			form.getLocalContext().setAttendanceOfPatientInEd(attendVo);
			form.lblDischargeWarning().setValue("Patient is in Pending Arrivals List");
			
		}
		else
		{
			//hide Emergency Attendance Discharge Details
			if (domain.getMosUser() == null)
			{
				engine.showMessage(" The current logged in user is not a member of staff. ");
				form.getLocalContext().setAllowNewAttendance(Boolean.FALSE);
				return;
			}
			form.getLocalContext().setAllowNewAttendance(Boolean.TRUE); //wdev-14420	
			form.lblDischargeWarning().setVisible(false);		
			form.getLocalContext().setIsPatientInEd(Boolean.FALSE);
			form.getLocalContext().setAttendanceOfPatientInEd(null);
		}
	
		if (Boolean.TRUE.equals(form.getLocalContext().getOpenFirstTime()) && form.getLocalContext().getSelectedRecord() == null) //check if it's a  new attendance was saved //wdev-14420
		{
			form.getGlobalContext().Emergency.setCurrentEmergencyAttendance(getLastAttendanceFromLastEpisode(form.getGlobalContext().Emergency.getSelectedEmergencyEpisode()));
		}
		
		populatePreviousHistoryGrid(emergencyHistory);
		
		if( form.getLocalContext().getCountOfPreviousAttendances() > 0  && form.getLocalContext().getIsPatientInEd())//wdev-17989
		{
			Integer temp = form.getLocalContext().getCountOfPreviousAttendances() - 1;
			form.lbllblCountOfPreviousAttendance2().setValue(temp.toString());
		}
		//wdev-17989
		else if( form.getLocalContext().getCountOfPreviousAttendances() > 0  && !form.getLocalContext().getIsPatientInEd())
		{
			Integer temp = form.getLocalContext().getCountOfPreviousAttendances();
			form.lbllblCountOfPreviousAttendance2().setValue(temp.toString());
		} 
		
		if (form.getGlobalContext().Emergency.getCurrentEmergencyAttendanceIsNotNull())
		{
			form.grdPreviousHistory().setValue(form.getGlobalContext().Emergency.getCurrentEmergencyAttendance());
			onGrdPreviousHistorySelectionChanged();
		}

		//WDEV-22956
		if (ConfigFlag.UI.SVUH_MANDATORY_DEMOGRAPHIC_ATTRIBUTES.getValue() && form.grdPreviousHistory().getValue()==null)
		{
			form.lyrEmergencyAttendance().showtabAttDet();
		}
		
		form.setMode(FormMode.VIEW);
		updateControlState();
	
		if(getLoc() != null)
		{
			if(Boolean.TRUE.equals(form.getLocalContext().getAllowNewAttendance()) && Boolean.FALSE.equals(form.getLocalContext().getOpenFirstTime()))
			{	
				form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().newInstance();
				form.getLocalContext().setIsNewAttendanceInstance(true); //WDEV-22801
			}
		}
		else  
		{
			updateControlState();
		}

	}
	
	private EmergencyAttendanceShortVo getLastEmergencyAttendance(EmergencyEpisodeShortVoCollection emergencyHistory)
	{
		if (emergencyHistory == null)
			return null;
		
		// Assume there is no attendance
		EmergencyAttendanceShortVo attendance = null;
		
		// Iterate emergency history and analyze each EmergencyAttendance (from each EmergencyEpisode)
		// And retain the EmergencyAttendance with latest EmergencyAttendance.ArrivalTime 
		for (EmergencyEpisodeShortVo emergencyEpisode : emergencyHistory)
		{
			if (emergencyEpisode.getEmergencyAttendances() != null)
			{
				for (EmergencyAttendanceShortVo emergencyAttendance : emergencyEpisode.getEmergencyAttendances())
				{
					if (attendance == null)
					{
						attendance = emergencyAttendance;
					}
					else if (attendance.getArrivalDateTime().isLessThan(emergencyAttendance.getArrivalDateTime()))
					{
						attendance = emergencyAttendance;
					}
				}
			}
		}

		// Return found attendance (could be null)
		return attendance;
	}
	
	
	
	
	//wdev-14420
	private AttendanceDetailsVo getLastAttendanceFromLastEpisode(EpisodeDetailsVo emergencyEpisode)
	{
		if(emergencyEpisode == null )
			return null;
	
		emergencyEpisode.getEmergencyAttendances().sort(new ArrivalDateComparator(SortOrder.DESCENDING));
		if(emergencyEpisode.getEmergencyAttendancesIsNotNull() && emergencyEpisode.getEmergencyAttendances().size() > 0)
		{
					return emergencyEpisode.getEmergencyAttendances().get(0);
		}
		
		return null;
			
	}
	//wdev-14420
	private int hoursDiff(DateTime startDate, DateTime endDate)
	{
		if (startDate == null)
			throw new IllegalArgumentException("No start date specified");
		if (endDate == null)
			throw new IllegalArgumentException("No end date specified");
		
			
		long endInMillis = endDate.getJavaDate().getTime();
		long startInMillis = startDate.getJavaDate().getTime();
		
		return (int)((((endInMillis < startInMillis ? startInMillis - endInMillis : endInMillis - startInMillis)/1000)/60)/60);
	}

	//----------
	private void populatePreviousHistoryGrid(EmergencyEpisodeShortVoCollection emergencyHistory) 
	{
		// Clear grid
		form.grdPreviousHistory().getRows().clear();		
		form.getLocalContext().setCountOfPreviousAttendances(0);
		
		// Test collection to be populated to grid 
		if (emergencyHistory == null)
			return;
		
		
		
		
		grdPreviousHistoryRow  episodeDetailsRow = null, emergencyAttendancesRow = null;
		//emergencyEpisodes.sort(new InjuryDateComparator(SortOrder.DESCENDING));  //wdev-14420
		for (EmergencyEpisodeShortVo emergencyEpisode : emergencyHistory)
		{	
			if (emergencyEpisode == null || !emergencyEpisode.getEmergencyAttendancesIsNotNull()) // wdev-19363
				continue;
	
			episodeDetailsRow = form.grdPreviousHistory().getRows().newRow();
			
			EpisodeOfcareLiteVo tempVo = emergencyEpisode.getEpisodeOfCare();	//wdev-16070
			episodeDetailsRow.setcolDateTime(tempVo != null ? tempVo.getStartDate():null);					//wdev-16070
			
			episodeDetailsRow.setcolPatCategory((emergencyEpisode.getCategoryIsNotNull() ? emergencyEpisode.getCategory().getText() + " - ":"") + (emergencyEpisode.getPresentingComplaintIsNotNull()? emergencyEpisode.getPresentingComplaint().toString():""));
			
			episodeDetailsRow.setcolEpisodeNo(emergencyEpisode.getID_EmergencyEpisode().toString());
			
			//episodeDetailsRow.setCollapsedImage(form.getImages().Core.CareSpell);
			//episodeDetailsRow.setExpandedImage(form.getImages().Core.CareSpell);
			//----------- wdev-14420
			if (Boolean.TRUE.equals(form.getLocalContext().getIsPatientInEd()) && form.getLocalContext().getAttendanceOfPatientInEdIsNotNull() && form.getLocalContext().getAttendanceOfPatientInEd().getEpisodeIsNotNull() && form.getLocalContext().getAttendanceOfPatientInEd().getEpisode().equals(emergencyEpisode)) 
				episodeDetailsRow.setBackColor(Color.LightGreen);
			//------
			episodeDetailsRow.setBold(true);
			episodeDetailsRow.setValue(emergencyEpisode);
			episodeDetailsRow.setTooltip("DateTime : <b>" + (emergencyEpisode.getInjuryDateTime()!=null ? emergencyEpisode.getInjuryDateTime() :"" )+ (emergencyEpisode.getCategoryIsNotNull() ? "</b><br>Category : <b>" + emergencyEpisode.getCategory().getText() : "") + (emergencyEpisode.getID_EmergencyEpisodeIsNotNull() ? "</b><br>Emergency Episode Number: <b>" + emergencyEpisode.getID_EmergencyEpisode().toString() + "</b>" : ""));//WDEV-14420 //WDEV-17160 //wdev-18230
			
			if (emergencyEpisode.getEmergencyAttendancesIsNotNull())
			{
				episodeDetailsRow.setExpanded(true);
				emergencyEpisode.getEmergencyAttendances().sort(new ArrivalDateComparatorForEmgAttendShort(SortOrder.DESCENDING));   //wdev-20047
				
				for (EmergencyAttendanceShortVo voEmergencyAttendances : emergencyEpisode.getEmergencyAttendances())
				{
					emergencyAttendancesRow = episodeDetailsRow.getRows().newRow();
					
					if (voEmergencyAttendances.getDischargeDateTimeIsNotNull())
					{							
						String emergencyAttendanceNumber = ConfigFlag.GEN.ED_USE_CUSTOM_ATTENDANCE_ID.getValue() ? voEmergencyAttendances.getCustomID() : voEmergencyAttendances.getID_EmergencyAttendance().toString();

						emergencyAttendancesRow.setcolDateTime(voEmergencyAttendances.getRegistrationDateTime() + " - " + voEmergencyAttendances.getDischargeDateTime());
						emergencyAttendancesRow.setcolPatCategory(voEmergencyAttendances.getOutcome() != null ? voEmergencyAttendances.getOutcome().getText() :  null);
						emergencyAttendancesRow.setcolEpisodeNo(emergencyAttendanceNumber);
						
						
						emergencyAttendancesRow.setcolContext((voEmergencyAttendances.getCareContextIsNotNull() && voEmergencyAttendances.getCareContext().getContextIsNotNull())? voEmergencyAttendances.getCareContext().getContext().toString():"");
						
						//emergencyAttendancesRow.setCollapsedImage(form.getImages().Core.BookOpenEnabled);
						if( Boolean.TRUE.equals(form.getLocalContext().getIsPatientInEd()) && form.getLocalContext().getAttendanceOfPatientInEdIsNotNull() && form.getLocalContext().getAttendanceOfPatientInEd().equals(voEmergencyAttendances))  //wdev-14420
							emergencyAttendancesRow.setBackColor(Color.LightBlue);
						emergencyAttendancesRow.setValue(voEmergencyAttendances);
						emergencyAttendancesRow.setTooltip("DateTime : <b>" + (voEmergencyAttendances.getRegistrationDateTime()!=null ? voEmergencyAttendances.getRegistrationDateTime() : "") + " - " + (voEmergencyAttendances.getDischargeDateTime()!=null ? voEmergencyAttendances.getDischargeDateTime() : "") + (voEmergencyAttendances.getOutcomeIsNotNull() ? "</b><br>Outcome : <b>" + voEmergencyAttendances.getOutcome() : "") + (voEmergencyAttendances.getID_EmergencyAttendanceIsNotNull() ? "</b><br>Emergency Attendance Number: <b>" + emergencyAttendanceNumber + "</b><br>Context Type : <b>" + voEmergencyAttendances.getCareContext().getContext().toString() : ""));//WDEV-17160 //wdev-18230
					}
					else
					{
						String emergencyAttendanceNumber = ConfigFlag.GEN.ED_USE_CUSTOM_ATTENDANCE_ID.getValue() ? voEmergencyAttendances.getCustomID() : voEmergencyAttendances.getID_EmergencyAttendance().toString();

						emergencyAttendancesRow.setcolDateTime(voEmergencyAttendances.getArrivalDateTime());
						emergencyAttendancesRow.setcolPatCategory(voEmergencyAttendances.getOutcome() != null ? voEmergencyAttendances.getOutcome().getText() :  null);
						emergencyAttendancesRow.setcolEpisodeNo(emergencyAttendanceNumber);
						emergencyAttendancesRow.setcolContext((voEmergencyAttendances.getCareContextIsNotNull() && voEmergencyAttendances.getCareContext().getContextIsNotNull()) ? voEmergencyAttendances.getCareContext().getContext().toString():"");
						//emergencyAttendancesRow.setCollapsedImage(form.getImages().Core.Alert_RedTriangle2);
						
						if( Boolean.TRUE.equals(form.getLocalContext().getIsPatientInEd()) && form.getLocalContext().getAttendanceOfPatientInEdIsNotNull() && form.getLocalContext().getAttendanceOfPatientInEd().equals(voEmergencyAttendances))  //wdev-14420
							emergencyAttendancesRow.setBackColor(Color.LightBlue);
						
						emergencyAttendancesRow.setValue(voEmergencyAttendances);
						emergencyAttendancesRow.setTooltip("DateTime : <b>" + (voEmergencyAttendances.getRegistrationDateTime()!=null ? voEmergencyAttendances.getRegistrationDateTime():"") + (voEmergencyAttendances.getOutcomeIsNotNull() ? "</b><br>Outcome : <b>" + voEmergencyAttendances.getOutcome() : "") + (voEmergencyAttendances.getID_EmergencyAttendanceIsNotNull() ? "</b><br>Emergency Attendance Number: <b>" + emergencyAttendanceNumber + "</b><br>Context Type : <b>" + voEmergencyAttendances.getCareContext().getContext().toString() : ""));//WDEV-17160 \\wdev-18230
					}
					//wdev-16070
					if( form.getLocalContext().getCountOfPreviousAttendancesIsNotNull() )
					{
						int nr = form.getLocalContext().getCountOfPreviousAttendances();
						nr = nr+1;
						form.getLocalContext().setCountOfPreviousAttendances(nr);
					}
					else
					{
						form.getLocalContext().setCountOfPreviousAttendances(0);
						int nr = form.getLocalContext().getCountOfPreviousAttendances();
						nr = nr+1;
						form.getLocalContext().setCountOfPreviousAttendances(nr);
					}
					//-----------
					
						
				}
			}
		}
		
	}
	
	private void getPatient(PatientShort patient) throws FormOpenException
	{
		Patient voPatient;
		try
		{
			voPatient = domain.getPatient(patient);
		}
		catch (StaleObjectException e)
		{
			// Try a second time. Only then fail.
			try
			{
				voPatient = domain.getPatient(patient);
			}
			catch (StaleObjectException e1)
			{
				throw new FormOpenException("Failed to retrieve Patient due to StaleObjectException");
			}
		}
		if (voPatient == null)
		{
			throw new FormOpenException("Data has been changed, Please perform another Patient Search");
		}
	
		form.getLocalContext().setPatient(voPatient);
	}
	
	
	//wdev-14420
	private TrackingSendToAreaVo isPatientCurrentlyInEmergencyDepartment()
	{
		return domain.isPatientCurrentlyinED(form.getGlobalContext().Core.getPatientShort());
	}
	
	protected void onGrdPreviousHistorySelectionChanged() throws PresentationLogicException  
	{
		//WDEV-16673
		grdPreviousHistoryRow selectedRow = form.grdPreviousHistory().getSelectedRow();
		
		if (selectedRow != null && selectedRow.getValue() != null)
		{
			AttendanceDetailsVo emergencyAttendance = null;
			EpisodeDetailsVo emergencyEpisode = null;
			
			form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().initialize();

			if (selectedRow.getValue() instanceof EmergencyAttendanceRefVo)
			{
				emergencyAttendance = domain.getAttendanceDetails((EmergencyAttendanceRefVo) selectedRow.getValue());
				form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().setValue(emergencyAttendance);
			}
			else if (selectedRow.getValue() instanceof EmergencyEpisodeRefVo)
			{
				emergencyEpisode = domain.getEmergencyEpisode((EmergencyEpisodeRefVo) selectedRow.getValue());
				form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().setValue(emergencyEpisode);
			}
			
			if (selectedRow.getValue() instanceof EmergencyAttendanceRefVo)
			{
				form.getGlobalContext().Core.setCurrentCareContext((emergencyAttendance).getCareContext());
				form.getGlobalContext().Emergency.setCurrentEmergencyAttendance(emergencyAttendance);
				form.getLocalContext().setSelectedRecord(emergencyAttendance);
				form.getGlobalContext().Emergency.setSelectedEmergencyEpisode(domain.getEmergencyEpisode((EmergencyEpisodeRefVo) selectedRow.getParentRow().getValue()));
				
				AttendanceDetailsVo selectedAttendance = form.getGlobalContext().Emergency.getCurrentEmergencyAttendance();
				CareContextShortVo careContext = form.getGlobalContext().Core.getCurrentCareContext();
				EpisodeofCareLiteVo episodeOfCare = careContext.getEpisodeOfCare();
				PatientShort patient = form.getGlobalContext().Core.getPatientShort();
				
				form.lyrEmergencyAttendance().tabChart().ccChatRequested().initialize(selectedAttendance, patient, careContext, episodeOfCare);
				form.lyrEmergencyAttendance().tabChart().ccChatRequested().setValue(domain.getChartRequestedByEmergencyAttendance(selectedAttendance));
				
				form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().initialize(selectedAttendance, patient, episodeOfCare, careContext);
				form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().setValue(domain.getAttendanceBillingByEmergencyAttendance(selectedAttendance));
				
				//wdev-19015
				form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().initialize(selectedAttendance, patient, episodeOfCare, careContext);
				form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().setValue(domain.getEmergencyAttendanceNonInsuranceHealthCoverVo(selectedAttendance));
				//----------
				
				refreshPIDBarText();//WDEV-17332
			}
			else //WDEV-17332
			{
				
				ResetPIDBar(engine, form.getGlobalContext().Core.getPatientShort());//WDEV-17332
			}
			
			
		}	
		updateControlState();
	}

	//WDEV-17332
	private void refreshPIDBarText()
	{
		if (form.getGlobalContext().Core.getPatientShort() == null	
				|| form.getGlobalContext().Core.getEpisodeofCareShort()==null
				|| form.getGlobalContext().Core.getCurrentCareContext()==null)
				return;

			new ResetPIDBarHelper(engine, form.getGlobalContext().Core.getPatientShort() , domain.getPIDDiagnosisInfo(form.getGlobalContext().Core.getCurrentCareContext(), form.getGlobalContext().Core.getEpisodeofCareShort()));
	}
	
	//WDEV-17332
	public void ResetPIDBar(ims.framework.UIEngine paramEngine, PatientShort paramPatient)
	{
		if (paramPatient == null)
			return;
		
		StringBuffer sb = new StringBuffer();
		sb.append(paramPatient.getPatientInfo());
		
		if (paramPatient.getIsDead() != null 
			&& paramPatient.getIsDead().booleanValue())
			paramEngine.setPatientInfo(sb.toString(), ims.configuration.gen.ConfigFlag.UI.RIP_INFO_COLOUR.getValue());
		else
			paramEngine.setPatientInfo(sb.toString());
	}
	
	
	private void updateControlState()
	{			
		//WDEV-16673
		form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().setMode(form.getMode());
		form.lyrEmergencyAttendance().tabChart().ccChatRequested().setMode(form.getMode());
		form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().setMode(form.getMode());
		form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().setMode(form.getMode());	//wdev-19015
		
		boolean SVUH_FUNCTIONALITY = ConfigFlag.UI.SVUH_MANDATORY_DEMOGRAPHIC_ATTRIBUTES.getValue(); //WDEV-22956
		boolean isCurrentLoggedInUserMemberOfStaff = domain.getMosUser() != null; //WDEV-18893
		EDAttendanceformsConfigVo formsConfig = form.getLocalContext().getEDAttendanceformsConfigVo();
	
		grdPreviousHistoryRow selectedRow = form.grdPreviousHistory().getSelectedRow();
		
		form.getContextMenus().Emergency.getAttendanceDetailsCancelAttendanceItem().setVisible(form.getMode().equals(FormMode.VIEW) && selectedRow != null && selectedRow.getValue() != null && selectedRow.getValue() instanceof EmergencyAttendanceShortVo);	//wdev-19040
		if (form.getMode().equals(FormMode.VIEW))
		{
			if (selectedRow != null && selectedRow.getValue() != null)
			{
				if (selectedRow.getValue() instanceof EmergencyAttendanceShortVo)
				{			
					form.getContextMenus().Emergency.getAttendanceDetailsEditAttendanceItem().setVisible(true);
					
				}
				else
				{
					form.getContextMenus().Emergency.getAttendanceDetailsEditEpisodeItem().setVisible(false);			
					form.getContextMenus().Emergency.getAttendanceDetailsEditAttendanceItem().setVisible(false);
					
					
				}				
			}
			else
			{
				form.getContextMenus().Emergency.getAttendanceDetailsEditEpisodeItem().setVisible(false);			
				form.getContextMenus().Emergency.getAttendanceDetailsEditAttendanceItem().setVisible(false);
				
			}
			
			form.getContextMenus().Emergency.getAttendanceDetailsAddAttendanceItem().setVisible(isCurrentLoggedInUserMemberOfStaff && Boolean.TRUE.equals(form.getLocalContext().getAllowNewAttendance()) && form.grdPreviousHistory().getSelectedRow() != null ); //WDEV-18893
	
			form.lyrEmergencyAttendance().tabAttDet().setHeaderVisible(true);
			form.lyrEmergencyAttendance().tabAttDet().setHeaderEnabled(true);
			
			form.lyrEmergencyAttendance().tabChart().setHeaderVisible((form.grdPreviousHistory().getValue() instanceof EmergencyAttendanceShortVo || SVUH_FUNCTIONALITY) && formsConfig!=null && Boolean.TRUE.equals(formsConfig.getChartRequestedTabVisible()));
			form.lyrEmergencyAttendance().tabChart().setHeaderEnabled((form.grdPreviousHistory().getValue() instanceof EmergencyAttendanceShortVo || (SVUH_FUNCTIONALITY && FormMode.EDIT.equals(form.getMode()))));
			
			form.lyrEmergencyAttendance().tabInvoices().setHeaderVisible((form.grdPreviousHistory().getValue() instanceof EmergencyAttendanceShortVo || SVUH_FUNCTIONALITY) && formsConfig!=null && Boolean.TRUE.equals(formsConfig.getInvoicesBillingTabVisible()));
			form.lyrEmergencyAttendance().tabInvoices().setHeaderEnabled((form.grdPreviousHistory().getValue() instanceof EmergencyAttendanceShortVo || (SVUH_FUNCTIONALITY && FormMode.EDIT.equals(form.getMode()))));
			
			//wdev-19015
			form.lyrEmergencyAttendance().tabInsuranceDetails().setHeaderVisible((form.grdPreviousHistory().getValue() instanceof EmergencyAttendanceShortVo || SVUH_FUNCTIONALITY) && formsConfig!=null && Boolean.TRUE.equals(formsConfig.getInsuranceTabVisible()));
			form.lyrEmergencyAttendance().tabInsuranceDetails().setHeaderEnabled((form.grdPreviousHistory().getValue() instanceof EmergencyAttendanceShortVo || (SVUH_FUNCTIONALITY && FormMode.EDIT.equals(form.getMode()))));
			//-----
			if (selectedRow!=null && selectedRow.getValue() instanceof EpisodeDetailsVo)
			{
				form.lyrEmergencyAttendance().showtabAttDet();
			}

		}
		else
		{
			form.lyrEmergencyAttendance().tabAttDet().setHeaderEnabled(form.lyrEmergencyAttendance().tabAttDet().isVisible());
			form.lyrEmergencyAttendance().tabChart().setHeaderEnabled(form.lyrEmergencyAttendance().tabChart().isVisible());
			form.lyrEmergencyAttendance().tabInvoices().setHeaderEnabled(form.lyrEmergencyAttendance().tabInvoices().isVisible());
			form.lyrEmergencyAttendance().tabInsuranceDetails().setHeaderEnabled(form.lyrEmergencyAttendance().tabInsuranceDetails().isVisible());		//wdev-19015
		}
		
		form.lblAttendingAsAdultPaediatric().setVisible(form.grdPreviousHistory().getValue()!=null && form.grdPreviousHistory().getValue() instanceof EmergencyAttendanceShortVo); //WDEV-20453
	}
	
	public class ArrivalDateComparator implements Comparator<AttendanceDetailsVo>
	{
		private int direction = 1;
		
		public ArrivalDateComparator()
		{
			this(SortOrder.ASCENDING);
		}
		
		public ArrivalDateComparator(SortOrder order)
		{
			if (order == SortOrder.DESCENDING)
				direction = -1;
			
		}
		public int compare(AttendanceDetailsVo ob1, AttendanceDetailsVo ob2) 
		{
			DateTime date1 = null;
			DateTime date2 = null;
			if(ob1 instanceof AttendanceDetailsVo )
			{
				AttendanceDetailsVo ps1 = (AttendanceDetailsVo)ob1;
				date1 = ps1.getArrivalDateTime();
			}
			if(ob2 instanceof AttendanceDetailsVo)
			{
				AttendanceDetailsVo ps2 = (AttendanceDetailsVo)ob2;
				date2 = ps2.getArrivalDateTime();
			}
			if(date1 != null )
				return  date1.compareTo(date2)*direction;
			if(date2 != null)
				return (-1)*direction;
			
			return 0;
		}
	
	}
	//wdev-20047
	public class ArrivalDateComparatorForEmgAttendShort implements Comparator<EmergencyAttendanceShortVo>
	{
		private int direction = 1;
		
		public ArrivalDateComparatorForEmgAttendShort()
		{
			this(SortOrder.ASCENDING);
		}
		
		public ArrivalDateComparatorForEmgAttendShort(SortOrder order)
		{
			if (order == SortOrder.DESCENDING)
				direction = -1;
			
		}
		public int compare(EmergencyAttendanceShortVo ob1, EmergencyAttendanceShortVo ob2) 
		{
			DateTime date1 = null;
			DateTime date2 = null;
			if(ob1 instanceof EmergencyAttendanceShortVo )
			{
				EmergencyAttendanceShortVo ps1 = (EmergencyAttendanceShortVo)ob1;
				date1 = ps1.getArrivalDateTime();
			}
			if(ob2 instanceof EmergencyAttendanceShortVo)
			{
				EmergencyAttendanceShortVo ps2 = (EmergencyAttendanceShortVo)ob2;
				date2 = ps2.getArrivalDateTime();
			}
			if(date1 != null )
				return  date1.compareTo(date2)*direction;
			if(date2 != null)
				return (-1)*direction;
			
			return 0;
		}
	
	}
	
	//-----------
	
	private LocationLiteVo getLoc()
	{
		LocationLiteVo loc = null;
		LocSiteLiteVo locsite = null;
		if(domain.getCurrentLocation() instanceof LocationLiteVo)
		{
			loc = (LocationLiteVo) domain.getCurrentLocation();
			
		}
		else if(domain.getCurrentLocation() instanceof LocSiteLiteVo)
		{
			locsite = (LocSiteLiteVo) domain.getCurrentLocation();
			if(locsite != null)
			{
				loc = new LocationLiteVo(locsite.getID_Location(),locsite.getVersion_Location());
				LocSiteShortVo locShortVo = domain.getTypeOfLocSite(loc);
				loc.setType(locShortVo.getType());
				
			}
			
		}
		if( loc != null && loc.getTypeIsNotNull() && loc.getType().equals(LocationType.ANE))
			return loc;
		else
			return null;
				
	}

	@Override
	//WDEV-16673
	protected void onlyrEmergencyAttendanceTabChanged(LayerBridge tab)
	{
		if (FormMode.VIEW.equals(form.getMode()))
		{
			grdPreviousHistoryRow selectedRow = form.grdPreviousHistory().getSelectedRow();
			
			if (selectedRow != null && selectedRow.getValue() != null && selectedRow.getValue() instanceof EmergencyAttendanceShortVo)
			{
				form.getGlobalContext().Emergency.setCurrentEmergencyAttendance(domain.getAttendanceDetails((EmergencyAttendanceShortVo) selectedRow.getValue()));
				form.getGlobalContext().Core.setCurrentCareContext(form.getGlobalContext().Emergency.getCurrentEmergencyAttendance() != null ? form.getGlobalContext().Emergency.getCurrentEmergencyAttendance().getCareContext() : null);
				
				AttendanceDetailsVo selectedAttendance = form.getGlobalContext().Emergency.getCurrentEmergencyAttendance();
				CareContextShortVo careContext = form.getGlobalContext().Core.getCurrentCareContext();
				EpisodeofCareLiteVo episodeOfCare = careContext.getEpisodeOfCare();
				PatientShort patient = form.getGlobalContext().Core.getPatientShort();
				
				if (tab.equals(form.lyrEmergencyAttendance().tabAttDet()))
				{
					form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().setValue(selectedAttendance);
				}
				else if (tab.equals(form.lyrEmergencyAttendance().tabChart()) && selectedRow.getValue() instanceof EmergencyAttendanceShortVo)
				{
					form.lyrEmergencyAttendance().tabChart().ccChatRequested().initialize(selectedAttendance, patient, careContext, episodeOfCare);
					form.lyrEmergencyAttendance().tabChart().ccChatRequested().setValue(domain.getChartRequestedByEmergencyAttendance(selectedAttendance));
					
				}
				else if (tab.equals(form.lyrEmergencyAttendance().tabInvoices()) && selectedRow.getValue() instanceof EmergencyAttendanceShortVo)
				{
					form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().initialize(selectedAttendance, patient, episodeOfCare, careContext);
					form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().setValue(domain.getAttendanceBillingByEmergencyAttendance(selectedAttendance));
					
				}
				else if( tab.equals(form.lyrEmergencyAttendance().tabInsuranceDetails()) && selectedRow.getValue() instanceof EmergencyAttendanceShortVo)						//wdev-19015
				{
					form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().initialize(selectedAttendance, patient, episodeOfCare, careContext);
					form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().setValue(domain.getEmergencyAttendanceNonInsuranceHealthCoverVo(selectedAttendance));
				}
				
			}
			else if (selectedRow==null)
			{
				if (tab.equals(form.lyrEmergencyAttendance().tabAttDet()))
				{
					form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().setValue(null);
				}
				else if (tab.equals(form.lyrEmergencyAttendance().tabChart()))
				{
					form.lyrEmergencyAttendance().tabChart().ccChatRequested().initialize(null, null, null, null);
					form.lyrEmergencyAttendance().tabChart().ccChatRequested().setValue(null);
					
				}
				else if (tab.equals(form.lyrEmergencyAttendance().tabInvoices())) 
				{
					form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().initialize(null, null, null, null);
					form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().setValue(null);
				}
				else if( tab.equals(form.lyrEmergencyAttendance().tabInsuranceDetails()))						
				{
					form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().initialize(null, null, null, null);
					form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().setValue(null);
				}
			}
		}
		updateControlState();	
	}

	@Override
	//WDEV-16673
	protected void onCcAttendanceDetailsValueChanged() throws PresentationLogicException
	{
		if (EmergencyAttendanceEvent.SAVE.equals(form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().getSelectedEvent()))//WDEV-22801
		{
			form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().resetSelectedEvent();
			open();
			return;
		}
		else if (EmergencyAttendanceEvent.CANCEL.equals(form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().getSelectedEvent()))
		{
			form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().resetSelectedEvent();
			open();
			form.getLocalContext().setIsNewAttendanceInstance(null);
			return;
		}
		
		if (EmergencyAttendanceEvent.NEW.equals(form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().getSelectedEvent()))
		{
			form.grdPreviousHistory().setValue(null);
			form.getLocalContext().setIsNewAttendanceInstance(true);//WDEV-22801
		}
		
		//WDEV-22801
		if (!ConfigFlag.UI.SVUH_MANDATORY_DEMOGRAPHIC_ATTRIBUTES.getValue() && EmergencyAttendanceEvent.CLOSE_DIALOG.equals(form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().getSelectedEvent())  && Boolean.TRUE.equals(form.getLocalContext().getIsNewAttendanceInstance())) //WDEV-22801 WDEV-22956
		{
			if (form.lyrEmergencyAttendance().tabInvoices().isHeaderVisible())
			{
				form.lyrEmergencyAttendance().showtabInvoices();
				form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().newInstance(false); //WDEV-22956
			}
			else if (form.lyrEmergencyAttendance().tabChart().isHeaderVisible())
			{
				form.lyrEmergencyAttendance().showtabChart();
				form.lyrEmergencyAttendance().tabChart().ccChatRequested().newInstance(false);//WDEV-22956
			}
			else if (form.lyrEmergencyAttendance().tabInsuranceDetails().isHeaderVisible())
			{
				form.lyrEmergencyAttendance().showtabInsuranceDetails();
				form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().newInstance(false); //WDEV-22956
			}
			else //WDEV-22901
			{
				form.getLocalContext().setIsNewAttendanceInstance(null);
			}
			
			form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().resetSelectedEvent();
			return;
		}
		
		//WDEV-22956
		if (EmergencyAttendanceEvent.NEXT.equals(form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().getSelectedEvent())  && Boolean.TRUE.equals(form.getLocalContext().getIsNewAttendanceInstance())) //WDEV-22801
		{
			if (form.lyrEmergencyAttendance().tabInvoices().isHeaderVisible())
			{
				form.lyrEmergencyAttendance().showtabInvoices();
				form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().newInstance(true); //WDEV-22956
			}
			else if (form.lyrEmergencyAttendance().tabChart().isHeaderVisible())
			{
				form.lyrEmergencyAttendance().showtabChart();
				form.lyrEmergencyAttendance().tabChart().ccChatRequested().newInstance(true); //WDEV-22956
			}
			else if (form.lyrEmergencyAttendance().tabInsuranceDetails().isHeaderVisible())
			{
				form.lyrEmergencyAttendance().showtabInsuranceDetails();
				form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().newInstance(true); //WDEV-22956
			}
			else
			{
				form.getLocalContext().setIsNewAttendanceInstance(null);
			}
			
			//form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().resetSelectedEvent();
			return;
		}
		
		form.lyrEmergencyAttendance().showtabAttDet();
		form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().resetSelectedEvent();
		FormMode attDetMode = form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().getMode();	
		form.setMode(attDetMode);
	}

	@Override
	//WDEV-16673
	protected void onCcChatRequestedValueChanged() throws PresentationLogicException
	{
		if (EmergencyAttendanceEvent.SAVE.equals(form.lyrEmergencyAttendance().tabChart().ccChatRequested().getSelectedEvent()))  //WDEV-22801
		{
			form.lyrEmergencyAttendance().tabChart().ccChatRequested().resetSelectedEvent();
			
			if (!form.lyrEmergencyAttendance().tabInsuranceDetails().isHeaderVisible()) //WDEV-22901
			{
				form.getLocalContext().setIsNewAttendanceInstance(null); 
			}
			
			//WDEV-22801
			if (Boolean.TRUE.equals(form.getLocalContext().getIsNewAttendanceInstance()))
			{
				if (form.lyrEmergencyAttendance().tabInsuranceDetails().isHeaderVisible())
				{
					form.lyrEmergencyAttendance().showtabInsuranceDetails();
					form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().newInstance(false); //WDEV-22956
				}
			}
			else
			{	
				open();
			}
			return;
		}
		else if (EmergencyAttendanceEvent.CANCEL.equals(form.lyrEmergencyAttendance().tabChart().ccChatRequested().getSelectedEvent())) //WDEV-22801
		{
			form.lyrEmergencyAttendance().tabChart().ccChatRequested().resetSelectedEvent();
			open();
			form.getLocalContext().setIsNewAttendanceInstance(null);
			return;
		}
		
		//WDEV-22956
		if (EmergencyAttendanceEvent.NEXT.equals(form.lyrEmergencyAttendance().tabChart().ccChatRequested().getSelectedEvent()) && form.lyrEmergencyAttendance().tabInsuranceDetails().isHeaderVisible())
		{
			form.lyrEmergencyAttendance().showtabInsuranceDetails();
			form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().newInstance(true); 
		}
		
		
		if (EmergencyAttendanceEvent.FINISH_SAVE.equals(form.lyrEmergencyAttendance().tabChart().ccChatRequested().getSelectedEvent()))  
		{
			form.lyrEmergencyAttendance().tabChart().ccChatRequested().resetSelectedEvent();
			
			EmergencyAttendanceBillingVo invoiceBilling = null;
			if (form.lyrEmergencyAttendance().tabInvoices().isHeaderVisible())
			{
				invoiceBilling = form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().getValue();
			}
			
			ChartRequestedVo chartRequested = form.lyrEmergencyAttendance().tabChart().ccChatRequested().getValue();
			
			form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().saveAttendance(invoiceBilling, chartRequested, null);
		}
		
		form.lyrEmergencyAttendance().tabChart().ccChatRequested().resetSelectedEvent();
		FormMode chartReqMode = form.lyrEmergencyAttendance().tabChart().ccChatRequested().getMode();	
		form.setMode(chartReqMode);
	}

	@Override
	//WDEV-16673
	protected void onCcInvoicesBillingValueChanged() throws PresentationLogicException
	{
		if (EmergencyAttendanceEvent.SAVE.equals(form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().getSelectedEvent())) //WDEV-22801
		{
			form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().resetSelectedEvent();
			
			if (!form.lyrEmergencyAttendance().tabChart().isHeaderVisible() && !form.lyrEmergencyAttendance().tabInsuranceDetails().isHeaderVisible() ) //WDEV-22901
			{
				form.getLocalContext().setIsNewAttendanceInstance(null); 
			}
			
			//WDEV-22801
			if (Boolean.TRUE.equals(form.getLocalContext().getIsNewAttendanceInstance())) 
			{
				if (form.lyrEmergencyAttendance().tabChart().isHeaderVisible())
				{
					form.lyrEmergencyAttendance().showtabChart();
					form.lyrEmergencyAttendance().tabChart().ccChatRequested().newInstance(false); //WDEV-22956 
				}
				else if (form.lyrEmergencyAttendance().tabInsuranceDetails().isHeaderVisible())
				{
					form.lyrEmergencyAttendance().showtabInsuranceDetails();
					form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().newInstance(false); //WDEV-22956
				}
			}
			else
			{	
				open();
			}
			
			return;
		}
		else if (EmergencyAttendanceEvent.CANCEL.equals(form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().getSelectedEvent())) //WDEV-22801
		{
			form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().resetSelectedEvent();
			open();
			form.getLocalContext().setIsNewAttendanceInstance(null);
			return;
		}
		
		//WDEV-22956
		if (EmergencyAttendanceEvent.NEXT.equals(form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().getSelectedEvent()) && Boolean.TRUE.equals(form.getLocalContext().getIsNewAttendanceInstance())) 
		{
			if (form.lyrEmergencyAttendance().tabChart().isHeaderVisible())
			{
				form.lyrEmergencyAttendance().showtabChart();
				form.lyrEmergencyAttendance().tabChart().ccChatRequested().newInstance(true); 
			}
			else if (form.lyrEmergencyAttendance().tabInsuranceDetails().isHeaderVisible())
			{
				form.lyrEmergencyAttendance().showtabInsuranceDetails();
				form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().newInstance(true); 
			}
		}
		
		
		if (EmergencyAttendanceEvent.FINISH_SAVE.equals(form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().getSelectedEvent()))  
		{
			form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().resetSelectedEvent();
			
			EmergencyAttendanceBillingVo invoiceBilling = form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().getValue();
			
			form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().saveAttendance(invoiceBilling, null, null);
		}
		
		form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().resetSelectedEvent();
		FormMode invoiceBillingMode = form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().getMode();	
		form.setMode(invoiceBillingMode);
	}

	//wdev-19015
	protected void onCcInsuranceDetailsValueChanged() throws PresentationLogicException
	{
		if( EmergencyAttendanceEvent.SAVE.equals(form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().getSelectedEvent()) || EmergencyAttendanceEvent.CANCEL.equals(form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().getSelectedEvent()))
		{
			form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().resetSelectedEvent();
			open();
			form.getLocalContext().setIsNewAttendanceInstance(null); //WDEV-22801
			return;
		}
		
		//WDEV-22956
		if (EmergencyAttendanceEvent.FINISH_SAVE.equals(form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().getSelectedEvent())) 
		{
			form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().resetSelectedEvent();
			
			EmergencyAttendanceBillingVo invoiceBilling = null;
			if (form.lyrEmergencyAttendance().tabInvoices().isHeaderVisible())
			{
				invoiceBilling = form.lyrEmergencyAttendance().tabInvoices().ccInvoicesBilling().getValue();
			}
			
			ChartRequestedVo chartRequested = null;
			if (form.lyrEmergencyAttendance().tabChart().isHeaderVisible())
			{
				chartRequested = form.lyrEmergencyAttendance().tabChart().ccChatRequested().getValue();
			}
			
			EmergencyAttendanceNonInsuranceHealthCoverVo insuranceDetails = form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().getValue();
			
			form.lyrEmergencyAttendance().tabAttDet().ccAttendanceDetails().saveAttendance(invoiceBilling, chartRequested, insuranceDetails);
		}
		
		form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().resetSelectedEvent();
		FormMode insurancedetailsmode = form.lyrEmergencyAttendance().tabInsuranceDetails().ccInsuranceDetails().getMode();	
		form.setMode(insurancedetailsmode);
		
	}
	//wdev-19040
	protected void onMessageBoxClosed(int messageBoxId, DialogResult result) throws PresentationLogicException
	{
		if( form.getLocalContext().getCanceAttendanceMessageBox() != null && form.getLocalContext().getCanceAttendanceMessageBox().equals(messageBoxId))
		{
			if( DialogResult.YES.equals(result))
				engine.open(form.getForms().Core.RieConfirmationDialog);
		}
		
	}
	//wdev-19040
	protected void onFormDialogClosed(FormName formName, DialogResult result) throws PresentationLogicException
	{
		if( formName.equals(form.getForms().Core.RieConfirmationDialog) && DialogResult.OK.equals(result))
		{
			doRIE();
			form.getGlobalContext().Emergency.setCurrentEmergencyAttendance(null);
			form.grdPreviousHistory().getRows().clear();
			//wdev-19040
			clearlabels();
			initialize();		
			if(	getLoc() == null)
			{
				engine.showMessage(" The current location should be of type Emergency. ");
				
			}

			open();	
			form.getLocalContext().setOpenFirstTime(Boolean.TRUE);
			
			//WDEV-22801
			form.getLocalContext().setIsNewAttendanceInstance(true);
			form.getLocalContext().setSelectedRecord(null);
		}
		
	}
	//wdev-19040
	private void clearlabels()
	{
		form.lbllblCountOfPreviousAttendance2().setValue("0");
		form.lblAttendingAsAdultPaediatric().setValue("");
		form.lblDischargeWarning().setValue("");
		form.lbl24h().setValue("");
		
	}
	//wdev-19040
	private void doRIE()
	{
		
		grdPreviousHistoryRow selectedRow = form.grdPreviousHistory().getSelectedRow();
		if( selectedRow != null && selectedRow.getValue() != null)
		{
			if( selectedRow.getValue() instanceof EmergencyAttendanceShortVo)
			{
						
        		try
        		{
        			TrackingSendToAreaVo tempTracking = domain.getTrackingSendToAreaVoByAttendanceDetails((EmergencyAttendanceShortVo) selectedRow.getValue());
        			if( form.getGlobalContext().Emergency.getSelectedEmergencyEpisodeIsNotNull() && form.getGlobalContext().Emergency.getSelectedEmergencyEpisode().getEmergencyAttendancesIsNotNull() && form.getGlobalContext().Emergency.getSelectedEmergencyEpisode().getEmergencyAttendances().size() > 1 )
        			{
        				
        				domain.rieAttendanceDetails((EmergencyAttendanceShortVo) selectedRow.getValue(), form.getForms().Emergency.AttendanceDetails, form.getGlobalContext().Core.getPatientShort() != null ? form.getGlobalContext().Core.getPatientShort().getID_Patient() : null, null,
    					form.getGlobalContext().Core.getCurrentCareContextIsNotNull()?form.getGlobalContext().Core.getCurrentCareContext().getID_CareContext():null,
    					form.getGlobalContext().Core.getRieMessage(),form.getGlobalContext().Core.getCurrentCareContext(),null,null,null,tempTracking);
     	
        			}
        			else if(form.getGlobalContext().Emergency.getSelectedEmergencyEpisodeIsNotNull() && form.getGlobalContext().Emergency.getSelectedEmergencyEpisode().getEmergencyAttendancesIsNotNull() && form.getGlobalContext().Emergency.getSelectedEmergencyEpisode().getEmergencyAttendances().size() == 1 )
        			{
        				CareSpellVo tempCareSpellVo = new CareSpellVo(form.getGlobalContext().Core.getCurrentCareContext().getEpisodeOfCare().getCareSpell().getID_CareSpell(), form.getGlobalContext().Core.getCurrentCareContext().getEpisodeOfCare().getCareSpell().getVersion_CareSpell());
        				domain.rieAttendanceDetails((EmergencyAttendanceShortVo) selectedRow.getValue(), form.getForms().Emergency.AttendanceDetails, form.getGlobalContext().Core.getPatientShort() != null ? form.getGlobalContext().Core.getPatientShort().getID_Patient() : null, null,
        				form.getGlobalContext().Core.getCurrentCareContextIsNotNull()?form.getGlobalContext().Core.getCurrentCareContext().getID_CareContext():null,
        				form.getGlobalContext().Core.getRieMessage(),form.getGlobalContext().Core.getCurrentCareContext(),form.getGlobalContext().Core.getCurrentCareContext().getEpisodeOfCare(),tempCareSpellVo,form.getGlobalContext().Emergency.getSelectedEmergencyEpisode(),tempTracking);
        				
        			}
        		}
        		catch (StaleObjectException e)
        		{
        			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
        			return;
        		}
			}
		}
	}

}
