//#############################################################################
//#                                                                           #
//#  Copyright (C) <2014>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Catalin Tomozei using IMS Development Environment (version 1.53 build 2656.22861)
// Copyright (C) 1995-2007 IMS MAXIMS plc. All rights reserved.

package ims.clinicaladmin.forms.tumourcategorygroupsites;

import ims.assessment.vo.UserAssessmentLiteVo;
import ims.assessment.vo.UserAssessmentLiteVoCollection;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabHistologyGradeContainer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabHistologyTypeContainer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabHistologyTypeContainer.grdHistologyRow;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabPagTaxonomyContainer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabSerumMarkerContainer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabSerumMarkerContainer.grdSerumMarkersRow;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabSpecialtiesContainer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTCategoryContainer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTGroupContainer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTGroupContainer.lyrGroupDetailsLayer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTGroupContainer.lyrGroupDetailsLayer.tabPageGleasonContainer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTGroupContainer.lyrGroupDetailsLayer.tabPageGleasonContainer.grdGleasonRow;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTGroupContainer.lyrGroupDetailsLayer.tabPagePSAContainer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTGroupContainer.lyrGroupDetailsLayer.tabPagePSAContainer.grdPSARow;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTGroupContainer.lyrGroupDetailsLayer.tabPageRiskCategoryContainer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTGroupContainer.lyrGroupDetailsLayer.tabPageRiskCategoryContainer.grdRiskCategoryRow;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTGroupContainer.lyrGroupDetailsLayer.tabPageTumourLocationContainer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTGroupContainer.lyrGroupDetailsLayer.tabPageTumourLocationContainer.grdPrognosticLocationRow;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTGroupContainer.lyrGroupDetailsLayer.tabPrognosticGroupingContainer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTNMContainer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTNMContainer.GroupTNMValuesEnumeration;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTNMContainer.lyrTNMLayer.tabTNMMappingsContainer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTNMContainer.lyrTNMLayer.tabTNMValuesContainer;
import ims.clinicaladmin.forms.tumourcategorygroupsites.GenForm.lyrConfigLayer.tabTSiteContainer;
import ims.clinicaladmin.vo.GleasonConfigLiteVo;
import ims.clinicaladmin.vo.HistopathologicGradeVo;
import ims.clinicaladmin.vo.HistopathologicGradeVoCollection;
import ims.clinicaladmin.vo.PSAConfigVo;
import ims.clinicaladmin.vo.PrognosticGroupingCongfigVo;
import ims.clinicaladmin.vo.PrognosticRiskConfigVo;
import ims.clinicaladmin.vo.StagingClassificationVo;
import ims.clinicaladmin.vo.StagingClassificationVoCollection;
import ims.clinicaladmin.vo.TNMStagingClassificationVersionLiteVo;
import ims.clinicaladmin.vo.TNMStagingClassificationVersionLiteVoCollection;
import ims.clinicaladmin.vo.TumourCategoryListVo;
import ims.clinicaladmin.vo.TumourCategoryVersionGroupsLiteVo;
import ims.clinicaladmin.vo.TumourCategoryVo;
import ims.clinicaladmin.vo.TumourGroupHistologyVo;
import ims.clinicaladmin.vo.TumourGroupHistologyVoCollection;
import ims.clinicaladmin.vo.TumourGroupHistopathologyGradeVo;
import ims.clinicaladmin.vo.TumourGroupHistopathologyGradeVoCollection;
import ims.clinicaladmin.vo.TumourGroupListVo;
import ims.clinicaladmin.vo.TumourGroupSiteTNMValueVo;
import ims.clinicaladmin.vo.TumourGroupSiteTNMValueVoCollection;
import ims.clinicaladmin.vo.TumourGroupVo;
import ims.clinicaladmin.vo.TumourHistologyLiteVo;
import ims.clinicaladmin.vo.TumourSerumMarkersLiteVo;
import ims.clinicaladmin.vo.TumourSerumMarkersLiteVoCollection;
import ims.clinicaladmin.vo.TumourSerumMarkersVo;
import ims.clinicaladmin.vo.TumourSiteListVo;
import ims.clinicaladmin.vo.TumourSiteListVoCollection;
import ims.clinicaladmin.vo.TumourSiteVo;
import ims.configuration.gen.ConfigFlag;
import ims.core.vo.TaxonomyMap;
import ims.core.vo.TaxonomyMapCollection;
import ims.core.vo.lookups.Specialty;
import ims.core.vo.lookups.SpecialtyCollection;
import ims.core.vo.lookups.YesNo;
import ims.core.vo.lookups.YesNoCollection;
import ims.domain.exceptions.DomainInterfaceException;
import ims.domain.exceptions.ForeignKeyViolationException;
import ims.domain.exceptions.StaleObjectException;
import ims.domain.exceptions.UniqueKeyViolationException;
import ims.domain.exceptions.UnqViolationUncheckedException;
import ims.framework.Control;
import ims.framework.FormName;
import ims.framework.LayerBridge;
import ims.framework.MessageButtons;
import ims.framework.MessageIcon;
import ims.framework.cn.controls.DynamicGrid;
import ims.framework.cn.controls.Grid;
import ims.framework.cn.controls.TreeView;
import ims.framework.controls.DynamicGridCell;
import ims.framework.controls.DynamicGridColumn;
import ims.framework.controls.DynamicGridRow;
import ims.framework.controls.Label;
import ims.framework.controls.TreeNode;
import ims.framework.enumerations.DialogResult;
import ims.framework.enumerations.DynamicCellType;
import ims.framework.enumerations.FormMode;
import ims.framework.enumerations.UILayoutState;
import ims.framework.exceptions.CodingRuntimeException;
import ims.framework.exceptions.PresentationLogicException;
import ims.framework.utils.Color;
import ims.oncology.configuration.vo.TumourGroupRefVo;
import ims.oncology.configuration.vo.TumourSiteRefVo;
import ims.oncology.vo.PrognosticLocationConfigVo;
import ims.oncology.vo.TumourGroupClassificationVo;
import ims.oncology.vo.TumourGroupClassificationVoCollection;
import ims.oncology.vo.TumourGroupDifferentationVo;
import ims.oncology.vo.TumourGroupSpecialtyVo;
import ims.oncology.vo.TumourGroupSpecialtyVoCollection;
import ims.oncology.vo.enums.TumourCategory;
import ims.oncology.vo.enums.TumourCategoryGroupSiteSelectedTab;
import ims.oncology.vo.lookups.LookupHelper;
import ims.oncology.vo.lookups.TNMClinicalpathological;
import ims.oncology.vo.lookups.TNMClinicalpathologicalCollection;
import ims.oncology.vo.lookups.TNMType;
import ims.oncology.vo.lookups.TNMTypeCollection;
import ims.oncology.vo.lookups.TumourOverallStageCollection;
import ims.vo.ValueObject;

import java.util.ArrayList;

public class Logic extends BaseLogic
{
	private static final long serialVersionUID = 1L;

	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//	Region constants
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------
	
	private static final String ERR_HAVE_TNM = " supports TNM Staging. Cannot deactivate supports TNM Staging for this group!";
	private static final String INVALID_RECORD = "Invalid Record";
	private static final String WARNING = "Warning";
	private static final String UNIQ_ERR_MSG = "Taxonomy Map must be unique!";

	private static final Integer COLTYPE = new Integer(-1);
	private static final Integer COLTNM = new Integer(-2);
	private static final Integer COLCPB = new Integer(-3);
	private static final Integer COLTNMDESCRIPTION = new Integer(-4);
	private static final Integer COLACTIVE = new Integer(-5);
	private static final Integer COLDIFF = new Integer(-6);
	private static final Integer COLGRADE = new Integer(-7);


	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//	Event handlers region
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------

	protected void onFormOpen(Object[] args) throws ims.framework.exceptions.PresentationLogicException
	{
		initialize();
		open();
	}

	@Override
	protected void onFormModeChanged()
	{
		if (FormMode.EDIT.equals(form.getMode()))
		{
			form.getLocalContext().setRefreshHistologicGradeRecords(false);
			form.getLocalContext().setRefreshHistologyTypeRecords(false);
			form.getLocalContext().setRefreshSerumMarkerRecords(false);
			form.getLocalContext().setRefreshSpecialtyRecords(false);

			form.getLocalContext().setRefreshTumourLocationRecords(false);
			form.getLocalContext().setRefreshRiskCategoryRecords(false);
			form.getLocalContext().setRefreshPSARecords(false);
			form.getLocalContext().setRefreshGleasonRecords(false);
		}
		
		if (FormMode.VIEW.equals(form.getMode()))
		{
			form.getLocalContext().setRefreshTumourLocationTab(true);
			form.getLocalContext().setRefreshRiskCategoryTab(true);
			form.getLocalContext().setRefreshPSATab(true);
			form.getLocalContext().setRefreshGleasonTab(true);
		}
		
		if (form.getMode().equals(FormMode.EDIT))
		{
			setCustomTaxonomyMode(FormMode.EDIT);
			enableTaxonomy(Boolean.TRUE);
			enableTNMContextMenu(Boolean.TRUE);

			enableClassificationContextMenu(Boolean.TRUE);
			form.customTree().setComponentMode(FormMode.EDIT);

			form.lyrConfig().tabTCategory().setEnabled(true);
			form.lyrConfig().tabTGroup().setEnabled(true);
			form.lyrConfig().tabTSite().setEnabled(true);
			form.lyrConfig().tabTNM().setEnabled(true);
			form.lyrConfig().tabHistologyType().setEnabled(true);
			form.lyrConfig().tabSerumMarker().setEnabled(true);
		}
		else
		{
			form.customTree().setComponentMode(FormMode.VIEW);
			setCustomTaxonomyMode(FormMode.VIEW);
			enableTaxonomy(Boolean.FALSE);
			enableTNMContextMenu(Boolean.FALSE);

			enableClassificationContextMenu(Boolean.FALSE);

			enableHistologyContextMenu(Boolean.FALSE);

			form.lyrConfig().tabTCategory().customMappings().setComponentMode(FormMode.VIEW);
		}
		updateGenericContextMenu();
		resetDataLoadedBooleans();
		
		updateControlsState();
	}

	@Override
	protected void onFormDialogClosed(FormName formName, DialogResult result) throws PresentationLogicException
	{
		if ((formName.equals(form.getForms().ClinicalAdmin.HotlistDialog)) && (result.equals(DialogResult.OK)))
		{
			populateSpecialtyTree(form.getGlobalContext().Core.getSpecialties());
		}
		else if ((formName.equals(form.getForms().ClinicalAdmin.TumourOtherClassification)) && (result.equals(DialogResult.OK)))
		{
			form.getLocalContext().setbTumourStagingClassificationVoLoaded(true);

			populateClassificationTree(form.getGlobalContext().ClinicalAdmin.getTumourGroupOtherClassification());
		}
		else if ((formName.equals(form.getForms().Core.TaxonomySearch)) && (result.equals(DialogResult.OK)))
		{
			if (form.getGlobalContext().Core.getTaxonomyMapIsNotNull())
			{
				TaxonomyMap voTaxonomyMap = form.getGlobalContext().Core.getTaxonomyMap();
				TaxonomyMapCollection voCollTaxonomy = new TaxonomyMapCollection();

				if (form.getLocalContext().getCurrentSelectedTabIsNotNull())
				{
					if (form.getLocalContext().getCurrentSelectedTab().equals(TumourCategoryGroupSiteSelectedTab.SERUM) || form.getLocalContext().getCurrentSelectedTab().equals(TumourCategoryGroupSiteSelectedTab.SERUMVALUES))
					{
						grdSerumMarkersRow row = form.lyrConfig().tabSerumMarker().grdSerumMarkers().getRows().newRow();
						row.setColValue(voTaxonomyMap.getTaxonomyCode());
						row.setColDescription(voTaxonomyMap.getDescription());

						TumourSerumMarkersVo voSerumMarkers = new TumourSerumMarkersVo();
						voSerumMarkers = new TumourSerumMarkersVo();
						voSerumMarkers.setSerumMarkerValue(voTaxonomyMap.getTaxonomyCode());

						voCollTaxonomy.add(voTaxonomyMap);
						voSerumMarkers.setTaxonomyMap(voCollTaxonomy);

						row.setValue(voSerumMarkers);

						form.getLocalContext().setSelectedSerumRecord(voSerumMarkers);
						/*
						 * form.lyrConfig().tabSerumMarker().lyrSereumMarkers().tabSerumMarkers().grdSerumMarkers().setValue(voSerumMarkers); onGrdSerumMarkersSelectionChanged(); voCollTaxonomy.add(voTaxonomyMap); if (form.lyrConfig().tabSerumMarker().lyrSereumMarkers().tabMappings().customSerumMarkerMappings().getValue() != null) { for (int i = 0; i <form.lyrConfig().tabSerumMarker().lyrSereumMarkers().tabMappings().customSerumMarkerMappings().getValue().size(); i++) { voCollTaxonomy.add(form.lyrConfig().tabSerumMarker().lyrSereumMarkers().tabMappings().customSerumMarkerMappings().getValue().get(i)); } }
						 */
						onGrdSerumMarkersSelectionChanged();
					}
					/*
					 * else if (form.getLocalContext().getCurrentSelectedTab().equals(TumourCategoryGroupSiteSelectedTab.GROUP)) { voCollTaxonomy.add(voTaxonomyMap); if (form.lyrConfig().tabTGroup().lyrGroupDetails().tabTaxonomy().customGrupMappings().getValue() != null) { for (int i = 0; i <form.lyrConfig().tabTGroup().lyrGroupDetails().tabTaxonomy().customGrupMappings().getValue().size(); i++) { voCollTaxonomy.add(form.lyrConfig().tabTGroup().lyrGroupDetails().tabTaxonomy().customGrupMappings().getValue().get(i)); } } form.lyrConfig().tabTGroup().lyrGroupDetails().tabTaxonomy().customGrupMappings().setValue(voCollTaxonomy); } else if (form.getLocalContext().getCurrentSelectedTab().equals(TumourCategoryGroupSiteSelectedTab.CATEGORY)) { voCollTaxonomy.add(voTaxonomyMap); if (form.lyrConfig().tabTCategory().customMappings().getValue() != null) { for (int i = 0; i <form.lyrConfig().tabTCategory().customMappings().getValue().size(); i++) {
					 * voCollTaxonomy.add(form.lyrConfig().tabTCategory().customMappings().getValue().get(i)); } } form.lyrConfig().tabTCategory().customMappings().setValue(voCollTaxonomy); } else if (form.getLocalContext().getCurrentSelectedTab().equals(TumourCategoryGroupSiteSelectedTab.SITE)) { voCollTaxonomy.add(voTaxonomyMap); if (form.lyrConfig().tabTSite().customSiteMappings().getValue() != null) { for (int i = 0; i <form.lyrConfig().tabTSite().customSiteMappings().getValue().size(); i++) { voCollTaxonomy.add(form.lyrConfig().tabTSite().customSiteMappings().getValue().get(i)); } } form.lyrConfig().tabTSite().customSiteMappings().setValue(voCollTaxonomy); }
					 */
				}
			}
		}
		//  WDEV-11684
		else if (formName.equals(form.getForms().ClinicalAdmin.SelectTumourHistology) && result.equals(DialogResult.OK))
		{
			addHistology(form.getGlobalContext().ClinicalAdmin.getTumourHistology());
			
			updateHistologyContextMenu();
		}
		else if (formName.equals(form.getForms().ClinicalAdmin.SelectHistopathologicGrade) && result.equals(DialogResult.OK))
		{
			addHistologyGrade(form.getGlobalContext().ClinicalAdmin.getTumourDifferentiaion());
			
			updateHistologyGradeContextMenu();
		}
		else if (formName.equals(form.getForms().ClinicalAdmin.SelectSerumMarker) && result.equals(DialogResult.OK))
		{
			addSerumMarker(form.getGlobalContext().ClinicalAdmin.getTumourSerumMarker());
			
			updateSerumContextMenu();
		}
		else if (formName.equals(form.getForms().ClinicalAdmin.SelectPrognosticLocation) && result.equals(DialogResult.OK))
		{
			addPrognosticLocation(form.getGlobalContext().ClinicalAdmin.getSelectedPrognosticLocation());
			updatePrognosticsContextMenu();
		}
		else if (formName.equals(form.getForms().ClinicalAdmin.SelectPrognosticRiskAssessment) && result.equals(DialogResult.OK))
		{
			addPrognosticRisk(form.getGlobalContext().ClinicalAdmin.getSelectedPrognosticRiskAssessment());
			updatePrognosticsContextMenu();
		}
		else if (formName.equals(form.getForms().ClinicalAdmin.SelecPrognosticPSA) && result.equals(DialogResult.OK))
		{
			addPrognosticPSA(form.getGlobalContext().ClinicalAdmin.getSelectedPrognosticPSA());
			updatePrognosticsContextMenu();
		}
		else if (formName.equals(form.getForms().ClinicalAdmin.SelectPrognosticGleason) && result.equals(DialogResult.OK))
		{
			addPrognosticGleason(form.getGlobalContext().ClinicalAdmin.getSelectedPrognosticGleason());
			updatePrognosticsContextMenu();
		}
		else if (form.getForms().ClinicalAdmin.TumourGroupOverallStaging.equals(formName))
		{
			open();
			form.customTree().setValue(form.getLocalContext().getSelectedRecord());
		}
		else if (form.getForms().ClinicalAdmin.TumourGroupOverallPrognostic.equals(formName))
		{
			open();
			form.customTree().setValue(form.getLocalContext().getSelectedRecord());
		}
	}

	private void updatePrognosticsContextMenu()
	{
		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticGleasonADDItem().setVisible(true);
		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticGleasonREMOVEItem().setVisible(form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGleason().grdGleason().getSelectedRow() != null);

		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticPSAADDItem().setVisible(true);
		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticPSAREMOVEItem().setVisible(form.lyrConfig().tabTGroup().lyrGroupDetails().tabPagePSA().grdPSA().getSelectedRow() != null);

		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticRiskADDItem().setVisible(true);
		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticRiskREMOVEItem().setVisible(form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageRiskCategory().grdRiskCategory().getSelectedRow() != null);

		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticLocationADDItem().setVisible(true);
		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticLocationREMOVEItem().setVisible(form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageTumourLocation().grdPrognosticLocation().getSelectedRow() != null);
	}

	@Override
	protected void onCustomTreeValueChanged() throws PresentationLogicException
	{
		// WDEV-12304 - This is a workaround for old JSCN bug
		// where the expand of node tree sends a post-back (and a valueChanged event from a custom control)
		if (Boolean.TRUE.equals(form.customTree().hasEvent()))
		{
			form.getLocalContext().setRefreshHistologicGradeTab(true);
			form.getLocalContext().setRefreshHistologyTypeTab(true);
			form.getLocalContext().setRefreshSerumMarkerTab(true);
			form.getLocalContext().setRefreshSpecialtyTab(true);

			form.getLocalContext().setRefreshTumourLocationTab(true);
			form.getLocalContext().setRefreshRiskCategoryTab(true);
			form.getLocalContext().setRefreshPSATab(true);
			form.getLocalContext().setRefreshGleasonTab(true);
			
			// WDEV-12304 - Clear event from custom controls
			form.customTree().clearEvent();

			// ContextMenu selected
			if (form.customTree().getContextMenuSelected() != null)
			{
				contextMenuItemClick();
				updateControlsState();
				return;
			}
			// Nod selected
			if (form.customTree().getSelectedNod() != null)
			{
				populateTabWithSelectedNodValue(returnSelectedNod());
				updateControlsState();
				return;
			}
			// No selection
			if (form.customTree().getSelectedNod() == null && form.customTree().getContextMenuSelected() == null)
			{
				enableTabs(false, false, false, false, false, false, false, false, false, false, false, true);
				form.lyrConfig().showtabNoDetails();
				updateControlsState();
			}
		}
	}


	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//	Form presentation functions
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------

	private void initialize()
	{
		form.customTree().setContextMenuForConfiguration(Boolean.TRUE);
		
		form.getContextMenus().ClinicalAdmin.hideAllTumourGroupHistologyGradeMenuItems();
		
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().setHeaderVisible(true);
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().setVisible(true);
	}

	private void open()
	{
		form.setMode(FormMode.VIEW);
		enableTabs(false, false, false, false, false, false, false, false, false, false, false, true);
		form.lyrConfig().showtabNoDetails();
	}

	private ValueObject returnSelectedNod()
	{
		form.getLocalContext().setSelectedNode(form.customTree().getSelectedNod());
		return form.getLocalContext().getSelectedNode();
	}

	private void contextMenuItemClick()
	{
		TumourCategory menuItem = form.customTree().getContextMenuSelected();

		if (menuItem.equals(TumourCategory.NEWCATEGORY))
		{
			newCategory();
		}

		else if (menuItem.equals(TumourCategory.EDITCATEGORY))
		{
			editCategory();
		}
		
		else if (menuItem.equals(TumourCategory.NEWVERSION))
		{
			newVersion();
		}
		
		else if (menuItem.equals(TumourCategory.NEWGROUP))
		{
			newGroup();
		}

		else if (menuItem.equals(TumourCategory.EDITGROUP))
		{
			editGroup();
		}

		else if (menuItem.equals(TumourCategory.NEWSITE))
		{
			newSite();
		}

		else if (menuItem.equals(TumourCategory.EDITSITE))
		{
			editSite();
		}
		else if (menuItem.equals(TumourCategory.OVERALLSTAGING))
		{
			overallStaging();
		}
		else if (menuItem.equals(TumourCategory.OVERALLPROGNOSTIC))
		{
			overallPrognostic();
		}
	}

	private void overallPrognostic()
	{
		if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
		{
			form.getGlobalContext().ClinicalAdmin.setTumourGroup((TumourGroupVo) form.getLocalContext().getSelectedRecord());
			engine.open(form.getForms().ClinicalAdmin.TumourGroupOverallPrognostic);
		}
	}

	private void overallStaging()
	{
		if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
		{
			form.getGlobalContext().ClinicalAdmin.setTumourGroup((TumourGroupVo) form.getLocalContext().getSelectedRecord());
			engine.open(form.getForms().ClinicalAdmin.TumourGroupOverallStaging);
			return;
		}
		
		if (form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
		{
			form.getGlobalContext().ClinicalAdmin.setTumourGroup(domain.getGroup(form.getLocalContext().getParentGroup()));
			form.getGlobalContext().ClinicalAdmin.setTumourSite((TumourSiteVo) form.getLocalContext().getSelectedRecord());
			engine.open(form.getForms().ClinicalAdmin.TumourSiteOverallStaging);
			return;
		}
		
	}

	private void inactivateTabs(boolean isEnable)
	{
		if (form.lyrConfig().tabTGroup().isHeaderVisible())
		{
			if (form.lyrConfig().tabTGroup().isHeaderEnabled())
			{
				form.lyrConfig().tabTGroup().setHeaderEnabled(!isEnable);
			}
			else
			{
				form.lyrConfig().tabTGroup().setHeaderEnabled(isEnable);
			}
		}
		if (form.lyrConfig().tabTNM().isHeaderVisible())
		{
			if (form.lyrConfig().tabTNM().isHeaderEnabled())
			{
				form.lyrConfig().tabTNM().setHeaderEnabled(!isEnable);
			}
			else
			{
				form.lyrConfig().tabTNM().setHeaderEnabled(isEnable);
			}
		}
		if (form.lyrConfig().tabHistologyType().isHeaderVisible())
		{
			if (form.lyrConfig().tabHistologyType().isHeaderEnabled())
			{
				form.lyrConfig().tabHistologyType().setHeaderEnabled(!isEnable);
			}
			else
			{
				form.lyrConfig().tabHistologyType().setHeaderEnabled(isEnable);
			}
		}
		if (form.lyrConfig().tabSerumMarker().isHeaderVisible())
		{
			if (form.lyrConfig().tabSerumMarker().isHeaderEnabled())
			{
				form.lyrConfig().tabSerumMarker().setHeaderEnabled(!isEnable);
			}
			else
			{
				form.lyrConfig().tabSerumMarker().setHeaderEnabled(isEnable);
			}
		}
		if (form.lyrConfig().tabHistologyGrade().isHeaderVisible())
		{
			if (form.lyrConfig().tabHistologyGrade().isHeaderEnabled())
			{
				form.lyrConfig().tabHistologyGrade().setHeaderEnabled(!isEnable);
			}
			else
			{
				form.lyrConfig().tabHistologyGrade().setHeaderEnabled(isEnable);
			}
		}
		if (form.lyrConfig().tabSpecialties().isHeaderVisible())
		{
			if (form.lyrConfig().tabSpecialties().isHeaderEnabled())
			{
				form.lyrConfig().tabSpecialties().setHeaderEnabled(!isEnable);
			}
			else
			{
				form.lyrConfig().tabSpecialties().setHeaderEnabled(isEnable);
			}
		}
		if (form.lyrConfig().tabPagTaxonomy().isHeaderVisible())
		{
			if (form.lyrConfig().tabPagTaxonomy().isHeaderEnabled())
			{
				form.lyrConfig().tabPagTaxonomy().setHeaderEnabled(!isEnable);
			}
			else
			{
				form.lyrConfig().tabPagTaxonomy().setHeaderEnabled(isEnable);
			}
		}
	}

	private void editSite()
	{

		TumourSiteVo tumour = null;
		form.setMode(FormMode.EDIT);
		form.lyrConfig().tabTSite().txtSiteName().setEnabled(false);
		form.lyrConfig().showtabTSite();

		if (form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
		{
			tumour = (TumourSiteVo) form.getLocalContext().getSelectedRecord();
		}
		if (tumour != null)
		{
			if (tumour.getIsActive() == false && form.getLocalContext().getParentGroup().getIsActive() == false && form.getMode() == FormMode.EDIT)
			{
				form.lyrConfig().tabTSite().chkSiteActive().setEnabled(false);
			}
			else
				form.lyrConfig().tabTSite().chkSiteActive().setEnabled(true);
		}
		if (form.lyrConfig().tabTNM().isHeaderVisible())
			initializeTabTNM(true);

	}

	private void newSite()
	{

		/*
		 * checks the status of the parent
		 */
		if (form.getLocalContext().getParentGroup() != null)
		{
			if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
			{
				TumourGroupVo tumour = (TumourGroupVo) form.getLocalContext().getSelectedRecord();
				if (tumour.getIsActive() == false)
				{
					engine.showMessage("A new Site cannot be added to this Group as it is deactivated");
					return;
				}
			}
			if (form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
			{
				if (form.getLocalContext().getParentGroup().getIsActive() == false)
				{
					engine.showMessage("A new Site cannot be added to this Group as it is deactivated");
					return;
				}
			}
		}
		
		// Clear overall & prognostic local context
		form.getLocalContext().setHasOverall(Boolean.FALSE);
		form.getLocalContext().setHasPrognosticGrouping(Boolean.FALSE);
		
		// Only the site tab should be active
		enableTabs(false, false, false, true, false, true, false, false, false, false, false, false);
		form.lyrConfig().showtabTSite();
		clearTab();

		// New record - clear selected record
		form.getLocalContext().setSelectedRecord(new TumourSiteVo());

		form.getLocalContext().setOriginalRecord(null);

		form.lyrConfig().tabHistologyType().grdHistology().getRows().clear();
		form.lyrConfig().tabSerumMarker().grdSerumMarkers().getRows().clear();

		form.setMode(FormMode.EDIT);
		form.lyrConfig().tabTSite().txtSiteName().setEnabled(true);

		clearLocalContextsVariables();

		form.lyrConfig().tabTSite().customSiteMappings().initialize();
		form.lyrConfig().tabTSite().customSiteMappings().setComponentMode(form.getMode());
		form.lyrConfig().tabTSite().chkSiteSpecificTNM().setValue(false);
		form.lyrConfig().tabTSite().chkSiteSpecificHistology().setValue(false);
	}

	private void editGroup()
	{
		TumourGroupVo tumour = null;

		form.setMode(FormMode.EDIT);
		form.lyrConfig().tabTGroup().txtGroupName().setEnabled(false);
		form.lyrConfig().showtabTGroup();

		if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
		{
			tumour = (TumourGroupVo) form.getLocalContext().getSelectedRecord();

		}

		if (tumour.getIsActive() == false && form.getLocalContext().getParentCategory().getIsActive() == false && form.getMode() == FormMode.EDIT)
		{
			form.lyrConfig().tabTGroup().chkGroupActive().setEnabled(false);
		}
		else
			form.lyrConfig().tabTGroup().chkGroupActive().setEnabled(true);

		if (form.lyrConfig().tabTNM().isHeaderVisible())
			initializeTabTNM(true);

		if (tumour.getAssociatedSpecialties() != null)
		{
			try
			{
				populateEmbeddedTab(form.lyrConfig().tabSpecialties(), (TumourGroupVo) form.getLocalContext().getSelectedRecord());
			}
			catch (PresentationLogicException e)
			{

				e.printStackTrace();
			}
		}
		
		form.lyrConfig().showtabTGroup();
		form.lyrConfig().tabTGroup().lyrGroupDetails().showtabPageGroupDetails();
	}

	private void newGroup()
	{

		if (form.getLocalContext().getSelectedRecord() instanceof TumourCategoryVo)
		{
			TumourCategoryVo tumour = (TumourCategoryVo) form.getLocalContext().getSelectedRecord();
			if (tumour.getIsActive() == false)
			{
				engine.showMessage("A new Group cannot be added to this Category as it is deactivated");
				return;
			}
		}
		if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
		{
			if (form.getLocalContext().getParentCategory().getIsActive() == false)
			{
				engine.showMessage("A new Group cannot be added to this Category as it is deactivated");
				return;
			}
		}
		
		// Clear has Overall & Prognostic local context
		form.getLocalContext().setHasOverall(Boolean.FALSE);
		form.getLocalContext().setHasPrognosticGrouping(Boolean.FALSE);

		// By default TGroup and Histology Tabs should be active.
		enableTabs(false, false, true, false, true, true, true /* true */, false, true, true, true, false);
		// By default The embedded layers – Specialty ,Taxonomy and Differentation should be active
		enableEmbeddedTabs(true, false, true, true, true);

		// Initialise tabSpecialty
		form.lyrConfig().tabSpecialties().treSpecialty().clear();

		// OtherClassification
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkOtherClassifications().setValue(false);
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().clear();
		form.getLocalContext().setOtherClassificationSavedCollection(null);

		// Initialise tabTaxonomy
		form.lyrConfig().tabPagTaxonomy().customGroupMapping().setComponentMode(FormMode.EDIT);
		form.lyrConfig().tabPagTaxonomy().customGroupMapping().setValue(null);
		form.lyrConfig().tabPagTaxonomy().customGroupMapping().clear();

		// Initialize TNM tab
		initializeTabTNM(true);
		
		// Initialise tabDifferentation
		initialiseDifferentationDynamicGrid();

		// Initialise tabHistology
		form.lyrConfig().tabHistologyType().grdHistology().getRows().clear();
		form.lyrConfig().tabSerumMarker().grdSerumMarkers().getRows().clear();

		form.lyrConfig().showtabTGroup();
		clearTab();
		// New record - clear selected record
		form.getLocalContext().setSelectedRecord(new TumourGroupVo());

		clearLocalContextsVariables();

		form.getLocalContext().setOriginalRecord(null);
		form.setMode(FormMode.EDIT);
		form.lyrConfig().tabTGroup().txtGroupName().setEnabled(true);
		
		form.lyrConfig().showtabTGroup();
		form.lyrConfig().tabTGroup().lyrGroupDetails().showtabPageGroupDetails();
	}

	private void clearLocalContextsVariables()
	{
		form.getLocalContext().setSelectedHistologyCollection(null);
		form.getLocalContext().setDifferentationCollection(null);
		form.getLocalContext().setSpecialtyCollection(null);
		form.getLocalContext().setSpecialtyCollection(null);
		form.getLocalContext().setSelectedTNMRecord(null);
		form.getLocalContext().setSelectedTNMCollection(null);
		form.getLocalContext().setSelectedSerumRecord(null);
		form.getLocalContext().setSelectedSerumCollection(null);
		form.getLocalContext().setDifferentationSavedCollection(null);
		form.getLocalContext().setOtherClassificationSavedCollection(null);
		form.getLocalContext().setSpecialtiesSavedCollection(null);

		resetDataLoadedBooleans();
	}
	
	private void newVersion()
	{
		// Show only the version tab
		enableTabs(false, true, false, false, false, false, false, false, false, false, false, false);
		form.lyrConfig().showtabTVersion();
		clearTab();
		
		// New record - clear selected record
		form.getLocalContext().setSelectedRecord(null);
		form.getLocalContext().setOriginalRecord(null);
		
		form.setMode(FormMode.EDIT);

		form.lyrConfig().tabTVersion().cmbVersion().setEnabled(true);
		populateVersions(domain.listVersions((TumourCategoryListVo) form.customTree().getSelectedNod()));
	}
	
	private void editCategory()
	{
		form.setMode(FormMode.EDIT);
		form.lyrConfig().tabTCategory().txtCatName().setEnabled(false);
		form.lyrConfig().tabTCategory().customMappings().initialize();
		form.lyrConfig().tabTCategory().customMappings().setComponentMode(FormMode.EDIT);
	}

	private void newCategory()
	{
		// Only the category tab should be active
		enableTabs(true, false, false, false, false, false, false, false, false, false, false, false);
		form.lyrConfig().showtabTCategory();
		clearTab();

		// New record - clear selected record
		form.getLocalContext().setSelectedRecord(null);
		form.getLocalContext().setOriginalRecord(null);

		form.getLocalContext().setCurrentSelectedTab(TumourCategoryGroupSiteSelectedTab.CATEGORY);

		form.setMode(FormMode.EDIT);

		form.lyrConfig().tabTCategory().txtCatName().setEnabled(true);

		// Custom Taxonomy Mappings component
		form.lyrConfig().tabTCategory().customMappings().initialize();
		form.lyrConfig().tabTCategory().customMappings().setComponentMode(FormMode.EDIT);
	}

	private void clearTab()
	{
		if (form.customTree().getContextMenuSelected().equals(TumourCategory.NEWCATEGORY))
		{
			form.lyrConfig().tabTCategory().txtCatName().setValue(null);
			form.lyrConfig().tabTCategory().txtCatDescription().setValue(null);
			form.lyrConfig().tabTCategory().chkCatActive().setValue(true);
			form.lyrConfig().tabTCategory().customMappings().setValue(null);
		}
		
		if (form.customTree().getContextMenuSelected().equals(TumourCategory.NEWVERSION))
		{
			form.lyrConfig().tabTVersion().cmbVersion().clear();
			form.lyrConfig().tabTVersion().dteActiveFrom().setValue(null);
			form.lyrConfig().tabTVersion().dteActiveTo().setValue(null);
			form.lyrConfig().tabTVersion().txtDescription().setValue(null);
		}

		if (form.customTree().getContextMenuSelected().equals(TumourCategory.NEWGROUP))
		{
			form.lyrConfig().tabTGroup().txtGroupName().setValue(null);
			form.lyrConfig().tabTGroup().txtGroupDescription().setValue(null);
			form.lyrConfig().tabTGroup().chkGroupActive().setValue(true);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkHasTNM().setValue(false);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkPrognosticGrouping().setValue(false);
			form.lyrConfig().tabPagTaxonomy().customGroupMapping().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().qmbLinkedAssessment().clear();
			
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkHasTNM().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkOtherClassifications().setValue(null);

			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqHistology().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkPrognosticGrouping().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqDiff().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqSerumMarkers().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqO45().setValue(null);
			
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkUsesTValues().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkUsesNValues().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkUsesMValues().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkHistologyTypePrognosticGrouping().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkHistologicalGradePrognosticGrouping().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkGleasonPrognosticGrouping().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkPSAPrognosticGrouping().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkRiskCategoryPrognosticGrouping().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkTumourLocationPrognosticGrouping().setValue(null);
		}

		if (form.customTree().getContextMenuSelected().equals(TumourCategory.NEWSITE))
		{
			form.lyrConfig().tabTSite().txtSiteName().setValue(null);
			form.lyrConfig().tabTSite().txtSiteDescription().setValue(null);
			form.lyrConfig().tabTSite().chkSiteActive().setValue(true);
			form.lyrConfig().tabTSite().customSiteMappings().setValue(null);
		}
	}

	@Override
	protected void onBtnCancelClick() throws PresentationLogicException
	{
		reEnableTabs();

		populateTabWithSelectedNodValue(returnSelectedNod());
		if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
		{
			form.getLocalContext().setCurrentSelectedTab(TumourCategoryGroupSiteSelectedTab.GROUP);
			form.lyrConfig().showtabTGroup();
		}
		else if (form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
		{
			form.getLocalContext().setCurrentSelectedTab(TumourCategoryGroupSiteSelectedTab.SITE);
			form.lyrConfig().showtabTSite();
		}

		form.setMode(FormMode.VIEW);
	}
	
	@Override
	protected void onBtnSaveClick() throws PresentationLogicException
	{
		if (save())
		{
			open();
			form.customTree().setValue(form.getLocalContext().getSelectedRecord());
		}
	}

	private void reEnableTabs()
	{
		if (form.getLocalContext().getCurrentSelectedTab().equals(TumourCategoryGroupSiteSelectedTab.OVERALL))
		{
			if (form.lyrConfig().tabTGroup().isHeaderEnabled())
			{
				inactivateTabs(false);
			}
			else
			{
				inactivateTabs(true);
			}
		}
	}

	private boolean save()
	{
		// *********************
		// *** SAVE CATEGORY ***
		// *********************

		// Only the category tab should be active.
		// This never supports the recording of TNM/Histology/Serum Markers or overall status
		if (form.customTree().getContextMenuSelected().equals(TumourCategory.NEWCATEGORY) || form.customTree().getContextMenuSelected().equals(TumourCategory.EDITCATEGORY))
		{
			TumourCategoryVo record = populateDataFromScreenForLyrConfigTabCategory((TumourCategoryVo) form.getLocalContext().getSelectedRecord());

			String[] uiErrors = getUiErrors();
			String[] errors = record.validate(uiErrors);
			if (errors != null && errors.length > 0)
			{
				engine.showErrors(errors);
				return false;
			}
			try
			{
				record = domain.saveCategory(record);
			}
			catch (StaleObjectException e)
			{
				displayErrorMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue(), false);
				// InvasiveDeviceConfigVo updatedRecord = getAndDisplayRecord(record);
				// updateRowRecord(updatedRecord);
				return false;
			}
			catch (UniqueKeyViolationException e)
			{
				displayErrorMessage(UNIQ_ERR_MSG, false);
				return false;
			}

			form.getLocalContext().setSelectedRecord(domain.getCategoryList(record));
			form.getLocalContext().setOriginalRecord(domain.getCategoryList(record));
		}
		
		//--------------------
		//	Save Version
		//--------------------
		
		else if (TumourCategory.NEWVERSION.equals(form.customTree().getContextMenuSelected()))
		{
			return saveVersion();
		}

		// ******************
		// *** SAVE GROUP ***
		// ******************

		else if (form.customTree().getContextMenuSelected().equals(TumourCategory.NEWGROUP) || form.customTree().getContextMenuSelected().equals(TumourCategory.EDITGROUP))
		{
			return saveGroup();
		}

		// *****************
		// *** SAVE SITE ***
		// *****************

		else if (form.customTree().getContextMenuSelected().equals(TumourCategory.NEWSITE) || form.customTree().getContextMenuSelected().equals(TumourCategory.EDITSITE))
		{
			return saveSite();
		}

		return true;
	}

	/**
	 * Function used to save a new TNM classification Site
	 * If it is a new record - domain function will save it at Group level
	 */
	private boolean saveSite()
	{
		try
		{
			if (form.getLocalContext().getSelectedNode() == null)
				return false;

			TumourGroupListVo group = null;
			TumourSiteVo site = null;

			// Look for selectedNod type
			if (form.getLocalContext().getSelectedNode() instanceof TumourGroupListVo)
			{
				group = (TumourGroupListVo) form.getLocalContext().getSelectedNode();
				site = populateDataFromScreenForLyrConfigTabSite(null);
			}
			else if (form.getLocalContext().getSelectedNode() instanceof TumourSiteListVo)
			{
				group = (TumourGroupListVo) form.customTree().getParentNod();
				site = populateDataFromScreenForLyrConfigTabSite((TumourSiteVo) form.getLocalContext().getSelectedRecord());
			}

			if (group == null || site == null)
				return false;

			String[] uiErrors = getUiErrors();
			String[] errors = site.validate(uiErrors);
			errors = group.validate(errors);
			if (errors != null && errors.length > 0)
			{
				engine.showErrors(errors);
				return false;
			}
			site = domain.saveSite(site, group);

			form.getLocalContext().setSelectedRecord(site);
			form.getLocalContext().setOriginalRecord(site);

			return true;
		}
		catch (StaleObjectException e)
		{
			displayErrorMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue(), false);
			// InvasiveDeviceConfigVo updatedRecord = getAndDisplayRecord(record);
			// updateRowRecord(updatedRecord);
			return false;
		}
		catch (UniqueKeyViolationException e)
		{
			displayErrorMessage(UNIQ_ERR_MSG, false);
			return false;
		}
		catch (UnqViolationUncheckedException e)
		{
			displayErrorMessage(UNIQ_ERR_MSG, false);
			return false;
		}
	}

	/**
	 * Function used to save a new TNM classification Group
	 * If it is a new record - domain function will save it at Version level
	 */
	private boolean saveGroup()
	{
		try
		{
			if (form.getLocalContext().getSelectedNode() == null)
				return false;
			
			TumourCategoryVersionGroupsLiteVo version = null;
			TumourGroupVo group = null;

			// Look for selectedNod type
			if (form.getLocalContext().getSelectedNode() instanceof TumourCategoryVersionGroupsLiteVo)
			{
				version = (TumourCategoryVersionGroupsLiteVo) form.getLocalContext().getSelectedNode();
				group = populateDataFromScreenForLyrConfigTabGroup(null);
			}
			else if (form.getLocalContext().getSelectedNode() instanceof TumourGroupListVo)
			{
				version = (TumourCategoryVersionGroupsLiteVo) form.customTree().getParentNod();
				group = populateDataFromScreenForLyrConfigTabGroup((TumourGroupVo) form.getLocalContext().getSelectedRecord());
			}

			if (version == null || group == null)
				return false;

			String[] uiErrors = validateSerumMarkers(group); // getUiErrors();
			String[] errors = group.validate(uiErrors);
			errors = version.validate(errors);
			
			if (errors != null && errors.length > 0)
			{
				engine.showErrors(errors);
				return false;
			}
			
			group = domain.saveGroup(group, version);

			form.getLocalContext().setSelectedRecord(group);
			form.getLocalContext().setOriginalRecord(group);
			
			return true;
		}
		catch (StaleObjectException e)
		{
			displayErrorMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue(), false);
			return false;
		}
		catch (UniqueKeyViolationException e)
		{
			displayErrorMessage(UNIQ_ERR_MSG, false);
			return false;
		}
		catch (UnqViolationUncheckedException e)
		{
			displayErrorMessage(UNIQ_ERR_MSG, false);
			return false;
		}
	}

	/**
	 * Function used to save a new TNM classification Version
	 * If it is a new record - domain function will save it at category level
	 */
	private boolean saveVersion()
	{
		try
		{
			if (form.getLocalContext().getSelectedNode() == null)
				return false;

			TumourCategoryVersionGroupsLiteVo record = null;
			TumourCategoryListVo category = null;

			// Look for selectedNod type
			if (form.getLocalContext().getSelectedNode() instanceof TumourCategoryListVo)
			{
				category = (TumourCategoryListVo) form.getLocalContext().getSelectedNode();
				record = populateDataFromScreenForLyrConfigTabVersion(null);
			}
			else if (form.getLocalContext().getSelectedNode() instanceof TumourCategoryVersionGroupsLiteVo)
			{
				category = (TumourCategoryListVo) form.customTree().getParentNod();
				record = populateDataFromScreenForLyrConfigTabVersion((TumourCategoryVersionGroupsLiteVo) form.getLocalContext().getSelectedRecord());
			}

			if (category == null || record == null)
				return false;

			String[] errors = record.validate(getUiErrors());
			errors = category.validate(errors);
			if (errors != null && errors.length > 0)
			{
				engine.showErrors(errors);
				return false;
			}

			record = domain.saveVersion(record, category);

			form.getLocalContext().setSelectedRecord(record);
			form.getLocalContext().setOriginalRecord(record);

			return true;
		}
		catch (DomainInterfaceException e)
		{
			engine.showMessage(e.getMessage());
			e.printStackTrace();
			return false;
		}
		catch (StaleObjectException e)
		{
			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			e.printStackTrace();
			open();
			return false;
		}
		catch (ForeignKeyViolationException e)
		{
			engine.showMessage(e.getMessage());
			e.printStackTrace();
			return false;
		}
		catch (UniqueKeyViolationException e)
		{
			engine.showMessage(e.getMessage());
			e.printStackTrace();
			return false;
		}
	}

	private TumourCategoryVersionGroupsLiteVo populateDataFromScreenForLyrConfigTabVersion(TumourCategoryVersionGroupsLiteVo groupVersion)
	{
		if (groupVersion == null)
		{
			groupVersion = new TumourCategoryVersionGroupsLiteVo();
		}
		
		groupVersion.setTNMVersion(form.lyrConfig().tabTVersion().cmbVersion().getValue());
		
		return groupVersion;
	}

	private String[] validateSerumMarkers(TumourGroupVo voGroup)
	{
		if (voGroup == null || voGroup.getSerumMarkers() == null)
			return null;
		Boolean flagDelete = false;
		TumourSerumMarkersLiteVoCollection tempVocol = voGroup.getSerumMarkers();
		TumourSerumMarkersLiteVoCollection tempVocol1 = new TumourSerumMarkersLiteVoCollection();
		for (int i = 0; i < tempVocol.size(); i++)
		{
			if (tempVocol.get(i).getSerumMarkerValue() == null || tempVocol.get(i).getSerumMarkerValue().toString().trim().length() == 0 || tempVocol.get(i).getSerumMarkerDescription() == null || tempVocol.get(i).getSerumMarkerDescription().toString().trim().length() == 0)
			{
				flagDelete = true;
				continue;
			}
			tempVocol1.add(tempVocol.get(i));
		}
		if (flagDelete == true)
		{
			voGroup.setSerumMarkers(tempVocol1);
			form.getLocalContext().setSelectedRecord(voGroup);
			form.getLocalContext().setSelectedSerumCollection(tempVocol1);
			return new String[] { "SerumMarkerValue and SerumMarkerDescription are mandatory." };
		}
		return null;

	}

	private String[] getUiErrors()
	{
		return null;
	}

	private void displayErrorMessage(String err, boolean isWarning)
	{
		ArrayList<String> error = new ArrayList<String>();
		error.add(err);

		String[] uniqError = new String[error.size()];
		error.toArray(uniqError);
		if (isWarning)
			engine.showErrors(WARNING, uniqError);
		else
			engine.showErrors(INVALID_RECORD, uniqError);
	}

	private TumourSiteVo populateDataFromScreenForLyrConfigTabSite(TumourSiteVo voSite)
	{
		if (voSite == null)
		{
			voSite = new TumourSiteVo();
			voSite.setTNMVersion(form.customTree().getSelectedBranchVersion());
		}

		voSite.setName(form.lyrConfig().tabTSite().txtSiteName().getValue() != null ? form.lyrConfig().tabTSite().txtSiteName().getValue().trim() : null);
		voSite.setDescription(form.lyrConfig().tabTSite().txtSiteDescription().getValue() != null ? form.lyrConfig().tabTSite().txtSiteDescription().getValue().trim() : null);
		voSite.setIsActive(form.lyrConfig().tabTSite().chkSiteActive().getValue());
		voSite.setHasSiteSpecificTNM(form.lyrConfig().tabTSite().chkSiteSpecificTNM().getValue());
		voSite.setHasSiteSpecificHistology(form.lyrConfig().tabTSite().chkSiteSpecificHistology().getValue());
		voSite.setTaxonomyMap(form.lyrConfig().tabTSite().customSiteMappings().getValue());

		// If group supports TNM Staging, populate data from tabTNM
		if (form.lyrConfig().tabTSite().chkSiteSpecificTNM().getValue())
		{
			if (!form.lyrConfig().tabTNM().isHeaderVisible())
			{
				voSite.setTNMValues(populateDataFromScreenForLyrConfigTabTNM(null));
			}
			else
			{
				populateDataFromValuesTabs(form.getLocalContext().getCurrentSelectedTab());
				populateDataFromMappingsTabs(form.getLocalContext().getCurrentSelectedTab());

				// WDEV-11243
				voSite.setTNMValues(form.getLocalContext().getSelectedTNMCollection());
			}
		}

		// WDEV-11684
		if (Boolean.TRUE.equals(form.getLocalContext().getRefreshHistologyTypeRecords()))
		{
			TumourGroupHistologyVoCollection collTumourHistologyVo = populateDataFromScreenForTabHistology(voSite.getHistologies());
			if (collTumourHistologyVo == null)
				return null;
			voSite.setHistologies(collTumourHistologyVo);
		}

		return voSite;
	}


	private TumourGroupHistopathologyGradeVoCollection populateDataFromScreenForTabHistologicGrade(TumourGroupHistopathologyGradeVoCollection tumourGroupHistopathologyGradeVoCollection)
	{
		tumourGroupHistopathologyGradeVoCollection = new TumourGroupHistopathologyGradeVoCollection();

		for (int i = 0; i < form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getRows().size(); i++)
		{
			Object rowValue = form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getRows().get(i).getValue();
			
			if (rowValue instanceof TumourGroupHistopathologyGradeVo)
				tumourGroupHistopathologyGradeVoCollection.add((TumourGroupHistopathologyGradeVo) rowValue);
		}

		return tumourGroupHistopathologyGradeVoCollection;
	}

	// WDEV-11684
	private TumourGroupHistologyVoCollection populateDataFromScreenForTabHistology(TumourGroupHistologyVoCollection tumourGroupHistologyVoCollection)
	{
		if (tumourGroupHistologyVoCollection == null)
		{
			tumourGroupHistologyVoCollection = new TumourGroupHistologyVoCollection();
		}

		// Histology collection has to be cleared
		tumourGroupHistologyVoCollection.clear();
		
		
		// Iterate the linked histologies
		for (int i = 0; i < form.lyrConfig().tabHistologyType().grdHistology().getRows().size(); i++)
		{
			grdHistologyRow histologyRow = form.lyrConfig().tabHistologyType().grdHistology().getRows().get(i);
			
			tumourGroupHistologyVoCollection.add(histologyRow.getValue());
		}
		
		
		return tumourGroupHistologyVoCollection;
		
	}

	private TumourSerumMarkersLiteVoCollection populateDataFromScreenForTabSerum(TumourSerumMarkersLiteVoCollection serumMarkers)
	{
		if (serumMarkers == null)
		{
			serumMarkers = new TumourSerumMarkersLiteVoCollection();
		}
		
		// Serum Markers collection has to be cleared
		serumMarkers.clear();
		
		// Iterate the linked Serum Markers records
		for (int i = 0; i < form.lyrConfig().tabSerumMarker().grdSerumMarkers().getRows().size(); i++)
		{
			grdSerumMarkersRow serumMarkerRow = form.lyrConfig().tabSerumMarker().grdSerumMarkers().getRows().get(i);
			
			serumMarkers.add(serumMarkerRow.getValue());
		}
		
		return serumMarkers;
	}

	private TumourGroupSpecialtyVoCollection populateDataFromScreenForTabSpecialty(TumourGroupSpecialtyVoCollection savedSpecialties)
	{
		SpecialtyCollection lkpCollSpecialties = ims.core.vo.lookups.LookupHelper.getSpecialty(domain.getLookupService());

		TumourGroupSpecialtyVoCollection returnCollection = new TumourGroupSpecialtyVoCollection();

		if (lkpCollSpecialties != null)
		{

			if (savedSpecialties == null || (savedSpecialties != null && savedSpecialties.size() == 0))
			{
				savedSpecialties = new TumourGroupSpecialtyVoCollection();
			}

			returnCollection = (TumourGroupSpecialtyVoCollection) savedSpecialties.clone();

			for (int i = 0; i < form.lyrConfig().tabSpecialties().treSpecialty().getNodes().size(); i++)
			{
				for (int x = 0; x < lkpCollSpecialties.size(); x++)
				{
					if (form.lyrConfig().tabSpecialties().treSpecialty().getNodes().get(i).getText().equals(lkpCollSpecialties.get(x).getText()))
					{
						boolean flag = false;
						for (int j = 0; j < savedSpecialties.size(); j++)
						{
							if (form.lyrConfig().tabSpecialties().treSpecialty().getNodes().get(i).getText().equals(savedSpecialties.get(j).getAssociatedSpecialty().getText()))
							{
								flag = true;
								break;
							}
						}
						if (!flag)
						{
							TumourGroupSpecialtyVo voTGSpec = new TumourGroupSpecialtyVo();

							voTGSpec.setAssociatedSpecialty(lkpCollSpecialties.get(x));
							voTGSpec.setIsActive(true);

							returnCollection.add(voTGSpec);
						}
					}
				}
			}
		}
		return returnCollection;
	}

	private TumourGroupClassificationVoCollection populateDataFromScreenForTabClassification(TumourGroupClassificationVoCollection voColl)
	{
		TumourGroupClassificationVoCollection returnCollection = new TumourGroupClassificationVoCollection();

		if (voColl == null || (voColl != null && voColl.size() == 0))
		{
			voColl = new TumourGroupClassificationVoCollection();
		}

		returnCollection = (TumourGroupClassificationVoCollection) voColl.clone();

		for (int i = 0; i < form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().size(); i++)
		{
			Object object = form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().get(i).getValue();
			if (object instanceof StagingClassificationVo)
			{
				boolean bReincarnated = false;

				// See if its in the saved collection but marked as inactive......reactivate it and put it in the tree
				for (int n = 0; returnCollection != null && n < returnCollection.size(); n++)
				{
					if (returnCollection.get(n).getClassification().equals(((StagingClassificationVo) object)))
					{
						returnCollection.get(n).setIsActive(true);

						bReincarnated = true;
					}
				}
				if (!bReincarnated)
				{
					TumourGroupClassificationVo voTGC = new TumourGroupClassificationVo();
					voTGC.setClassification(((StagingClassificationVo) form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().get(i).getValue()));
					voTGC.setIsActive(true);

					returnCollection.add(voTGC);
				}
			}
		}

		return returnCollection;

	}

	private void populateScreenFromDataForLyrConfigTabTNM(TumourGroupSiteTNMValueVoCollection voTNMColl, GroupTNMValuesEnumeration option, boolean isActive)
	{
		form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getRows().clear();

		if (voTNMColl == null)
			return;

		for (int x = 0; x < voTNMColl.size(); x++)
		{
			TumourGroupSiteTNMValueVo voTNM = voTNMColl.get(x);

			if (voTNM.getTNMType() != null)
			{
				if (option.equals(GroupTNMValuesEnumeration.rdoMOnly))
				{
					if (!voTNM.getTNMType().equals(TNMType.M))
						continue;
				}
				else if (option.equals(GroupTNMValuesEnumeration.rdoNOnly))
				{
					if (!voTNM.getTNMType().equals(TNMType.N))
						continue;
				}
				else if (option.equals(GroupTNMValuesEnumeration.rdoTOnly))
				{
					if (!voTNM.getTNMType().equals(TNMType.T))
						continue;
				}

				if (isActive)
				{
					if (!voTNM.getIsActive())
						continue;
				}

				addDynGridRow(voTNM, isActive);
			}
		}
	}

	private void populateScreenFromDataForTNMValueMappingsTab(TumourGroupSiteTNMValueVo voTNM)
	{
		form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().txtTNMValue().setValue(voTNM.getTNMValueIsNotNull() ? voTNM.getTNMValue() : null);
		form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().txtTNMDescription().setValue(voTNM.getTNMDescriptionIsNotNull() ? voTNM.getTNMDescription() : null);
		form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().customTNMMappings().setValue(voTNM.getTaxonomyMapIsNotNull() ? voTNM.getTaxonomyMap() : null);
	}

	private void addDynGridRow(TumourGroupSiteTNMValueVo voTNM, boolean isActive)
	{
		if (voTNM == null)
			return;

		DynamicGridRow dynRow = form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getRows().newRow();

		DynamicGridCell typeCell = dynRow.getCells().newCell(getColumn(COLTYPE), DynamicCellType.ANSWER);
		bindTNMTypeLookup(typeCell);
		if (voTNM.getTNMTypeIsNotNull())
		{
			typeCell.setValue(voTNM.getTNMType());
			typeCell.setReadOnly(true);
			if (isEditMode())
				typeCell.setBackColor(Color.LightGray);
		}

		DynamicGridCell tnmCell = dynRow.getCells().newCell(getColumn(COLTNM), DynamicCellType.STRING);
		if (voTNM.getTNMValueIsNotNull())
		{
			tnmCell.setValue(voTNM.getTNMValue());
			tnmCell.setReadOnly(true);
			if (isEditMode())
				tnmCell.setBackColor(Color.LightGray);
		}

		DynamicGridCell cpbCell = dynRow.getCells().newCell(getColumn(COLCPB), DynamicCellType.ENUMERATION);
		bindTNMClinicalpathologicalLookup(cpbCell);
		if (voTNM.getClinicalPathologicalIsNotNull())
		{
			cpbCell.setValue(voTNM.getClinicalPathological());
			cpbCell.setReadOnly(true);
			if (isEditMode())
				cpbCell.setBackColor(Color.LightGray);
		}

		DynamicGridCell descCell = dynRow.getCells().newCell(getColumn(COLTNMDESCRIPTION), DynamicCellType.STRING);
		if (voTNM.getTNMDescriptionIsNotNull())
		{
			descCell.setValue(voTNM.getTNMDescription());
		}
		// WDEV-7804 - Set cell maximum string limit to 500
		descCell.setStringMaxLength(500);

		if (!isActive)
		{
			DynamicGridCell activeCell = dynRow.getCells().newCell(getColumn(COLACTIVE), DynamicCellType.ANSWER);
			bindYesNoLookup(activeCell);
			if (voTNM.getIsActiveIsNotNull())
			{
				if (voTNM.getIsActive())
					activeCell.setValue(YesNo.YES);
				else
					activeCell.setValue(YesNo.NO);
			}
		}

		dynRow.setValue(voTNM);
	}

	private DynamicGridColumn getDiffColumn(Integer identifier)
	{
		return form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getColumns().getByIdentifier(identifier);
	}

	private DynamicGridColumn getColumn(Integer identifier)
	{
		return form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getColumns().getByIdentifier(identifier);
	}

	private TumourGroupSiteTNMValueVoCollection populateDataFromScreenForLyrConfigTabTNM(TumourGroupSiteTNMValueVoCollection voCollTNM)
	{
		if (voCollTNM == null)
			voCollTNM = new TumourGroupSiteTNMValueVoCollection();

		for (int x = 0; x < form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getRows().size(); x++)
		{
			TumourGroupSiteTNMValueVo voTNM = (TumourGroupSiteTNMValueVo) form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getRows().get(x).getValue();

			voTNM.setTNMType((TNMType) form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getRows().get(x).getCells().get(getColumn(COLTYPE)).getValue());
			voTNM.setTNMValue((String) form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getRows().get(x).getCells().get(getColumn(COLTNM)).getValue());
			voTNM.setTNMDescription((String) form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getRows().get(x).getCells().get(getColumn(COLTNMDESCRIPTION)).getValue());
			voTNM.setClinicalPathological((TNMClinicalpathological) form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getRows().get(x).getCells().get(getColumn(COLCPB)).getValue());

			if (!form.lyrConfig().tabTNM().chkActiveTNM().getValue())
			{
				if (form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getRows().get(x).getCells().get(getColumn(COLACTIVE)).getValue().equals(YesNo.NO))
					voTNM.setIsActive(Boolean.FALSE);
				if (form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getRows().get(x).getCells().get(getColumn(COLACTIVE)).getValue().equals(YesNo.YES))
					voTNM.setIsActive(Boolean.TRUE);
			}

			// voTNM.setTaxonomyMap(form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().customTNMMappings().getValue());

			voCollTNM.add(voTNM);
		}

		return voCollTNM;
	}

	private boolean checkFostActiveGroupsOrSitesRecords()
	{
		String errors = new String();

		if (form.getLocalContext().getSelectedRecord() instanceof TumourCategoryVo)
		{
			if ((domain.countForActiveGroupOrSite(form.getLocalContext().getSelectedRecord()).intValue()) > 0)
			{
				errors = ("This tumour category has active tumour groups so may not be deactivated.");
			}
		}
		else if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
		{
			if ((domain.countForActiveGroupOrSite(form.getLocalContext().getSelectedRecord()).intValue()) > 0)
			{
				errors = ("This tumour Group has active Sites so may not be deactivated.");
			}
		}

		if (errors.length() > 0)
		{
			displayErrorMessage(errors, true);

			return true;
		}
		return false;
	}


	private void resetDataLoadedBooleans()
	{
		form.getLocalContext().setbDifferentationForGroupLoaded(false);
		form.getLocalContext().setbTumourGroupSiteTNMValueVoLoaded(false);
		form.getLocalContext().setbTumourHistologyVoLoaded(false);
		form.getLocalContext().setbTumourGroupSpecialtyLoaded(false);
		form.getLocalContext().setbTumourGroupTaxonomyMappingsLoaded(false);
		form.getLocalContext().setbTumourStagingClassificationVoLoaded(false);
		form.getLocalContext().setbSerumMarkerLoaded(false);
		form.getLocalContext().setbOverallStageLoaded(false);
	}

	private void enableClassificationContextMenu(Boolean isEnable)
	{
		boolean isEditMode = form.getMode().equals(FormMode.EDIT);
		form.getContextMenus().Oncology.getTumourGroupOtherClassificationUpdateClassificationItem().setVisible(isEditMode && isEnable);
		form.getContextMenus().Oncology.getTumourGroupOtherClassificationRemoveClassificationItem().setVisible(isEditMode && isEnable);
		form.getContextMenus().Oncology.getTumourGroupOtherClassificationRemoveClassificationItem().setEnabled(isEditMode && isEnable && form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getSelectedNode() != null);
	}

	private void setCustomTaxonomyMode(FormMode mode)
	{
		form.lyrConfig().tabTCategory().customMappings().setComponentMode(mode);
		form.lyrConfig().tabPagTaxonomy().customGroupMapping().setComponentMode(mode);
		form.lyrConfig().tabTSite().customSiteMappings().setComponentMode(mode);
		form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().customTNMMappings().setComponentMode(mode);
	}

	private void enableTaxonomy(Boolean isEnabled)
	{
		TumourCategory menuItem = form.customTree().getContextMenuSelected();

		if (menuItem == null)
			return;

		// Category
		if (menuItem.equals(TumourCategory.NEWCATEGORY) || menuItem.equals(TumourCategory.EDITCATEGORY))
		{
			form.lyrConfig().tabTCategory().customMappings().setComponentMode(form.getMode());
		}
		// Group
		if (menuItem.equals(TumourCategory.NEWGROUP) || menuItem.equals(TumourCategory.EDITGROUP))
		{
			form.lyrConfig().tabPagTaxonomy().customGroupMapping().setComponentMode(form.getMode());
			// If HasTNM
			if (form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkHasTNM().getValue())
			{
				form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().customTNMMappings().setComponentMode(form.getMode());
			}
		}
		// Site
		if (menuItem.equals(TumourCategory.NEWSITE) || menuItem.equals(TumourCategory.EDITSITE))
		{
			form.lyrConfig().tabTSite().customSiteMappings().setComponentMode(form.getMode());
		}
	}

	private void populateTabWithSelectedNodValue(ValueObject object) throws PresentationLogicException
	{
		if (object == null)
			return;

		displaySelectedTab(object);
		
		updateControlsState();
	}

	private void displaySelectedTab(ValueObject object) throws PresentationLogicException
	{
		form.getLocalContext().setHasOverall(Boolean.FALSE);
		form.getLocalContext().setHasPrognosticGrouping(Boolean.FALSE);
		
		TumourCategoryListVo voTumourCategoryList = null;
		TumourGroupListVo voTumourGroupList = null;
		TumourSiteListVo voTumourSiteList = null;

		form.setMode(FormMode.VIEW);

		if (object instanceof TumourCategoryListVo)
		{
			voTumourCategoryList = (TumourCategoryListVo) object;
			TumourCategoryVo voCategory = domain.getCategory(voTumourCategoryList);

			form.getLocalContext().setSelectedRecord(voCategory);
			// put record in local context
			// put an snapshoot record in local context
			form.getLocalContext().setOriginalRecord(voCategory);
			form.getLocalContext().setParentCategory(null);
			form.getLocalContext().setCurrentSelectedTab(TumourCategoryGroupSiteSelectedTab.CATEGORY);
			populateTab(TumourCategory.CATEGORY, voCategory);
		}
		else if (object instanceof TumourCategoryVersionGroupsLiteVo)
		{
			form.getLocalContext().setSelectedRecord(object);
			form.getLocalContext().setOriginalRecord(object);
			form.getLocalContext().setParentCategory((TumourCategoryListVo) form.customTree().getRootNod());
			
			form.getLocalContext().setCurrentSelectedTab(TumourCategoryGroupSiteSelectedTab.VERSION);
			
			populateTab(TumourCategory.VERSION, object);
		}
		else if (object instanceof TumourGroupListVo)
		{
			voTumourGroupList = (TumourGroupListVo) object;

			// WDEV-6791
			form.getLocalContext().setParentGroup(voTumourGroupList);

			TumourGroupVo voGroup = domain.getGroup(voTumourGroupList);

			// put record in local context
			form.getLocalContext().setSelectedRecord(voGroup);

			// put an snapshoot record in local context
			form.getLocalContext().setOriginalRecord(voGroup);
			form.getLocalContext().setParentCategory((TumourCategoryListVo) form.customTree().getRootNod());
			form.getLocalContext().setHasOverall(domain.countForOverallStaging(voGroup) > 0 ? Boolean.TRUE : Boolean.FALSE);
			form.getLocalContext().setHasPrognosticGrouping(domain.countForOverallPrognostic(voGroup));
			form.getLocalContext().setCurrentSelectedTab(TumourCategoryGroupSiteSelectedTab.GROUP);
			
			form.getLocalContext().setOtherClassificationSavedCollection(voGroup.getOtherClassifications());
			
			populateTab(TumourCategory.GROUP, voGroup);

			// If Group have TNM values, enable Overall Context Menu
			if (voGroup.getHasTNMIsNotNull() && voGroup.getHasTNM())
			{
				form.customTree().showHideOverallContextMenu(TumourCategory.OVERALLSTAGING, Boolean.TRUE);
			}
			// If Group doesn't have TNM values, disable Overall Context Menu
			else
			{
				form.customTree().showHideOverallContextMenu(TumourCategory.OVERALLSTAGING, Boolean.FALSE);
			}
		}
		else if (object instanceof TumourSiteListVo)
		{
			voTumourSiteList = (TumourSiteListVo) object;
			TumourSiteVo voSite = domain.getSite(voTumourSiteList);

			// put record in local context
			form.getLocalContext().setSelectedRecord(voSite);
			// put an snapshoot record in local context
			form.getLocalContext().setOriginalRecord(voSite);
			form.getLocalContext().setParentCategory((TumourCategoryListVo) form.customTree().getRootNod());
			form.getLocalContext().setParentGroup((TumourGroupListVo) form.customTree().getParentNod());
			form.getLocalContext().setHasOverall(domain.countForOverallStaging(voSite) > 0 ? Boolean.TRUE : Boolean.FALSE);
			form.getLocalContext().setCurrentSelectedTab(TumourCategoryGroupSiteSelectedTab.SITE);
			
			// WDEV-13081
			// Set TNM records in local context (back values for TNM grid)
			form.getLocalContext().setSelectedTNMCollection(voSite.getTNMValues());
			
			populateTab(TumourCategory.SITE, voSite);

			// If Site have TNM values, enable Overall Context Menu
			if (voSite.getHasSiteSpecificTNMIsNotNull() && voSite.getHasSiteSpecificTNM())
			{
				form.customTree().showHideOverallContextMenu(TumourCategory.OVERALLSTAGING, Boolean.TRUE);
			}
			// If Site have TNM values, enable Overall Context Menu
			else
			{
				form.customTree().showHideOverallContextMenu(TumourCategory.OVERALLSTAGING, Boolean.FALSE);
			}

		}
	}

	private void populateTab(TumourCategory category, ValueObject object) throws PresentationLogicException
	{
		if (category != null)
		{
			if (category.equals(TumourCategory.CATEGORY))
				rulesForCategory();
			
			if (TumourCategory.VERSION.equals(category))
				rulesForVersion();

			if (category.equals(TumourCategory.GROUP))
				rulesForGroup();

			if (category.equals(TumourCategory.SITE))
				rulesForSite();
		}

		if (object != null)
		{
			if (object instanceof TumourCategoryVo)
			{
				TumourCategoryVo voList = (TumourCategoryVo) object;
				populateScreenFromDataForLyrConfigTabCategory(voList);
			}
			else if (object instanceof TumourCategoryVersionGroupsLiteVo)
			{
				populateScreenFromDataForLyrConfigTabVersion((TumourCategoryVersionGroupsLiteVo) object);
			}
			else if (object instanceof TumourGroupVo)
			{
				populateScreenFromDataForLyrConfigTabGroup((TumourGroupVo) object);
			}
			else if (object instanceof TumourSiteVo)
			{
				TumourSiteVo voList = (TumourSiteVo) object;
				populateScreenFromDataForLyrConfigTabSite(voList);
			}
		}
	}

	private void populateScreenFromDataForLyrConfigTabVersion(TumourCategoryVersionGroupsLiteVo version)
	{
		form.lyrConfig().tabTVersion().cmbVersion().clear();
		clearVersionDetails();
		
		if (version == null)
			return;
		
		if (!version.getTNMVersionIsNotNull())
			throw new CodingRuntimeException("Invalid version record");
		
		form.lyrConfig().tabTVersion().cmbVersion().newRow(version.getTNMVersion(), version.getTNMVersion().getVersionNumber());
		form.lyrConfig().tabTVersion().cmbVersion().setValue(version.getTNMVersion());
		
		populateVersionDetails(version.getTNMVersion());
	}

	private void rulesForSite()
	{

		if (form.getLocalContext().getSelectedRecordIsNotNull() && form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
		{
			// If Site have Overall Staging
			if (domain.countForOverallStaging((TumourSiteVo) form.getLocalContext().getSelectedRecord()) > 0)
			{
				enableTabs(false, false, false, true, false, true, false, false, false, false, false, false); // true, false);
			}
			else
			{
				enableTabs(false, false, false, true, true, true, false, false, false, false, false, false);
			}
		}

		form.lyrConfig().showtabTSite();
	}

	private void rulesForGroup()
	{
		if (form.getLocalContext().getSelectedRecordIsNotNull() && form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
		{
			// If Group have Overall Staging
			if (domain.countForOverallStaging((TumourGroupVo) form.getLocalContext().getSelectedRecord()) > 0)
			{
				enableTabs(false, false, true, false, true, true, false, false, true, true, true, false); // true, false);
			}
			else
			{				
				enableTabs(false, false, true, false, true, true, false, false, true, true, true, false);
			}
		}

		// Enable Speciality, Taxonomy and Differentiation tabs
		enableEmbeddedTabs(false, false, true, true, true);

		form.lyrConfig().showtabTGroup();
	}

	private void rulesForVersion()
	{
		enableTabs(false, true, false, false, false, false, false, false, false, false, false, false);
		form.lyrConfig().showtabTVersion();
	}

	private void rulesForCategory()
	{
		// enable only TCategory tab
		enableTabs(true, false, false, false, false, false, false, false, false, false, false, false);
		form.lyrConfig().showtabTCategory();
	}

	private void populateScreenFromDataForLyrConfigTabSite(TumourSiteVo voSite) throws PresentationLogicException
	{

		form.lyrConfig().tabTSite().txtSiteName().setValue(voSite.getName());
		form.lyrConfig().tabTSite().txtSiteDescription().setValue(voSite.getDescription());
		form.lyrConfig().tabTSite().chkSiteActive().setValue(voSite.getIsActive());

		checkIfGroupSupportsTNMStaging();

		form.lyrConfig().tabTSite().chkSiteSpecificTNM().setValue(voSite.getHasSiteSpecificTNMIsNotNull() ? voSite.getHasSiteSpecificTNM().booleanValue() : false);
		onChkSiteSpecificTNMValueChanged();

		form.lyrConfig().tabTSite().chkSiteSpecificHistology().setValue(voSite.getHasSiteSpecificHistologyIsNotNull() ? voSite.getHasSiteSpecificHistology().booleanValue() : false);
		onChkSiteSpecificHistologyValueChanged();

		// If tabTNM is visible, populate it.
		if (form.lyrConfig().tabTSite().chkSiteSpecificTNM().getValue())
		{
			populateLyrConfigTabTNM(voSite);
		}

		form.lyrConfig().tabTSite().customSiteMappings().setValue(voSite.getTaxonomyMapIsNotNull() ? voSite.getTaxonomyMap() : null);

		if (domain.countForOverallStaging(voSite) > 0)
		{
			form.getLocalContext().setHasOverall(true);
		}
		else
		{
			form.getLocalContext().setHasOverall(false);
		}
		// reselect TSite
		form.lyrConfig().showtabTSite();
		form.getLocalContext().setCurrentSelectedTab(TumourCategoryGroupSiteSelectedTab.SITE);
	}

	private boolean checkIfGroupSupportsTNMStaging()
	{
		// Enable checkbox only if group supports TNM Staging
		if (isEditMode())
		{
			if (!groupSupportsTNMStaging())
			{
				form.lyrConfig().tabTSite().chkSiteSpecificTNM().setValue(false);
				engine.showMessage("This checkbox is enabled only if group supports TNM Staging");
				return false;
			}
		}

		return true;
	}

	private void populateScreenFromDataForLyrConfigTabGroup(TumourGroupVo voGroup) throws PresentationLogicException
	{
		if (voGroup == null)
			return;
		
		form.lyrConfig().tabTGroup().txtGroupName().setValue(voGroup.getGroupName());
		form.lyrConfig().tabTGroup().txtGroupDescription().setValue(voGroup.getGroupDescription());
		form.lyrConfig().tabTGroup().chkGroupActive().setValue(voGroup.getIsActive());
		
		if (voGroup.getAssessmentIsNotNull())
		{
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().qmbLinkedAssessment().newRow(voGroup.getAssessment(), voGroup.getAssessment().getName());
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().qmbLinkedAssessment().setValue(voGroup.getAssessment());
		}
		else
		{
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().qmbLinkedAssessment().clear();
		}
		
		initializeTabTNM(true);
		
		// TNM
		if (voGroup.getHasTNMIsNotNull() && voGroup.getHasTNM().booleanValue())
		{
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkHasTNM().setValue(true);
			initializeTabTNM(true);

			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().setEnabled(false);

			if (domain.countForOverallStaging(voGroup) > 0)
			{
				form.getLocalContext().setHasOverall(true);
				if (isEditMode())
				{
					form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqHistology().setEnabled(false);
					form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqSerumMarkers().setEnabled(false);
					form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqDiff().setEnabled(false);
					form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqO45().setEnabled(false);
				}
			}
			else
			{
				form.getLocalContext().setHasOverall(false);
				if (isEditMode())
				{
					form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqHistology().setEnabled(true);
					form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqSerumMarkers().setEnabled(true);
					form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqDiff().setEnabled(true);
					form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqO45().setEnabled(true);
				}
			}
			
			form.getLocalContext().setHasPrognosticGrouping(domain.countForOverallPrognostic(voGroup));
		}
		else
		{
			form.getLocalContext().setHasOverall(false);
			form.getLocalContext().setHasPrognosticGrouping(false);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkHasTNM().setValue(false);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().setEnabled(true);
		}

		// WDEV-13723
		// OtherClassification
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkOtherClassifications().setValue(Boolean.TRUE.equals(voGroup.getHasOtherClassifications()));
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().setHeaderVisible(Boolean.TRUE.equals(voGroup.getHasOtherClassifications()));
		
		populateOtherClassification(form.getLocalContext().getOtherClassificationSavedCollection());

		// TGroupConfig
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkPrognosticGrouping().setValue(Boolean.TRUE.equals(voGroup.getIsPrognosticGroupingRelevant()));
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqHistology().setValue((voGroup.getTnmRequiresHistoIsNotNull() ? voGroup.getTnmRequiresHisto() : false));
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqSerumMarkers().setValue((voGroup.getTnmRequiresSMarkersIsNotNull() ? voGroup.getTnmRequiresSMarkers() : false));
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqDiff().setValue((voGroup.getTnmRequiresDiffIsNotNull() ? voGroup.getTnmRequiresDiff() : false));
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqO45().setValue((voGroup.getTnmRequiresOver45IsNotNull() ? voGroup.getTnmRequiresOver45() : false));

		// TPrognostic Configuration
		if (voGroup.getPrognosticGroupingConfigIsNotNull())
		{
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkUsesTValues().setValue(Boolean.TRUE.equals(voGroup.getPrognosticGroupingConfig().getUseTValues()));
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkUsesNValues().setValue(Boolean.TRUE.equals(voGroup.getPrognosticGroupingConfig().getUseNValues()));
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkUsesMValues().setValue(Boolean.TRUE.equals(voGroup.getPrognosticGroupingConfig().getUseMValues()));
			
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkHistologyTypePrognosticGrouping().setValue(Boolean.TRUE.equals(voGroup.getPrognosticGroupingConfig().getIsHistologicalTypePertinent()));
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkHistologicalGradePrognosticGrouping().setValue(Boolean.TRUE.equals(voGroup.getPrognosticGroupingConfig().getIsHistologicalGradePertinent()));
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkTumourLocationPrognosticGrouping().setValue(Boolean.TRUE.equals(voGroup.getPrognosticGroupingConfig().getIsTumourLocationPertinent()));
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkRiskCategoryPrognosticGrouping().setValue(Boolean.TRUE.equals(voGroup.getPrognosticGroupingConfig().getIsRiskCategoryPertinent()));
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkPSAPrognosticGrouping().setValue(Boolean.TRUE.equals(voGroup.getPrognosticGroupingConfig().getIsPSAPertinent()));
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkGleasonPrognosticGrouping().setValue(Boolean.TRUE.equals(voGroup.getPrognosticGroupingConfig().getIsGleasonPertinent()));
		}
		else
		{
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkUsesTValues().setValue(false);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkUsesNValues().setValue(false);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkUsesMValues().setValue(false);

			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkHistologyTypePrognosticGrouping().setValue(false);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkHistologicalGradePrognosticGrouping().setValue(false);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkTumourLocationPrognosticGrouping().setValue(false);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkRiskCategoryPrognosticGrouping().setValue(false);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkPSAPrognosticGrouping().setValue(false);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkGleasonPrognosticGrouping().setValue(false);			
		}
		
		// TSerumMarkers
		form.lyrConfig().tabSerumMarker().setHeaderVisible(true);

		// Differentation
//		form.lyrConfig().tabTGroup().lyrGroupDetails().tabDifferentation().setHeaderVisible(true);

		// Histology
		form.lyrConfig().tabHistologyType().setHeaderVisible(true);

		// form.lyrConfig().tabTGroup().chkOtherClassifications().setValue((voGroup.getHasOtherClassificationsIsNotNull() ? voGroup.getHasOtherClassifications() : false));
		// onChkOtherClassificationsValueChanged();

		if (form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().isHeaderVisible())
		{
			// populate tabClassification
			// populateEmbeddedTab(form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification(), voGroup);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().setHeaderVisible(true);
		}
		else
		{
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().setHeaderVisible(false);
		}

		// reselect TGroup
		form.lyrConfig().showtabTGroup();
		form.lyrConfig().tabTGroup().lyrGroupDetails().showtabPageGroupDetails();
	}

	private void populateOtherClassification(TumourGroupClassificationVoCollection otherClassifications)
	{
		// Clear other classification tree
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().clear();
		
		// Check other classification values collection
		if (otherClassifications == null)
			return;
		
		// Sort Other Classification records
		otherClassifications.sort();
		
		// Populate other classifications to grid
		for (TumourGroupClassificationVo otherClassification : otherClassifications)
		{
			// Add each of Other Classification record to tree
			// The Classification field is mandatory so there is no need to perform a check on this
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().add(otherClassification, otherClassification.getClassification().getName());
		}
	}

	private void populateScreenFromDataForLyrConfigTabCategory(TumourCategoryVo vo)
	{
		form.lyrConfig().tabTCategory().txtCatName().setValue(vo.getCategoryName());
		form.lyrConfig().tabTCategory().txtCatDescription().setValue(vo.getCategoryDescription());
		form.lyrConfig().tabTCategory().chkCatActive().setValue(vo.getIsActive());
		form.lyrConfig().tabTCategory().customMappings().setComponentMode(form.getMode());
		form.lyrConfig().tabTCategory().customMappings().setValue(vo.getTaxonomyMapIsNotNull() ? vo.getTaxonomyMap() : null);
	}

	private TumourCategoryVo populateDataFromScreenForLyrConfigTabCategory(TumourCategoryVo voCategory)
	{
		if (voCategory == null)
			voCategory = new TumourCategoryVo();

		voCategory.setCategoryName(form.lyrConfig().tabTCategory().txtCatName().getValue() != null ? form.lyrConfig().tabTCategory().txtCatName().getValue().trim() : null);
		voCategory.setCategoryDescription(form.lyrConfig().tabTCategory().txtCatDescription().getValue() != null ? form.lyrConfig().tabTCategory().txtCatDescription().getValue().trim() : null);
		voCategory.setIsActive(form.lyrConfig().tabTCategory().chkCatActive().getValue());
		voCategory.setTaxonomyMap(form.lyrConfig().tabTCategory().customMappings().getValue());

		return voCategory;
	}

	private void populateLyrConfigTabTNM(ValueObject vo)
	{
		// By default show all TNM
		form.lyrConfig().tabTNM().GroupTNMValues().setValue(GroupTNMValuesEnumeration.rdoAll);

		// Hide Taxonomy tab
		form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().setHeaderVisible(false);

		// Show active records
		form.lyrConfig().tabTNM().chkActiveTNM().setValue(true);

		if (vo instanceof TumourGroupVo)
		{
			populateLyrConfigTabTNMForGroup(vo);
		}
		else if (vo instanceof TumourSiteVo)
		{
			populateLyrConfigTabTNMForSite(vo);
		}
	}

	private void populateLyrConfigTabTNMForSite(ValueObject vo)
	{
		if (form.customTree().getParentNod() == null)
			return;

		enableTNMContextMenu(Boolean.TRUE);
		populateScreenFromDataForLyrConfigTabTNM(((TumourSiteVo) vo).getTNMValues(), GroupTNMValuesEnumeration.rdoAll, true);

		String groupName = (((TumourGroupListVo) form.customTree().getParentNod()).getGroupNameIsNotNull() ? ((TumourGroupListVo) form.customTree().getParentNod()).getGroupName() : "");
		String siteName = (((TumourSiteVo) vo).getNameIsNotNull() ? ((TumourSiteVo) vo).getName() : "");

		// Populate labelTitle with the text of the Tumour group and site selected
		form.lyrConfig().tabTNM().lblTitle().setValue("Group : " + groupName.toUpperCase() + " , Site selected : " + siteName.toUpperCase());
	}

	private void populateLyrConfigTabTNMForGroup(ValueObject vo)
	{
		enableTNMContextMenu(Boolean.TRUE);
		populateScreenFromDataForLyrConfigTabTNM(((TumourGroupVo) vo).getTNMValues(), GroupTNMValuesEnumeration.rdoAll, true);

		String groupName = (((TumourGroupVo) vo).getGroupNameIsNotNull() ? ((TumourGroupVo) vo).getGroupName() : "");

		// Populate labelTitle with the text of the Tumour group and site selected
		form.lyrConfig().tabTNM().lblTitle().setValue("Group selected : " + groupName.toUpperCase());
	}

	private void populateEmbeddedTab(LayerBridge tab, ValueObject vo) throws PresentationLogicException
	{
		TumourGroupVo voGroup = null;

		if (vo instanceof TumourGroupVo)
			voGroup = (TumourGroupVo) vo;

		if (tab.equals(form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM()))
			populateLyrDetailsTabTNMDetails(voGroup);

		if (tab.equals(form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification()))
			populateLyrDetailsTabConffiguration(voGroup);

		if (tab.equals(form.lyrConfig().tabSpecialties()))
			populateLyrDetailsTabSpecialty(voGroup);

		if (tab.equals(form.lyrConfig().tabPagTaxonomy()))
		{
			populateLyrDetailsTabTaxonomy(voGroup);
		}

		if (tab.equals(form.lyrConfig().tabHistologyGrade()))
		{
			if (!form.getLocalContext().getbDifferentationForGroupLoaded())
			{
				populateLyrDetailsTabDifferentation(voGroup);
				form.getLocalContext().setbDifferentationForGroupLoaded(true);
			}
		}

		if (tab.equals(form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM()))
		{
			populateLyrDetailsTabGroupTNM(voGroup);
		}
	}

	private void populateLyrDetailsTabGroupTNM(TumourGroupVo voGroup)
	{
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqHistology().setValue((voGroup.getTnmRequiresHistoIsNotNull() ? voGroup.getTnmRequiresHisto() : false));
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqSerumMarkers().setValue((voGroup.getTnmRequiresSMarkersIsNotNull() ? voGroup.getTnmRequiresSMarkers() : false));
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqDiff().setValue((voGroup.getTnmRequiresDiffIsNotNull() ? voGroup.getTnmRequiresDiff() : false));
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqO45().setValue((voGroup.getTnmRequiresOver45IsNotNull() ? voGroup.getTnmRequiresOver45() : false));
	}

	private void populateClassificationTree(TumourGroupClassificationVoCollection voColl)
	{
		if (!form.getLocalContext().getbTumourStagingClassificationVoLoaded())
		{
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().clear();

			if (voColl != null)
			{
				for (int i = 0; i < voColl.size(); i++)
				{
					if (voColl.get(i).getIsActiveIsNotNull() && voColl.get(i).getIsActive().booleanValue())
					{
						TreeNode currentNod = form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().add(voColl.get(i), voColl.get(i).getClassification().getName());
						int size = voColl.get(i).getClassification().getValues().size();
						String s = "<b>Classification Values : <br></b>";
						if (size > 0)
						{
							for (int j = 0; j < size; j++)
							{
								if (voColl.get(i).getClassification().getValues().get(j).getIsActive())
								{
									s += voColl.get(i).getClassification().getValues().get(j).getName() + "<br>";
								}
							}
							currentNod.setTooltip(s);
						}
					}
				}

				form.lyrConfig().tabSpecialties().treSpecialty().getNodes().sortByText();

				form.getLocalContext().setbTumourStagingClassificationVoLoaded(true);
			}
		}
	}

	private void populateClassificationTree(StagingClassificationVoCollection voCollFromDialog)
	{
		if (voCollFromDialog != null)
		{
			for (int i = 0; i < voCollFromDialog.size(); i++)
			{
				boolean bFound = false;
				boolean bReincarnated = false;
				TumourGroupClassificationVo voReincarnated = null;

				// See if its in the tree ..... don't add it again if it is.
				for (int k = 0; k < form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().size(); k++)
				{
					if (form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().get(k).getValue() instanceof StagingClassificationVo && ((StagingClassificationVo) form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().get(k).getValue()).equals(voCollFromDialog.get(i)))
						bFound = true;

					if (form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().get(k).getValue() instanceof TumourGroupClassificationVo && ((TumourGroupClassificationVo) form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().get(k).getValue()).getClassification().equals(voCollFromDialog.get(i)))
						bFound = true;
				}
				// See if its in the saved collection but marked as inactive......reactivate it and put it in the tree
				for (int n = 0; form.getLocalContext().getOtherClassificationSavedCollectionIsNotNull() && n < form.getLocalContext().getOtherClassificationSavedCollection().size(); n++)
				{
					if (form.getLocalContext().getOtherClassificationSavedCollection().get(n).getClassification().equals(voCollFromDialog.get(i)))
					{
						form.getLocalContext().getOtherClassificationSavedCollection().get(n).setIsActive(true);

						bReincarnated = true;
						voReincarnated = form.getLocalContext().getOtherClassificationSavedCollection().get(n);
					}
				}

				if (!bFound)
				{
					TreeNode currentNod = form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().add(voCollFromDialog.get(i), voCollFromDialog.get(i).getName());
					int size = voCollFromDialog.get(i).getValues().size();
					String s = "<b>Classification Values : <br></b>";
					if (size > 0)
					{
						for (int j = 0; j < size; j++)
						{
							if (voCollFromDialog.get(i).getValues().get(j).getIsActive())
							{
								s += voCollFromDialog.get(i).getValues().get(j).getName() + "<br>";
							}
						}
						currentNod.setTooltip(s);
					}

					if (bReincarnated)
						currentNod.setValue(voReincarnated);
				}
			}
		}

		form.lyrConfig().tabSpecialties().treSpecialty().getNodes().sortByText();
	}

	private void populateLyrDetailsTabTNMDetails(TumourGroupVo voGroup) throws PresentationLogicException
	{
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqHistology().setValue(voGroup.getHasTNM());

		form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqSerumMarkers().setValue(voGroup.getTnmRequiresSMarkersIsNotNull() ? true : false);
		onChkReqSerumMarkersValueChanged();

		if (form.lyrConfig().tabSerumMarker().isHeaderVisible())
		{
			//  - add cod for this
				// Yeah, right - this was here from the first check in
		}

		form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqDiff().setValue(voGroup.getTnmRequiresDiffIsNotNull() ? true : false);
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqO45().setValue(voGroup.getTnmRequiresOver45IsNotNull() ? true : false);
	}

	private void populateLyrDetailsTabSpecialty(TumourGroupVo voGroup)
	{
		if (voGroup != null)
		{
			TumourGroupSpecialtyVoCollection specialties = (voGroup.getAssociatedSpecialtiesIsNotNull() ? voGroup.getAssociatedSpecialties() : null);
			populateSpecialtyTree(specialties);
			form.getLocalContext().setSpecialtiesSavedCollection(specialties);
		}
	}

	private void populateLyrDetailsTabConffiguration(TumourGroupVo voGroup)
	{
		enableClassificationContextMenu(Boolean.TRUE);
		if (voGroup == null)
			return;

		populateClassificationTree(voGroup.getOtherClassifications());

		form.getLocalContext().setOtherClassificationSavedCollection(voGroup.getOtherClassifications());
	}

	private void populateSpecialtyTree(TumourGroupSpecialtyVoCollection specialties)
	{
		form.lyrConfig().tabSpecialties().treSpecialty().getNodes().clear();

		if (specialties != null)
		{
			for (int i = 0; i < specialties.size(); i++)
			{
				if (specialties.get(i).getIsActiveIsNotNull() && specialties.get(i).getIsActive().booleanValue())
					form.lyrConfig().tabSpecialties().treSpecialty().getNodes().add(specialties.get(i), specialties.get(i).getAssociatedSpecialty().getText());
			}

			form.lyrConfig().tabSpecialties().treSpecialty().getNodes().sortByText();
			form.getLocalContext().setbTumourGroupSpecialtyLoaded(true);
		}
	}

	private void populateSpecialtyTree(SpecialtyCollection specialtiesFromDialog)
	{
		if (specialtiesFromDialog != null)
		{
			for (int i = 0; i < specialtiesFromDialog.size(); i++)
			{
				boolean bFound = false;
				boolean bReincarnated = false;
				TumourGroupSpecialtyVo voReincarnated = null;

				// See if its in the tree ..... don't add it again if it is.
				for (int k = 0; k < form.lyrConfig().tabSpecialties().treSpecialty().getNodes().size(); k++)
				{
					if (form.lyrConfig().tabSpecialties().treSpecialty().getNodes().get(k).getValue() instanceof Specialty && ((Specialty) form.lyrConfig().tabSpecialties().treSpecialty().getNodes().get(k).getValue()).equals(specialtiesFromDialog.get(i)))
						bFound = true;

					if (form.lyrConfig().tabSpecialties().treSpecialty().getNodes().get(k).getValue() instanceof TumourGroupSpecialtyVo && ((TumourGroupSpecialtyVo) form.lyrConfig().tabSpecialties().treSpecialty().getNodes().get(k).getValue()).getAssociatedSpecialty().equals(specialtiesFromDialog.get(i)))
						bFound = true;
				}
				// See if its in the saved collection but marked as inactive......reactivate it and put it in the tree
				for (int n = 0; form.getLocalContext().getSpecialtiesSavedCollectionIsNotNull() && n < form.getLocalContext().getSpecialtiesSavedCollection().size(); n++)
				{
					if (form.getLocalContext().getSpecialtiesSavedCollection().get(n).getAssociatedSpecialty().equals(specialtiesFromDialog.get(i)))
					{
						form.getLocalContext().getSpecialtiesSavedCollection().get(n).setIsActive(true);

						bReincarnated = true;
						voReincarnated = form.getLocalContext().getSpecialtiesSavedCollection().get(n);
					}
				}

				if (!bFound)
				{
					TreeNode currentNod = form.lyrConfig().tabSpecialties().treSpecialty().getNodes().add(specialtiesFromDialog.get(i), specialtiesFromDialog.get(i).toString());

					if (bReincarnated)
						currentNod.setValue(voReincarnated);
				}
			}
			form.getLocalContext().setbTumourGroupSpecialtyLoaded(true);
		}

		form.lyrConfig().tabSpecialties().treSpecialty().getNodes().sortByText();
	}

	private void populateLyrDetailsTabTaxonomy(TumourGroupVo voGroup)
	{
		form.lyrConfig().tabPagTaxonomy().customGroupMapping().setValue(voGroup.getTaxonomyMap());
	}

	private void populateLyrDetailsTabDifferentation(TumourGroupVo voGroup)
	{
		initialiseDifferentationDynamicGrid();
		form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getRows().clear();
		TumourGroupHistopathologyGradeVoCollection voColl = voGroup.getHistopathologicGrades();

		for (int i = 0; voColl != null && i < voColl.size(); i++)
		{
			TumourGroupHistopathologyGradeVo tumourGroupHistopathologicGrade = voColl.get(i);
			
			DynamicGridRow row = form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getRows().newRow();

			DynamicGridCell diffCell = row.getCells().newCell(getDiffColumn(COLDIFF), DynamicCellType.STRING);

			diffCell.setValue(tumourGroupHistopathologicGrade.getTumourDifferentation().toString());
			diffCell.setIdentifier(tumourGroupHistopathologicGrade.getTumourDifferentation().getTumourDifferentation());
			
			diffCell = row.getCells().newCell(getDiffColumn(COLGRADE), DynamicCellType.STRING);
			diffCell.setValue(tumourGroupHistopathologicGrade.getTumourDifferentation().getGrade());
			
			row.setTextColor(Boolean.TRUE.equals(tumourGroupHistopathologicGrade.getIsActive()) ? Color.Black : Color.Gray);
			
			row.setValue(tumourGroupHistopathologicGrade);
		}

//		form.getLocalContext().setDifferentationCollection(domain.listAllTumourDiffs());
//		form.getLocalContext().setDifferentationSavedCollection(voColl);
	}

	private void enableEmbeddedTabs(boolean tabGroupTNM, boolean tabClassification, boolean tabSpecialty, boolean tabTaxonomy, boolean tabDifferentation)
	{
//		form.lyrConfig().tabTGroup().lyrGroupDetails().showtabSpecialty();
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().setHeaderVisible(tabGroupTNM);
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().setHeaderVisible(tabClassification);
//		form.lyrConfig().tabTGroup().lyrGroupDetails().tabSpecialty().setHeaderVisible(tabSpecialty);
//		form.lyrConfig().tabTGroup().lyrGroupDetails().tabTaxonomy().setHeaderVisible(tabTaxonomy);
//		form.lyrConfig().tabTGroup().lyrGroupDetails().tabDifferentation().setHeaderVisible(tabDifferentation);
	}

	private void enableTabs(boolean tabTCategory, boolean tabTVersion, boolean tabTGroup, boolean tabTSite,
			boolean tabTNM, boolean tabHistology, boolean SerumMarker, boolean Overall,
			boolean tabHistologyGrade, boolean tabSpecialty, boolean tabTaxonomy, boolean tabNoDetails)
	{
		form.lyrConfig().tabTCategory().setHeaderVisible(tabTCategory);
		form.lyrConfig().tabTCategory().setEnabled(tabTCategory);
		form.lyrConfig().tabTVersion().setHeaderVisible(tabTVersion);
		form.lyrConfig().tabTVersion().setEnabled(tabTVersion);
		form.lyrConfig().tabTGroup().setHeaderVisible(tabTGroup);
		form.lyrConfig().tabTGroup().setEnabled(tabTGroup);
		form.lyrConfig().tabTSite().setHeaderVisible(tabTSite);
		form.lyrConfig().tabTSite().setEnabled(tabTSite);
		form.lyrConfig().tabTNM().setHeaderVisible(tabTNM);
		form.lyrConfig().tabTNM().setEnabled(tabTNM);
		form.lyrConfig().tabTNM().setHeaderEnabled(tabTNM);
		form.lyrConfig().tabHistologyType().setHeaderVisible(tabHistology);
		form.lyrConfig().tabHistologyType().setEnabled(tabHistology);
		form.lyrConfig().tabHistologyType().setHeaderEnabled(tabHistology);
		form.lyrConfig().tabSerumMarker().setHeaderVisible(SerumMarker);
		form.lyrConfig().tabSerumMarker().setEnabled(SerumMarker);
		
		form.lyrConfig().tabHistologyGrade().setHeaderVisible(tabHistologyGrade);
		form.lyrConfig().tabHistologyGrade().setEnabled(tabHistologyGrade);
		
		form.lyrConfig().tabSpecialties().setHeaderVisible(tabSpecialty);
		form.lyrConfig().tabSpecialties().setEnabled(tabSpecialty);
		
		form.lyrConfig().tabPagTaxonomy().setHeaderVisible(tabTaxonomy);
		form.lyrConfig().tabPagTaxonomy().setEnabled(tabTaxonomy);
		
		form.lyrConfig().tabNoDetails().setHeaderVisible(tabNoDetails);
	}

	@Override
	protected void onChkHasTNMValueChanged() throws PresentationLogicException
	{
//		if (!form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkHasTNM().getValue())
//		{
//			if (form.getLocalContext().getSelectedRecordIsNotNull())
//			{
//				if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
//				{
//					if (form.getLocalContext().getHasOverallIsNotNull() && form.getLocalContext().getHasOverall())
//					{
//						displayErrorMessage("An Overall configuration exists!", true);
//						form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkHasTNM().setValue(true);
//					}
//				}
//			}
//		}

		updateControlsState();
	}

	private void initializeTabTNM(boolean isEnabled)
	{
		if (!isEnabled &&
		// If is not a new group
		form.getLocalContext().getSelectedRecordIsNotNull() && form.getLocalContext().getSelectedRecord() instanceof TumourGroupRefVo)
		{
			if (checkIfGroupHaveSiteWhoHaveTNM())
			{
				form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkHasTNM().setValue(true);
				return;
			}
		}
		else
		{
//			form.lyrConfig().tabTGroup().lyrGroupDetails().showtabGroupTNM();

			if (form.getLocalContext().getSelectedRecordIsNotNull() && form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo && ((TumourGroupVo) form.getLocalContext().getSelectedRecord()).getID_TumourGroup() == null)
			{
				form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqHistology().setValue(false);
				form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqSerumMarkers().setValue(false);
				form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqDiff().setValue(false);
				form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqO45().setValue(false);
			}
		}

		// activate tabTNM
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().setHeaderVisible(isEnabled);

//		if (!isEnabled)
//			form.lyrConfig().tabTGroup().lyrGroupDetails().showtabSpecialty();
		// activate tabTNM
		form.lyrConfig().tabTNM().setHeaderVisible(isEnabled);
		form.lyrConfig().tabTNM().setHeaderEnabled(isEnabled);
		form.lyrConfig().tabTNM().setEnabled(isEnabled);
		form.lyrConfig().tabTNM().chkActiveTNM().setValue(true);
		// form.lyrConfig().tabTNM().chkActiveTNM().setValue(isEnabled);
		displayTNMValueMappingsTab(!isEnabled);
		initialiseTNMDynamicGrid(false);

	}

	private void displayTNMValueMappingsTab(boolean isEnabled)
	{
		// Enable Taxonomy tab
		form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().setHeaderVisible(isEnabled);
		if (!isEnabled)
		{
			// Clear tab
			clearTNMMappingsTab();
		}
		form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().customTNMMappings().setComponentMode(form.getMode());

	}

	private void clearTNMMappingsTab()
	{
		form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().txtTNMDescription().setValue(null);
		form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().txtTNMValue().setValue(null);
		// form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().customTNMMappings().setValue(null);
	}

	private boolean checkIfGroupHaveSiteWhoHaveTNM()
	{
		TumourSiteListVoCollection voCollSiteList = domain.getSiteWhoHasTNM((TumourGroupRefVo) form.getLocalContext().getSelectedRecord());
		String err = "";

		if (voCollSiteList.size() == 0)
		{
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().setHeaderVisible(false);
//			form.lyrConfig().tabTGroup().lyrGroupDetails().showtabSpecialty();
			form.lyrConfig().tabTNM().setHeaderVisible(false);
			// deactivate tabSerumMarker
			form.lyrConfig().tabSerumMarker().setHeaderVisible(false);
		}
		else
		{
			for (int i = 0; i < voCollSiteList.size(); i++)
			{
				// Get names of the sites
				err += voCollSiteList.get(i).getName();
				// Add ", " at the end of name
				if (i < voCollSiteList.size() - 1)
					err += ", ";
			}

			err += ERR_HAVE_TNM;
			// Display Warning msg
			displayErrorMessage(err, true);

			return true;
		}
		return false;
	}

	@Override
	protected void onChkOtherClassificationsValueChanged() throws PresentationLogicException
	{
//		if (form.lyrConfig().tabTGroup().chkOtherClassifications().getValue())
//		{
			// activate tabClassification
//			form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().setHeaderVisible(true);
//			form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().setHeaderEnabled(true);
//			form.lyrConfig().tabTGroup().lyrGroupDetails().showtabClassification();
//			form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().clear();
//		}
//		else
//		{
//			form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().setHeaderVisible(false);
//			form.lyrConfig().tabTGroup().lyrGroupDetails().showtabSpecialty();
//		}

		updateControlsState();
	}

	@Override
	protected void onChkReqSerumMarkersValueChanged() throws PresentationLogicException
	{
		if (form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqSerumMarkers().getValue())
		{
			form.lyrConfig().tabSerumMarker().setHeaderVisible(true);
			form.lyrConfig().tabSerumMarker().setEnabled(true);
		}
		else
		{
			if (form.getLocalContext().getSelectedRecordIsNotNull())
			{
				if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
				{
					if (form.getLocalContext().getHasOverallIsNotNull() && form.getLocalContext().getHasOverall() == true && ((TumourGroupVo) form.getLocalContext().getSelectedRecord()).getTnmRequiresSMarkersIsNotNull() && ((TumourGroupVo) form.getLocalContext().getSelectedRecord()).getTnmRequiresSMarkers())
					{
						displayErrorMessage("An Overall configuration exists!", true);
						form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqSerumMarkers().setValue(true);
					}
				}
			}
		}
	}

	@Override
	protected void onChkSiteSpecificTNMValueChanged() throws PresentationLogicException
	{
		if (!checkIfGroupSupportsTNMStaging())
			return;

		if (form.lyrConfig().tabTSite().chkSiteSpecificTNM().getValue())
		{
			initializeTabTNM(true);
		}
		else
		{
			if (form.getLocalContext().getSelectedRecordIsNotNull())
			{
				if (form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
				{
					if (form.getLocalContext().getHasOverallIsNotNull() && form.getLocalContext().getHasOverall())
					{
						displayErrorMessage("An Overall configuration exists!", true);
						form.lyrConfig().tabTSite().chkSiteSpecificTNM().setValue(true);
					}
					else
					{
						initializeTabTNM(false);
					}
				}
			}
		}
	}

	private boolean groupSupportsTNMStaging()
	{

		TumourGroupListVo voGroupList = null;

		if (form.getLocalContext().getSelectedNode() instanceof TumourGroupListVo)
		{
			voGroupList = (TumourGroupListVo) form.customTree().getSelectedNod();
		}
		else if (form.getLocalContext().getSelectedNode() instanceof TumourCategoryListVo)
		{
			voGroupList = (TumourGroupListVo) form.customTree().getParentNod();
		}
		else if (form.getLocalContext().getSelectedNode() instanceof TumourSiteListVo)
		{
			voGroupList = (TumourGroupListVo) form.customTree().getParentNod();
		}

		if (voGroupList != null && voGroupList.getHasTNMIsNotNull() && voGroupList.getHasTNM())
		{
			return true;
		}

		return false;
	}

	@Override
	protected void onContextMenuItemClick(int menuItemID, Control sender) throws PresentationLogicException
	{
		if (sender instanceof TreeView)
		{
			switch (menuItemID)
			{
				case GenForm.ContextMenus.GenericGrid.Update:
					updateSpecialty();

					break;
				case GenForm.ContextMenus.GenericGrid.Remove:
					removeSpecialty();
					updateGenericContextMenu();
					break;
				case GenForm.ContextMenus.OncologyNamespace.TumourGroupOtherClassification.UpdateClassification:
					updateOtherClassification();
					break;
				case GenForm.ContextMenus.OncologyNamespace.TumourGroupOtherClassification.RemoveClassification:
					removeOtherClassification();
					break;
			}
			enableClassificationContextMenu(Boolean.TRUE);//WDEV-16926
		}
		
		// This is only for the Histology 
		switch (menuItemID)
		{
			case GenForm.ContextMenus.ClinicalAdminNamespace.TumourGroupHistologyGrade.ADD:
				addDifferentation();
				updateGenericContextMenu();
				break;
				
			case GenForm.ContextMenus.ClinicalAdminNamespace.TumourGroupHistologyGrade.INACTIVATE:
				inactivateDifferentation();
				updateGenericContextMenu();
				break;
				
			case GenForm.ContextMenus.ClinicalAdminNamespace.TumourGroupHistologyGrade.REACTIVATE:
				reactivateDifferentation();
				updateGenericContextMenu();
				break;
				
			case GenForm.ContextMenus.ClinicalAdminNamespace.TumourGroupHistologyGrade.LOAD_DEFAULTS:
				loadDefaultDifferentation();
				updateGenericContextMenu();
				break;
				
			case GenForm.ContextMenus.ClinicalAdminNamespace.TumourGroupPrognosticLocation.ADD:
				addPrognosticLocation();
				break;
				
			case GenForm.ContextMenus.ClinicalAdminNamespace.TumourGroupPrognosticLocation.REMOVE:
				removePrognosticLocation();
				updatePrognosticsContextMenu();
				break;
				
			case GenForm.ContextMenus.ClinicalAdminNamespace.TumourGroupPrognosticRisk.ADD:
				addPrognosticRisk();
				break;
				
			case GenForm.ContextMenus.ClinicalAdminNamespace.TumourGroupPrognosticRisk.REMOVE:
				removePrognostickRisk();
				updatePrognosticsContextMenu();
				break;
				
			case GenForm.ContextMenus.ClinicalAdminNamespace.TumourGroupPrognosticPSA.ADD:
				addPrognosticPSA();
				break;
				
			case GenForm.ContextMenus.ClinicalAdminNamespace.TumourGroupPrognosticPSA.REMOVE:
				removePrognosticPSA();
				updatePrognosticsContextMenu();
				break;
				
			case GenForm.ContextMenus.ClinicalAdminNamespace.TumourGroupPrognosticGleason.ADD:
				addPrognosticGleason();
				break;
				
			case GenForm.ContextMenus.ClinicalAdminNamespace.TumourGroupPrognosticGleason.REMOVE:
				removePrognosticGleason();
				updatePrognosticsContextMenu();
				break;
		}

		if (sender instanceof DynamicGrid)
		{
			switch (menuItemID)
			{
				case GenForm.ContextMenus.TumourCategoryTNM.AddTNM:
					addTNM();
					break;
				case GenForm.ContextMenus.TumourCategoryTNM.InactivateTNM:
					inactivateTNM();
					enableTNMContextMenu(true);//WDEV-17680
					break;
				case GenForm.ContextMenus.TumourCategoryTNM.ActivateTNM:
					activateTNM();
					enableTNMContextMenu(true); //WDEV-17680
					break;
				case GenForm.ContextMenus.GenericGrid.Add:
					break;
				case GenForm.ContextMenus.GenericGrid.Remove:
					break;
			}
		}

		if (sender instanceof Grid)
		{
			switch (menuItemID)
			{
				case GenForm.ContextMenus.OncologyNamespace.TumourHistologyLayer.ADD:
					addHistology();
					break;
				case GenForm.ContextMenus.OncologyNamespace.TumourHistologyLayer.SELECTFROMTAXONOMY:
					selectHistologyFromTaxonomy();
					break;
				case GenForm.ContextMenus.OncologyNamespace.TumourHistologyLayer.REMOVE:
					removeHistology();
					break;
				case GenForm.ContextMenus.OncologyNamespace.TumourHistologyLayer.REACTIVATE:
					reactivateHistology();
					break;
					
				case GenForm.ContextMenus.OncologyNamespace.TumourSerumMarkers.ADD:
					addSerum();
					break;
				case GenForm.ContextMenus.OncologyNamespace.TumourSerumMarkers.SLECTFROMTAXONOMY:
					selectSerumFromTaxonomy();
					break;
				case GenForm.ContextMenus.OncologyNamespace.TumourSerumMarkers.REMOVE:
					removeSerum();
					break;
			}
		}
	}

	private void removePrognosticGleason()
	{
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGleason().grdGleason().removeSelectedRow();
	}

	private void addPrognosticGleason()
	{
		engine.open(form.getForms().ClinicalAdmin.SelectPrognosticGleason);
	}

	private void removePrognosticPSA()
	{
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPagePSA().grdPSA().removeSelectedRow();
	}

	private void addPrognosticPSA()
	{
		engine.open(form.getForms().ClinicalAdmin.SelecPrognosticPSA);
	}

	private void removePrognostickRisk()
	{
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageRiskCategory().grdRiskCategory().removeSelectedRow();
	}

	private void addPrognosticRisk()
	{
		engine.open(form.getForms().ClinicalAdmin.SelectPrognosticRiskAssessment);
	}

	private void removePrognosticLocation()
	{
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageTumourLocation().grdPrognosticLocation().removeSelectedRow();
	}

	private void addPrognosticLocation()
	{
		engine.open(form.getForms().ClinicalAdmin.SelectPrognosticLocation);
	}

	private void loadDefaultDifferentation()
	{
		// Get default values
		HistopathologicGradeVoCollection defaultHistologyGrades = domain.listDefaultDifferentiations();
		
		// Add values to dynamic grid
		for (HistopathologicGradeVo histologyGrade : defaultHistologyGrades)
		{
			if (histologyGrade == null)
				continue;
			
			// Create a new TumourGroupDiferentiation
			TumourGroupHistopathologyGradeVo record = new TumourGroupHistopathologyGradeVo();
			record.setTumourDifferentation(histologyGrade);
			record.setIsActive(Boolean.TRUE);
			
			// Create a new Histology Grade
			DynamicGridRow row = form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getRows().newRow();

			DynamicGridCell diffCell = row.getCells().newCell(getDiffColumn(COLDIFF), DynamicCellType.STRING);
			diffCell.setValue(histologyGrade.getTumourDifferentation());
			diffCell.setIdentifier(histologyGrade);
			
			diffCell = row.getCells().newCell(getDiffColumn(COLGRADE), DynamicCellType.STRING);
			diffCell.setValue(histologyGrade.getGrade());
			
			row.setValue(record);
		}
	}

	// WDEV-11684
	private void reactivateHistology()
	{
		if (form.lyrConfig().tabHistologyType().grdHistology().getValue() != null)
		{
			form.lyrConfig().tabHistologyType().grdHistology().getValue().setIsActive(Boolean.TRUE);
			form.lyrConfig().tabHistologyType().grdHistology().getSelectedRow().setTextColor(Color.Black);
		}
		
		updateHistologyContextMenu();
	}

	private void removeOtherClassification()
	{
		TreeNode selectedNode = form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getSelectedNode();

		for (int i = 0; form.getLocalContext().getOtherClassificationSavedCollectionIsNotNull() && i < form.getLocalContext().getOtherClassificationSavedCollection().size(); i++)
		{
			TumourGroupClassificationVo voClass = form.getLocalContext().getOtherClassificationSavedCollection().get(i);

			if (voClass.getID_TumourGroupClassificationIsNotNull() // Is a saved record
					&& selectedNode.getValue() != null // Is a saved record in the tree too
					&& voClass.getID_TumourGroupClassification().equals(((TumourGroupClassificationVo) selectedNode.getValue()).getID_TumourGroupClassification()))// Same record
			{
				voClass.setIsActive(false);

				form.getLocalContext().getOtherClassificationSavedCollection().set(i, voClass);
			}
		}

		form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().remove(selectedNode);
	}

	private void removeSpecialty()
	{
		TreeNode selectedNode = form.lyrConfig().tabSpecialties().treSpecialty().getSelectedNode();

		for (int i = 0; form.getLocalContext().getSpecialtiesSavedCollectionIsNotNull() && i < form.getLocalContext().getSpecialtiesSavedCollection().size(); i++)
		{
			TumourGroupSpecialtyVo voSpec = form.getLocalContext().getSpecialtiesSavedCollection().get(i);

			if (voSpec.getID_TumourGroupSpecialtyIsNotNull() // Is a saved record
					&& selectedNode.getValue() != null // Is a saved record in the tree too
					&& voSpec.getID_TumourGroupSpecialty().equals(((TumourGroupSpecialtyVo) selectedNode.getValue()).getID_TumourGroupSpecialty()))// Same record
			{
				voSpec.setIsActive(false);

				form.getLocalContext().getSpecialtiesSavedCollection().set(i, voSpec);
			}
		}

		form.lyrConfig().tabSpecialties().treSpecialty().getNodes().remove(selectedNode);

	}

	private void updateOtherClassification()
	{
		StagingClassificationVoCollection voColl = new StagingClassificationVoCollection();
		int size = form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().size();

		if (size != 0)
		{
			for (int i = 0; i < form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().size(); i++)
			{
				if (form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().get(i).getValue() instanceof StagingClassificationVo)
					voColl.add((StagingClassificationVo) form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().get(i).getValue());
				else if (form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().get(i).getValue() instanceof TumourGroupClassificationVo)
					voColl.add(((TumourGroupClassificationVo) form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getNodes().get(i).getValue()).getClassification());
			}
		}

		form.getGlobalContext().ClinicalAdmin.setTumourGroupOtherClassification(voColl);
		engine.open(form.getForms().ClinicalAdmin.TumourOtherClassification);
	}

	private void selectSerumFromTaxonomy()
	{
		engine.open(form.getForms().Core.TaxonomySearch);
	}

	private void removeSerum()
	{
		if (form.lyrConfig().tabSerumMarker().grdSerumMarkers().getSelectedRow() != null)
		{
			if (form.getLocalContext().getSelectedSerumCollectionIsNotNull() && form.getLocalContext().getSelectedSerumCollection().size() > 0)
			{
				TumourSerumMarkersLiteVoCollection voCollSerum = form.getLocalContext().getSelectedSerumCollection();
				for (int i = 0; i < voCollSerum.size(); i++)
				{
					if (voCollSerum.get(i).equals(form.lyrConfig().tabSerumMarker().grdSerumMarkers().getSelectedRow().getValue()))
					{
						voCollSerum.get(i).setIsActive(false);
						break;
					}
				}

				form.lyrConfig().tabSerumMarker().grdSerumMarkers().removeSelectedRow();

				form.getLocalContext().setSelectedSerumCollection(voCollSerum);
			}
			else
			{
				form.lyrConfig().tabSerumMarker().grdSerumMarkers().removeSelectedRow();
			}

			updateSerumContextMenu();
		}
	}

	// WDEV-11684
	private void addHistology()
	{
		engine.open(form.getForms().ClinicalAdmin.SelectTumourHistology);
	}

	private void addSerum()
	{
		engine.open(form.getForms().ClinicalAdmin.SelectSerumMarker);
	}

	private void selectHistologyFromTaxonomy()
	{
		engine.open(form.getForms().Core.TaxonomySearch);
	}

	private void inactivateDifferentation()
	{
		if (form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getValue() instanceof TumourGroupHistopathologyGradeVo)
		{
			((TumourGroupHistopathologyGradeVo) form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getValue()).setIsActive(Boolean.FALSE);
			form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getSelectedRow().setTextColor(Color.Gray);
		}
	}

	private void reactivateDifferentation()
	{
		if (form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getValue() instanceof TumourGroupHistopathologyGradeVo)
		{
			((TumourGroupHistopathologyGradeVo) form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getValue()).setIsActive(Boolean.TRUE);
			form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getSelectedRow().setTextColor(Color.Black);
		}
	}


	
	// WDEV-11684
	private void removeHistology()
	{
		if (form.lyrConfig().tabHistologyType().grdHistology().getValue() != null)
		{
			form.lyrConfig().tabHistologyType().grdHistology().getValue().setIsActive(Boolean.FALSE);
			form.lyrConfig().tabHistologyType().grdHistology().getSelectedRow().setTextColor(Color.Gray);
		}
		
		if (form.lyrConfig().tabHistologyType().grdHistology().getSelectedRow() != null)
		{
			if (form.getLocalContext().getSelectedHistologyCollectionIsNotNull() && form.getLocalContext().getSelectedHistologyCollection().size() > 0)
			{
				TumourGroupHistologyVoCollection voCollHistology = form.getLocalContext().getSelectedHistologyCollection();
				for (int i = 0; i < voCollHistology.size(); i++)
				{
					if (voCollHistology.get(i).equals(form.lyrConfig().tabHistologyType().grdHistology().getSelectedRow().getValue()))
					{
						voCollHistology.get(i).setIsActive(false);
						break;
					}
				}


				form.getLocalContext().setSelectedHistologyCollection(voCollHistology);
			}

			updateHistologyContextMenu();
		}
	}

	private void addDifferentation()
	{
		engine.open(form.getForms().ClinicalAdmin.SelectHistopathologicGrade);
	}

	private void activateTNM()
	{
		if (form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getSelectedRow() == null)
			return;

		DynamicGridRow rowSelected = form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getSelectedRow();

		if (!form.lyrConfig().tabTNM().chkActiveTNM().getValue())
			rowSelected.getCells().get(getColumn(COLACTIVE)).setValue(YesNo.YES);

		rowSelected.setBackColor(Color.Default);
		
		//WDEV-17680
		if (rowSelected.getValue() instanceof TumourGroupSiteTNMValueVo && ((TumourGroupSiteTNMValueVo)rowSelected.getValue()).getID_TumourGroupSiteTNMValue() == null)
		{
			rowSelected.setReadOnly(false);
		}
		else
			rowSelected.setReadOnly(true);
		
		Object value = form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getSelectedRow().getValue();
		rowSelected.setValue(value);

		if (value instanceof TumourGroupSiteTNMValueVo)
		{
			TumourGroupSiteTNMValueVo vo = (TumourGroupSiteTNMValueVo) value;
			vo.setIsActive(Boolean.TRUE);
		}

		// rowSelected.setTooltip("This record was marked as inactive!");
	}

	private void enableTNMContextMenu(Boolean isEnable)
	{
		boolean selectedRow = form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getSelectedRow() != null;
		boolean isEditMode = form.getMode().equals(FormMode.EDIT);

		form.getContextMenus().getTumourCategoryTNMAddTNMItem().setVisible(isEnable.booleanValue() && isEditMode);
		// Show INACTIVATE if record is active
		form.getContextMenus().getTumourCategoryTNMInactivateTNMItem().setVisible(isEnable.booleanValue() && selectedRow && !returnTypeOfRecord() && isEditMode);
		// Show ACTIVATE if record is inactive
		form.getContextMenus().getTumourCategoryTNMActivateTNMItem().setVisible(isEnable.booleanValue() && selectedRow && returnTypeOfRecord() && isEditMode);
	}

	private void updateGenericContextMenu()
	{
		updateHistologyGradeContextMenu();

		boolean isTabSpecialityVisible = form.lyrConfig().tabSpecialties().isVisible();

		boolean isTabHistologyGradeVisible = form.lyrConfig().tabHistologyGrade().isVisible();

		boolean isEditMode = form.getMode().equals(FormMode.EDIT);

		form.getContextMenus().hideAllGenericGridMenuItems();
		if (!isEditMode || (!isTabHistologyGradeVisible && !isTabSpecialityVisible))
			return;

		boolean isDifferentationRecordSelected = form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getSelectedRow() != null;
		boolean isSpecialityRecordSelected = form.lyrConfig().tabSpecialties().treSpecialty().getSelectedNode() != null;

		form.getContextMenus().getGenericGridAddItem().setText("Add Histology Grade");
		form.getContextMenus().getGenericGridUpdateItem().setText("Update Specialty");//WDEV-16926
		form.getContextMenus().getGenericGridRemoveItem().setText(isTabSpecialityVisible ? "Remove Specialty" : "Remove Histology Grade");//WDEV-16926
		form.getContextMenus().getGenericGridUpdateItem().setVisible(isTabSpecialityVisible);
		form.getContextMenus().getGenericGridAddItem().setVisible(isTabHistologyGradeVisible);
		form.getContextMenus().getGenericGridRemoveItem().setVisible((isTabSpecialityVisible && isSpecialityRecordSelected) || (isTabHistologyGradeVisible && isDifferentationRecordSelected));
		form.getContextMenus().getGenericGridRemoveItem().setEnabled(true);
	}

	/**
	 * Function used to update the state for histology grade context menu
	 * Options should only visible when editing a TumourGroup (for is in EDIT mode)
	 * Additional conditions for each context option may apply
	 */
	private void updateHistologyGradeContextMenu()
	{
		form.getContextMenus().ClinicalAdmin.getTumourGroupHistologyGradeADDItem().setVisible(FormMode.EDIT.equals(form.getMode()));
		form.getContextMenus().ClinicalAdmin.getTumourGroupHistologyGradeINACTIVATEItem().setVisible(FormMode.EDIT.equals(form.getMode()) 
						&& form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getSelectedRow() != null
						&& form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getValue() instanceof TumourGroupHistopathologyGradeVo
						&& Boolean.TRUE.equals(((TumourGroupHistopathologyGradeVo)form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getValue()).getIsActive()));
		
		form.getContextMenus().ClinicalAdmin.getTumourGroupHistologyGradeREACTIVATEItem().setVisible(FormMode.EDIT.equals(form.getMode()) 
                    	&& form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getSelectedRow() != null
                    	&& form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getValue() instanceof TumourGroupHistopathologyGradeVo
                    	&& Boolean.FALSE.equals(((TumourGroupHistopathologyGradeVo)form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getValue()).getIsActive()));
		
		form.getContextMenus().ClinicalAdmin.getTumourGroupHistologyGradeLOAD_DEFAULTSItem().setVisible(FormMode.EDIT.equals(form.getMode()) 
						&& form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getRows().size() == 0);
	}

	private void updateHistologyContextMenu()
	{
		// WDEV-11684
		form.getContextMenus().Oncology.getTumourHistologyLayerREMOVEItem().setVisible(FormMode.EDIT.equals(form.getMode())
																						&& form.lyrConfig().tabHistologyType().grdHistology().getValue() != null
																						&& Boolean.TRUE.equals(form.lyrConfig().tabHistologyType().grdHistology().getValue().getIsActive()));
		
		form.getContextMenus().Oncology.getTumourHistologyLayerREACTIVATEItem().setVisible(FormMode.EDIT.equals(form.getMode())
																						&& form.lyrConfig().tabHistologyType().grdHistology().getValue() != null
																						&& Boolean.FALSE.equals(form.lyrConfig().tabHistologyType().grdHistology().getValue().getIsActive()));
	}

	private void updateSerumContextMenu()
	{
		form.getContextMenus().Oncology.getTumourSerumMarkersREMOVEItem().setVisible(form.lyrConfig().tabSerumMarker().grdSerumMarkers().getSelectedRow() != null
																							&& FormMode.EDIT.equals(form.getMode())
																							&& !Boolean.TRUE.equals(form.getLocalContext().getHasOverall()));
	}

	// Return type of record: active or inactive
	private boolean returnTypeOfRecord()
	{
		DynamicGridRow rowSelected = form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getSelectedRow();

		if ((!form.lyrConfig().tabTNM().chkActiveTNM().getValue() && rowSelected.getCells().get(getColumn(COLACTIVE)).getValue().equals(YesNo.NO)) || (form.lyrConfig().tabTNM().chkActiveTNM().getValue() && !((TumourGroupSiteTNMValueVo) rowSelected.getValue()).getIsActive()))
		{
			return true;
		}

		return false;
	}

	private void inactivateTNM()
	{
		if (form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getSelectedRow() == null)
			return;

		DynamicGridRow rowSelected = form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getSelectedRow();

		if (!form.lyrConfig().tabTNM().chkActiveTNM().getValue())
			rowSelected.getCells().get(getColumn(COLACTIVE)).setValue(YesNo.NO);

		rowSelected.setBackColor(Color.Red);
		rowSelected.setReadOnly(true);
		Object value = form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getSelectedRow().getValue();
		rowSelected.setValue(value);

		if (value instanceof TumourGroupSiteTNMValueVo)
		{
			TumourGroupSiteTNMValueVo vo = (TumourGroupSiteTNMValueVo) value;
			vo.setIsActive(Boolean.FALSE);
		}

		// rowSelected.setTooltip("This record was marked as inactive!");
	}

	private void addTNM()
	{
		TumourGroupSiteTNMValueVo vo = new TumourGroupSiteTNMValueVo();
		vo.setIsActive(Boolean.TRUE);

		if (form.lyrConfig().tabTNM().chkActiveTNM().getValue())
		{
			addDynGridRow(vo, true);
		}
		else
		{
			addDynGridRow(vo, false);
		}
	}

	@Override
	protected void onRadioButtonGroupTNMValuesValueChanged() throws PresentationLogicException
	{
		populateDataFromValuesTabs(form.getLocalContext().getCurrentSelectedTab());

		displaySelectedTNMType(form.lyrConfig().tabTNM().GroupTNMValues().getValue());

		form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().setHeaderVisible(false);
		form.lyrConfig().tabTNM().lyrTNM().showtabTNMValues();

	}

	private void displaySelectedTNMType(GroupTNMValuesEnumeration option)
	{
		if (!form.getLocalContext().getSelectedRecordIsNotNull())
			return;

		ValueObject value = form.getLocalContext().getSelectedRecord();
		TumourGroupSiteTNMValueVoCollection voCollTNM = null;

		if (value instanceof TumourGroupVo)
		{
			voCollTNM = ((TumourGroupVo) form.getLocalContext().getSelectedRecord()).getTNMValues();
		}
		else if (value instanceof TumourSiteVo)
		{
			voCollTNM = ((TumourSiteVo) form.getLocalContext().getSelectedRecord()).getTNMValues();
		}

		populateScreenFromDataForLyrConfigTabTNM(voCollTNM, option, form.lyrConfig().tabTNM().chkActiveTNM().getValue());
	}

	@Override
	protected void onChkActiveTNMValueChanged() throws PresentationLogicException
	{
		if (form.getMode().equals(FormMode.VIEW))
		{
			if (!form.lyrConfig().tabTNM().chkActiveTNM().getValue())
			{
				// Reinitialize dynGrid: add new Active coll
				initialiseTNMDynamicGrid(true);

				if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
				{
					populateScreenFromDataForLyrConfigTabTNM(((TumourGroupVo) form.getLocalContext().getSelectedRecord()).getTNMValues(), form.lyrConfig().tabTNM().GroupTNMValues().getValue(), false);
				}
				else if (form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
				{
					populateScreenFromDataForLyrConfigTabTNM(((TumourSiteVo) form.getLocalContext().getSelectedRecord()).getTNMValues(), form.lyrConfig().tabTNM().GroupTNMValues().getValue(), false);
				}
			}
			else
			{
				// Reinitialize dynGrid: add new Active coll
				initialiseTNMDynamicGrid(false);

				if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
				{
					populateScreenFromDataForLyrConfigTabTNM(((TumourGroupVo) form.getLocalContext().getSelectedRecord()).getTNMValues(), form.lyrConfig().tabTNM().GroupTNMValues().getValue(), true);
				}
				else if (form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
				{
					populateScreenFromDataForLyrConfigTabTNM(((TumourSiteVo) form.getLocalContext().getSelectedRecord()).getTNMValues(), form.lyrConfig().tabTNM().GroupTNMValues().getValue(), true);
				}
			}
		}
	}

	// Initialize TNM dynamic grid (with/without col Acticve)
	private void initialiseTNMDynamicGrid(boolean withActiveColl)
	{
		form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().clear();

		DynamicGridColumn colType = form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getColumns().newColumn("Type", COLTYPE);
		colType.setWidth(40);
		colType.setReadOnly(true);
		colType.setCanGrow(true);

		DynamicGridColumn colTNM = form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getColumns().newColumn("TNM Value", COLTNM);
		colTNM.setWidth(100);
		colTNM.setReadOnly(true);

		DynamicGridColumn colCPB = form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getColumns().newColumn("CPB", COLCPB);
		colCPB.setWidth(140);
		colCPB.setReadOnly(true);

		DynamicGridColumn colTNBDescription = form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getColumns().newColumn("TNM Description", COLTNMDESCRIPTION);
		colTNBDescription.setWidth(-1);
		colTNBDescription.setReadOnly(true);

		if (withActiveColl)
		{
			DynamicGridColumn colActive = form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getColumns().newColumn("Active", COLACTIVE);
			colActive.setWidth(-1);
		}
	}

	// Initialize Differentiation dynamic grid
	private void initialiseDifferentationDynamicGrid()
	{
		form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().clear();
		
		DynamicGridColumn colDiff = form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getColumns().newColumn("Grade", COLGRADE);
		colDiff.setWidth(150);

		colDiff = form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getColumns().newColumn("Description", COLDIFF);
		colDiff.setWidth(-1);
	}

	@Override
	protected void onDynTNMRowSelectionChanged(DynamicGridRow row)
	{
		if (form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getSelectedRow() != null)
		{
			enableTNMContextMenu(Boolean.TRUE);

			// Enable Taxonomy tab
			displayTNMValueMappingsTab(true);
			TumourGroupSiteTNMValueVo rowValue = (TumourGroupSiteTNMValueVo) row.getValue();
			form.getLocalContext().setSelectedTNMRecord((TumourGroupSiteTNMValueVo) row.getValue());
			populateScreenFromDataForTNMValueMappingsTab(rowValue);
		}
		else
		{
			displayTNMValueMappingsTab(true);
			return;
		}
	}

	protected final void bindTNMTypeLookup(DynamicGridCell typeCell)
	{
		TNMTypeCollection lookupCollection = LookupHelper.getTNMType(domain.getLookupService());
		for (int x = 0; x < lookupCollection.size(); x++)
		{
			typeCell.getItems().newItem(lookupCollection.get(x), lookupCollection.get(x).getText(), lookupCollection.get(x).getImage(), lookupCollection.get(x).getTextColor());
		}
	}

	protected final void bindTNMClinicalpathologicalLookup(DynamicGridCell typeCell)
	{
		TNMClinicalpathologicalCollection lookupCollection = LookupHelper.getTNMClinicalpathological(domain.getLookupService());
		for (int x = 0; x < lookupCollection.size(); x++)
		{
			typeCell.getItems().newItem(lookupCollection.get(x), lookupCollection.get(x).getText(), lookupCollection.get(x).getImage(), lookupCollection.get(x).getTextColor());
		}
	}

	protected final void bindYesNoLookup(DynamicGridCell typeCell)
	{
		YesNoCollection lookupCollection = ims.core.vo.lookups.LookupHelper.getYesNo(domain.getLookupService());
		for (int x = 0; x < lookupCollection.size(); x++)
		{
			typeCell.getItems().newItem(lookupCollection.get(x), lookupCollection.get(x).getText(), lookupCollection.get(x).getImage(), lookupCollection.get(x).getTextColor());
		}
	}

	private void updateSpecialty()
	{
		SpecialtyCollection lkpCollSpecialties = ims.core.vo.lookups.LookupHelper.getSpecialty(domain.getLookupService());
		SpecialtyCollection coll = new SpecialtyCollection();

		if (lkpCollSpecialties != null)
		{
			for (int i = 0; i < form.lyrConfig().tabSpecialties().treSpecialty().getNodes().size(); i++)
			{
				for (int x = 0; x < lkpCollSpecialties.size(); x++)
				{
					if (form.lyrConfig().tabSpecialties().treSpecialty().getNodes().get(i).getText().equals(lkpCollSpecialties.get(x).getText()))
						coll.add(lkpCollSpecialties.get(x));
				}

			}
		}

		form.getGlobalContext().Core.setSpecialties(coll);
		engine.open(form.getForms().ClinicalAdmin.HotlistDialog);
	}

	// WDEV-11684
	private void addHistology(TumourHistologyLiteVo tumourHistology)
	{
		if (tumourHistology == null)
			return;
		
		// Check if the histology exists
		if (histologyExists(tumourHistology))
		{
			engine.showMessage("Selected histology already exists");
			return;
		}
		
		// Create a new TumourGroupHistology
		TumourGroupHistologyVo histology = new TumourGroupHistologyVo();
		
		histology.setAssociatedHistology(tumourHistology);
		histology.setIsActive(Boolean.TRUE);
		
		// Create a new row in histology
		grdHistologyRow histologyRow = form.lyrConfig().tabHistologyType().grdHistology().getRows().newRow(true);
		
		histologyRow.setColHistology(histology.getAssociatedHistology().getHistologyDescription());
		histologyRow.setValue(histology);
	}
	
	private void addPrognosticGleason(GleasonConfigLiteVo gleason)
	{
		if (gleason == null)
			return;
		
		if (gleasonExits(gleason))
		{
			engine.showMessage("Gleason record is already associated");
			return;
		}
		
		// Create a new gleason row
		grdGleasonRow gleasonRow = form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGleason().grdGleason().getRows().newRow();
		
		gleasonRow.setColGleason(gleason.getGleasonName());
		
		gleasonRow.setValue(gleason);
	}

	private void addPrognosticPSA(PSAConfigVo prognosticPSA)
	{
		if (prognosticPSA == null)
			return;
		
		if (prognosticPSAExists(prognosticPSA))
		{
			engine.showMessage("PSA record is already associated");
			return;
		}
		
		grdPSARow psaRow = form.lyrConfig().tabTGroup().lyrGroupDetails().tabPagePSA().grdPSA().getRows().newRow();
		
		psaRow.setColPSA(prognosticPSA.getPSAName());
		
		psaRow.setValue(prognosticPSA);
	}

	private void addPrognosticRisk(PrognosticRiskConfigVo riskCategory)
	{
		if (riskCategory == null)
			return;
		
		if (riskCategoryExits(riskCategory))
		{
			engine.showMessage("Risk Category record is already associated");
			return;
		}
		
		grdRiskCategoryRow riskRow = form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageRiskCategory().grdRiskCategory().getRows().newRow();
		
		riskRow.setColRiskCategory(riskCategory.getRiskName());
		
		riskRow.setValue(riskCategory);
	}

	private void addPrognosticLocation(PrognosticLocationConfigVo location)
	{
		if (location == null)
			return;
		
		if (locationExists(location))
		{
			engine.showMessage("Location record is already associated");
			return;
		}
		
		grdPrognosticLocationRow locationRow = form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageTumourLocation().grdPrognosticLocation().getRows().newRow();
		
		locationRow.setColTumourLocation(location.getLocationName());
		
		locationRow.setValue(location);
	}

	private void addSerumMarker(TumourSerumMarkersLiteVo serumMarker)
	{
		if (serumMarker == null)
			return;
		
		// Check if the serum marker exits
		// The following function will throw a CodingRuntimeException if the serum marker exits
		if (serumMarkerExists(serumMarker))
		{
			engine.showMessage("Selected serum marker alredy exits");
			return;
		}
		
		// Create a new Serum Marker row
		grdSerumMarkersRow serumRow = form.lyrConfig().tabSerumMarker().grdSerumMarkers().getRows().newRow();
		
		serumRow.setColValue(serumMarker.getSerumMarkerValue());
		serumRow.setColDescription(serumMarker.getSerumMarkerDescription());
		
		serumRow.setValue(serumMarker);
	}
	
	private void addHistologyGrade(HistopathologicGradeVo histologyGrade)
	{
		if (histologyGrade == null)
			return;
		
		// Check if the histology grade exists
		// The following function will throw a CodingRuntimeException if the histology Grade is null
		if (histologyGradeExists(histologyGrade))
		{
			engine.showMessage("Selected histology grade already exists");
			return;
		}
		
		// Create a new TumourGroupDiferentiation
		TumourGroupHistopathologyGradeVo record = new TumourGroupHistopathologyGradeVo();
		record.setTumourDifferentation(histologyGrade);
		record.setIsActive(Boolean.TRUE);
		
		// Create a new Histology Grade
		DynamicGridRow row = form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getRows().newRow();

		DynamicGridCell diffCell = row.getCells().newCell(getDiffColumn(COLDIFF), DynamicCellType.STRING);
		diffCell.setValue(histologyGrade.getTumourDifferentation());
		diffCell.setIdentifier(histologyGrade);
		
		diffCell = row.getCells().newCell(getDiffColumn(COLGRADE), DynamicCellType.STRING);
		diffCell.setValue(histologyGrade.getGrade());
		
		row.setValue(record);
	}

	// WDEV-11684
	private boolean histologyExists(TumourHistologyLiteVo histology)
	{
		if (histology == null)
			throw new CodingRuntimeException("Logical Error - NULL value passed to expected value parameter");
		
		TumourGroupHistologyVoCollection tumourHistologiesCollection = form.lyrConfig().tabHistologyType().grdHistology().getValues();
		
		for (TumourGroupHistologyVo linkedHistology : tumourHistologiesCollection)
		{
			if (histology.equals(linkedHistology.getAssociatedHistology()))
				return true;
		}

		return false;
	}

	private boolean locationExists(PrognosticLocationConfigVo location)
	{
		if (location == null)
			throw new CodingRuntimeException("Logical Error - NULL value passed to expected value parameter");
		
		for (int i = 0; i < form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageTumourLocation().grdPrognosticLocation().getRows().size(); i++)
		{
			PrognosticLocationConfigVo prognosticLocation = form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageTumourLocation().grdPrognosticLocation().getRows().get(i).getValue();
			
			if (location.equals(prognosticLocation))
				return true;
		}

		return false;
	}

	private boolean gleasonExits(GleasonConfigLiteVo gleason)
	{
		if (gleason == null)
			throw new CodingRuntimeException("Logical Error - NULL value passed to expected value parameter");
		
		for (int i = 0; i < form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGleason().grdGleason().getRows().size(); i++)
		{
			GleasonConfigLiteVo gleasonValue = form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGleason().grdGleason().getRows().get(i).getValue();
			
			if (gleason.equals(gleasonValue))
				return true;
		}

		return false;
	}

	private boolean riskCategoryExits(PrognosticRiskConfigVo riskCategory)
	{
		if (riskCategory == null)
			throw new CodingRuntimeException("Logical Error - NULL value passed to expected value parameter");
		
		for (int i = 0; i < form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageRiskCategory().grdRiskCategory().getRows().size(); i++)
		{
			PrognosticRiskConfigVo risk = form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageRiskCategory().grdRiskCategory().getRows().get(i).getValue();
			
			if (riskCategory.equals(risk))
				return true;
		}

		return false;
	}

	private boolean prognosticPSAExists(PSAConfigVo prognosticPSA)
	{
		if (prognosticPSA == null)
			throw new CodingRuntimeException("Logical Error - NULL value passed to expected value parameter");
		
		for (int i = 0; i < form.lyrConfig().tabTGroup().lyrGroupDetails().tabPagePSA().grdPSA().getRows().size(); i++)
		{
			PSAConfigVo psa = form.lyrConfig().tabTGroup().lyrGroupDetails().tabPagePSA().grdPSA().getRows().get(i).getValue();
			
			if (prognosticPSA.equals(psa))
				return true;
		}

		return false;
	}

	private boolean serumMarkerExists(TumourSerumMarkersLiteVo serumMarker)
	{
		if (serumMarker == null)
			throw new CodingRuntimeException("Logical Error - NULL value passed to expected value parameter");
		
		for (int i = 0; i < form.lyrConfig().tabSerumMarker().grdSerumMarkers().getRows().size(); i++)
		{
			TumourSerumMarkersLiteVo serum = form.lyrConfig().tabSerumMarker().grdSerumMarkers().getRows().get(i).getValue();
			
			if (serumMarker.equals(serum))
				return true;
		}
		
		return false;
	}


	private boolean histologyGradeExists(HistopathologicGradeVo histologyGrade)
	{
		if (histologyGrade == null)
			throw new CodingRuntimeException("Logical Error - NULL value passed to expected value parameter");
		
		for (int i = 0; i < form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getRows().size(); i++)
		{
			Object rowValue = form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getRows().get(i).getValue();
			
			if (!(rowValue instanceof TumourGroupDifferentationVo))
				continue;
			
			if (histologyGrade.equals(((TumourGroupDifferentationVo)rowValue).getTumourDifferentation()))
				return true;
		}

		return false;
	}

	@Override
	protected void onDyngrdDifferentationRowSelectionChanged(DynamicGridRow row)
	{
		updateGenericContextMenu();
	}

	private void enableHistologyContextMenu(Boolean isEnabled)
	{
		boolean isEditMode = form.getMode().equals(FormMode.EDIT);
		boolean isRecordSelected = form.lyrConfig().tabHistologyType().grdHistology().getSelectedRow() != null;
		form.getContextMenus().Oncology.getTumourHistologyLayerADDItem().setText("Add Histology");
		form.getContextMenus().Oncology.getTumourHistologyLayerADDItem().setVisible(isEditMode && isEnabled);
		// WDEV-11684 - Changed text in context menu option
		form.getContextMenus().Oncology.getTumourHistologyLayerREMOVEItem().setText("Inactivate Histology");
		form.getContextMenus().Oncology.getTumourHistologyLayerREMOVEItem().setVisible(isEditMode && isEnabled && isRecordSelected);
	}

	private void enableSerumMarkersContextMenu(Boolean isEnabled)
	{
		boolean isEditMode = form.getMode().equals(FormMode.EDIT);
		boolean isRecordSelected = form.lyrConfig().tabSerumMarker().grdSerumMarkers().getSelectedRow() != null;
		boolean isOverallStagingConfigure = Boolean.TRUE.equals(form.getLocalContext().getHasOverall());
		form.getContextMenus().Oncology.getTumourSerumMarkersADDItem().setText("Add Serum Markers");
		form.getContextMenus().Oncology.getTumourSerumMarkersADDItem().setVisible(isEditMode && isEnabled);
		form.getContextMenus().Oncology.getTumourSerumMarkersSLECTFROMTAXONOMYItem().setText("Select Serum Markers from Taxonomy");
		form.getContextMenus().Oncology.getTumourSerumMarkersSLECTFROMTAXONOMYItem().setVisible(false);
		form.getContextMenus().Oncology.getTumourSerumMarkersREMOVEItem().setText("Remove Serum Markers");
		form.getContextMenus().Oncology.getTumourSerumMarkersREMOVEItem().setVisible(isEditMode && isEnabled && isRecordSelected && !isOverallStagingConfigure);
	}

	@Override
	protected void onDyngrdDifferentationCellValueChanged(DynamicGridCell cell)
	{
		cell.getRow().setValue(cell.getValue());
		cell.setValue(cell.getValue());
		cell.getRow().setIdentifier(cell.getValue());
		cell.setIdentifier(cell.getValue());
	}

	// ****************************** selected tabs ******************************************
	// ***************************************************************************************

	// WDEV-11684 - entire event handler
	@Override
	protected void onGrdHistologySelectionChanged() throws PresentationLogicException
	{
		if (form.lyrConfig().tabHistologyType().grdHistology().getSelectedRow() != null && form.lyrConfig().tabHistologyType().grdHistology().getSelectedRow().getValue() != null)
		{
			enableHistologyContextMenu(Boolean.TRUE);
			grdHistologyRow row = form.lyrConfig().tabHistologyType().grdHistology().getSelectedRow();

			TumourGroupHistologyVo voHistology = row.getValue();

			if (voHistology == null)
				voHistology = new TumourGroupHistologyVo();

			voHistology.getAssociatedHistology().setHistologyDescription(row.getColHistology());
			row.setValue(voHistology);
			form.getLocalContext().setSelectedHistologyRecord(voHistology);
		}
		else
		{
			displayTNMValueMappingsTab(false);
		}
		
		updateHistologyContextMenu();
	}

	private void populateDataFromMappingsTabs(TumourCategoryGroupSiteSelectedTab selectedTab)
	{
		if (selectedTab == null)
			return;

		if (selectedTab.equals(TumourCategoryGroupSiteSelectedTab.GROUPMAPPINGS))
		{}
		// *********************
		// ** Tab TNMMappings **
		// *********************
		else if (selectedTab.equals(TumourCategoryGroupSiteSelectedTab.TNMMAPPINGS))
		{
			TumourGroupSiteTNMValueVo voTNM = form.getLocalContext().getSelectedTNMRecord();
			voTNM.setTaxonomyMap(form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().customTNMMappings().getValue());

			TumourGroupSiteTNMValueVoCollection voCollTNM = form.getLocalContext().getSelectedTNMCollection();
			if (voCollTNM != null)
			{
				voCollTNM.add(voTNM);
				if (voCollTNM.indexOf(voTNM) >= 0)
					voCollTNM.set(voCollTNM.indexOf(voTNM), voTNM);
				else
				// find and replace it by Histology Desc
				{
					for (int i = 0; i < voCollTNM.size(); i++)
					{
						if (voCollTNM.get(i).getTNMValue().equals(voTNM.getTNMValue()) && voCollTNM.get(i).getTNMDescription().equals(voTNM.getTNMDescription()))
							voCollTNM.set(i, voTNM);
					}
				}
			}
			// if it is a new group
			else
			{
				voCollTNM = new TumourGroupSiteTNMValueVoCollection();
				voCollTNM.add(voTNM);
			}

			if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
			{
				TumourGroupVo voGroup = (TumourGroupVo) form.getLocalContext().getSelectedRecord();
				if (voGroup != null)
				{
					voGroup.setTNMValues(voCollTNM);
				}
				// if it is a new group
				else
				{
					voGroup = new TumourGroupVo();
					voGroup.setTNMValues(voCollTNM);
				}

				form.getLocalContext().setSelectedRecord(voGroup);
			}
			else if (form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
			{
				TumourSiteVo voSite = (TumourSiteVo) form.getLocalContext().getSelectedRecord();
				if (voSite != null)
				{
					voSite.setTNMValues(voCollTNM);
				}
				// if it is a new group
				else
				{
					voSite = new TumourSiteVo();
					voSite.setTNMValues(voCollTNM);
				}

				form.getLocalContext().setSelectedRecord(voSite);
			}
		}
		// ***************************
		// ** Tab HistologyMappings **
		// ***************************
		else if (selectedTab.equals(TumourCategoryGroupSiteSelectedTab.HISTOLOGYMAPPINGS))
		{
			TumourGroupHistologyVo voHistology = form.getLocalContext().getSelectedHistologyRecord();
			//voHistology.setTaxonomyMap(form.lyrConfig().tabHistology().lyrHistology().tabHistoMappings().customHistologyMappings().getValue());

			TumourGroupHistologyVoCollection voCollHistology = form.getLocalContext().getSelectedHistologyCollection();
			if (voCollHistology != null)
			{
				if (voCollHistology.indexOf(voHistology) >= 0)
					voCollHistology.set(voCollHistology.indexOf(voHistology), voHistology);
				else
				// find and replace it by Histology Desc
				{
					for (int i = 0; i < voCollHistology.size(); i++)
					{
						if (voCollHistology.get(i).getAssociatedHistology().getHistologyDescription().equals(voHistology.getAssociatedHistology().getHistologyDescription()))
							voCollHistology.set(i, voHistology);
					}
				}
			}
			else
			{
				voCollHistology = new TumourGroupHistologyVoCollection();
				voCollHistology.add(voHistology);
			}

			if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
			{
				TumourGroupVo voGroup = (TumourGroupVo) form.getLocalContext().getSelectedRecord();
				if (voGroup != null)
				{
					voGroup.setHistologies(voCollHistology);
				}
				else
				{
					voGroup = new TumourGroupVo();
					voGroup.setHistologies(voCollHistology);
				}
				form.getLocalContext().setSelectedRecord(voGroup);
			}
			else if (form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
			{
				TumourSiteVo voSite = (TumourSiteVo) form.getLocalContext().getSelectedRecord();
				if (voSite != null)
				{
					voSite.setHistologies(voCollHistology);
				}
				else
				{
					voSite = new TumourSiteVo();
					voSite.setHistologies(voCollHistology);
				}
				form.getLocalContext().setSelectedRecord(voSite);
			}

		}
		// *******************************
		// ** Tab SerumMarkers Mappings **
		// *******************************
		else if (selectedTab.equals(TumourCategoryGroupSiteSelectedTab.SERUMMAPPINGS))
		{
			TumourSerumMarkersLiteVo voSerumMarkers = form.getLocalContext().getSelectedSerumRecord();

			TumourSerumMarkersLiteVoCollection voCollSerumMarkers = form.getLocalContext().getSelectedSerumCollection();
			if (voCollSerumMarkers != null)
			{
				if (voCollSerumMarkers.indexOf(voSerumMarkers) >= 0)
					voCollSerumMarkers.set(voCollSerumMarkers.indexOf(voSerumMarkers), voSerumMarkers);
				else
				{
					for (int i = 0; i < voCollSerumMarkers.size(); i++)
					{
						if (voCollSerumMarkers.get(i).getSerumMarkerDescription().equals(voSerumMarkers.getSerumMarkerDescription()) && (voCollSerumMarkers.get(i).getSerumMarkerValue().equals(voSerumMarkers.getSerumMarkerValue())))
							voCollSerumMarkers.set(i, voSerumMarkers);
					}
				}
			}
			else
			{

				voCollSerumMarkers = new TumourSerumMarkersLiteVoCollection();
				voCollSerumMarkers.add(voSerumMarkers);
			}

			TumourGroupVo voGroup = (TumourGroupVo) form.getLocalContext().getSelectedRecord();
			if (voGroup != null)
			{
				voGroup.setSerumMarkers(voCollSerumMarkers);
			}
			else
			{
				voGroup = new TumourGroupVo();
				voGroup.setSerumMarkers(voCollSerumMarkers);
			}

			form.getLocalContext().setSelectedRecord(voGroup);
		}
	}

	private void populateDataFromValuesTabs(TumourCategoryGroupSiteSelectedTab selectedTab)
	{
		if (selectedTab == null)
			return;

		if (selectedTab.equals(TumourCategoryGroupSiteSelectedTab.CATEGORY))
		{

		}
		else if (selectedTab.equals(TumourCategoryGroupSiteSelectedTab.GROUPMAPPINGS))
		{}
		// ******************
		// ** Tab TNMValue **
		// ******************
		else if (selectedTab.equals(TumourCategoryGroupSiteSelectedTab.TNMVALUES) || selectedTab.equals(TumourCategoryGroupSiteSelectedTab.TNM))
		{
			TumourGroupSiteTNMValueVoCollection voCollTNM = form.getLocalContext().getSelectedTNMCollection();

			TumourGroupVo voGroup = null;
			if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
			{
				voGroup = fillTNMValuesInaGroupVo(voCollTNM);

				form.getLocalContext().setSelectedTNMCollection(voGroup.getTNMValues());

				form.getLocalContext().setSelectedRecord(voGroup);
			}
			else if (form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
			{
				TumourSiteVo voSite = (TumourSiteVo) form.getLocalContext().getSelectedRecord();
				if (voSite.getHasSiteSpecificTNMIsNotNull() && voSite.getHasSiteSpecificTNM().booleanValue() || form.lyrConfig().tabTSite().chkSiteSpecificTNM().getValue() == Boolean.TRUE)
				{
//					if (voSite != null)
//					{
						voSite.setTNMValues(populateDataFromScreenForLyrConfigTabTNM(voCollTNM));
//					}
					// if it's a new group
//					else
//					{
//						voSite = new TumourSiteVo();
//						voSite.setTNMValues(voCollTNM);
//					}
					form.getLocalContext().setSelectedRecord(voSite);
					form.getLocalContext().setSelectedTNMCollection(voSite.getTNMValues());
				}
				else
				{
					fillTNMValuesInaSiteVo(voCollTNM);
					form.getLocalContext().setSelectedRecord(voGroup);
				}
			}
		}
		// ************************
		// ** Tab HistologyValue **
		// ************************
		else if (selectedTab.equals(TumourCategoryGroupSiteSelectedTab.HISTOLOGYVALUES) || selectedTab.equals(TumourCategoryGroupSiteSelectedTab.HISTOLOGY))
		{
			TumourGroupHistologyVoCollection voCollHistology = form.getLocalContext().getSelectedHistologyCollection();
			if (voCollHistology == null)
				voCollHistology = new TumourGroupHistologyVoCollection();

			voCollHistology = populateDataFromScreenForTabHistology(voCollHistology);

			// for (int i = 0; i < form.lyrConfig().tabHistology().lyrHistology().tabHisto().grdHistology().getRows().size(); i++)
			// {
			// TumourHistologyVo voHistology = form.lyrConfig().tabHistology().lyrHistology().tabHisto().grdHistology().getRows().get(i).getValue();
			// voHistology.setHistologyDescription(form.lyrConfig().tabHistology().lyrHistology().tabHisto().grdHistology().getRows().get(i).getColHistology());
			// voCollHistology.add(voHistology);
			// }

			if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
			{
				TumourGroupVo voGroup = (TumourGroupVo) form.getLocalContext().getSelectedRecord();
				if (voGroup.getHistologies() == null)
					voGroup.setHistologies(new TumourGroupHistologyVoCollection());

				voGroup.setHistologies(voCollHistology);
				form.getLocalContext().setSelectedRecord(voGroup);
			}
			else if (form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
			{
				TumourSiteVo voSite = (TumourSiteVo) form.getLocalContext().getSelectedRecord();
				if (voSite.getHistologies() == null)
					voSite.setHistologies(new TumourGroupHistologyVoCollection());

				voSite.setHistologies(voCollHistology);
				form.getLocalContext().setSelectedRecord(voSite);
			}
			form.getLocalContext().setbTumourHistologyVoLoaded(false);

			form.getLocalContext().setSelectedHistologyCollection(voCollHistology);
		}
		// ****************************
		// ** Tab SerumMarkers Value **
		// ****************************
		else if (selectedTab.equals(TumourCategoryGroupSiteSelectedTab.SERUMVALUES) || selectedTab.equals(TumourCategoryGroupSiteSelectedTab.SERUM))
		{
			TumourSerumMarkersLiteVoCollection voCollSerumMarkers = form.getLocalContext().getSelectedSerumCollection();

			if (voCollSerumMarkers == null)
				voCollSerumMarkers = new TumourSerumMarkersLiteVoCollection();

			voCollSerumMarkers = populateDataFromScreenForTabSerum(voCollSerumMarkers);
			/*
			 * for (int i = 0; i < form.lyrC onfig().tabSerumMarker().lyrSereumMarkers().tabSerumMarkers().grdSerumMarkers().getRows().size(); i++) { TumourSerumMarkersVo voSerumMarkers = form.lyrConfig().tabSerumMarker().lyrSereumMarkers().tabSerumMarkers().grdSerumMarkers().getRows().get(i).getValue();
			 * 
			 * if (voSerumMarkers == null) voSerumMarkers = new TumourSerumMarkersVo();
			 * 
			 * voSerumMarkers.setSerumMarkerValue(form.lyrConfig().tabSerumMarker().lyrSereumMarkers().tabSerumMarkers().grdSerumMarkers().getRows().get(i).getColValue()); voSerumMarkers.setSerumMarkerDescription(form.lyrConfig().tabSerumMarker().lyrSereumMarkers().tabSerumMarkers().grdSerumMarkers().getRows().get(i).getColDescription()); voSerumMarkers.setIsActive(true);
			 * 
			 * voCollSerumMarkers.add(voSerumMarkers); }
			 */
			if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
			{
				TumourGroupVo voGroup = (TumourGroupVo) form.getLocalContext().getSelectedRecord();
				voGroup.setSerumMarkers(voCollSerumMarkers);
				form.getLocalContext().setSelectedRecord(voGroup);
			}
			else if (form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
			{
				// TumourSiteVo voSite = (TumourSiteVo) form.getLocalContext().getSelectedRecord();
				// voSite.setSerumMarkers(voCollSerumMarkers);
				// form.getLocalContext().setSelectedRecord(voSite);
			}

			form.getLocalContext().setbSerumMarkerLoaded(false);
			form.getLocalContext().setSelectedSerumCollection(voCollSerumMarkers);

		}
	}

	private TumourGroupVo fillTNMValuesInaGroupVo(TumourGroupSiteTNMValueVoCollection voCollTNM)
	{
		TumourGroupVo voGroup = (TumourGroupVo) form.getLocalContext().getSelectedRecord();
		if (voGroup != null)
		{
			voGroup.setTNMValues(populateDataFromScreenForLyrConfigTabTNM(voCollTNM));
		}
		// if it's a new group
		else
		{
			voGroup = new TumourGroupVo();
			voGroup.setTNMValues(voCollTNM);
		}
		return voGroup;
	}

	private TumourSiteVo fillTNMValuesInaSiteVo(TumourGroupSiteTNMValueVoCollection voCollTNM)
	{
		TumourSiteVo voSite = (TumourSiteVo) form.getLocalContext().getSelectedRecord();
		if (voSite != null)
		{
			voSite.setTNMValues(populateDataFromScreenForLyrConfigTabTNM(voCollTNM));
		}
		// if it's a new group
		else
		{
			voSite = new TumourSiteVo();
			voSite.setTNMValues(voCollTNM);
		}
		return voSite;
	}

	// ****************************************************************
	// ** Tab Histology -> HistologyValue TAB, HistologyMappings TAB **
	// ****************************************************************
	

	private void populateTitleLabels(Label label)
	{
		if (form.getLocalContext().getSelectedRecordIsNotNull())
		{
			if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
			{
				label.setValue("Group : " + (((TumourGroupVo) form.getLocalContext().getSelectedRecord()).getGroupNameIsNotNull() ? ((TumourGroupVo) form.getLocalContext().getSelectedRecord()).getGroupName() : "Unknown"));
			}
			else if (form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
			{
				if (form.getLocalContext().getParentGroupIsNotNull())
				{
					label.setValue("Group : " + (((TumourGroupListVo) form.getLocalContext().getParentGroup()).getGroupNameIsNotNull() ? ((TumourGroupListVo) form.getLocalContext().getParentGroup()).getGroupName() : "Unknown") + ", Site : " + (((TumourSiteVo) form.getLocalContext().getSelectedRecord()).getNameIsNotNull() ? ((TumourSiteVo) form.getLocalContext().getSelectedRecord()).getName() : "Unknown"));
				}
			}
		}
	}


	// ***********************************************
	// ** Tab TNM -> TNMValue TAB, TNMMappings TAB **
	// ***********************************************
	@Override
	protected void onlyrTNMTabChanged(LayerBridge tab)
	{
		if (form.getLocalContext().getCurrentSelectedTab().equals(TumourCategoryGroupSiteSelectedTab.TNMVALUES) || form.getLocalContext().getCurrentSelectedTab().equals(TumourCategoryGroupSiteSelectedTab.TNMMAPPINGS) || form.getLocalContext().getCurrentSelectedTab().equals(TumourCategoryGroupSiteSelectedTab.TNM))
		{
			if (form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getSelectedRow() != null && (form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getSelectedRow().getCells().get(getColumn(COLTYPE)).getValue() == null || form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getSelectedRow().getCells().get(getColumn(COLTNM)).getValue() == null || form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getSelectedRow().getCells().get(getColumn(COLTNMDESCRIPTION)).getValue() == null || form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getSelectedRow().getCells().get(getColumn(COLCPB)).getValue() == null))
			{
				engine.showMessage("Please fill in all data for TNM before you enter Mappings", "Warning", MessageButtons.OK, MessageIcon.WARNING);
				form.lyrConfig().tabTNM().lyrTNM().showtabTNMValues();
				return;
			}
		}

		// *************************
		// ** TNM -> TNMValue tab **
		// *************************
		if ((tab instanceof tabTNMValuesContainer || tab instanceof tabTNMContainer))
		{
			if (isEditMode())
				populateDataFromMappingsTabs(form.getLocalContext().getCurrentSelectedTab());

			form.getLocalContext().setCurrentSelectedTab(TumourCategoryGroupSiteSelectedTab.TNMVALUES);
			TumourGroupSiteTNMValueVoCollection voCollTNM = form.getLocalContext().getSelectedTNMCollection();

			if (voCollTNM == null)
				voCollTNM = new TumourGroupSiteTNMValueVoCollection();

			if (!form.getLocalContext().getbTumourGroupSiteTNMValueVoLoaded())
			{
				form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getRows().clear();

				if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
				{
					populateScreenFromDataForLyrConfigTabTNM(((TumourGroupVo) form.getLocalContext().getSelectedRecord()).getTNMValues(), GroupTNMValuesEnumeration.rdoAll, true);
				}
				else if (form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
				{
					populateScreenFromDataForLyrConfigTabTNM(((TumourSiteVo) form.getLocalContext().getSelectedRecord()).getTNMValues(), GroupTNMValuesEnumeration.rdoAll, true);
				}

				form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().setValue(form.getLocalContext().getSelectedTNMRecord());

				form.getLocalContext().setbTumourGroupSiteTNMValueVoLoaded(true);
			}
		}
		// ****************************
		// ** TNM -> TNMMappings tab **
		// ****************************
		else if (tab instanceof tabTNMMappingsContainer)
		{
			if (isEditMode())
				populateDataFromValuesTabs(form.getLocalContext().getCurrentSelectedTab());
			form.getLocalContext().setCurrentSelectedTab(TumourCategoryGroupSiteSelectedTab.TNMMAPPINGS);

			TumourGroupSiteTNMValueVo selectedTNMRecord = form.getLocalContext().getSelectedTNMRecord();

			form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().setcustomTNMMappingsEnabled(true);
			form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().customTNMMappings().setComponentMode(form.getMode());

			TaxonomyMapCollection voCollTaxonomy = selectedTNMRecord.getTaxonomyMap();
			form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().txtTNMDescription().setValue(selectedTNMRecord.getTNMDescriptionIsNotNull() ? selectedTNMRecord.getTNMDescription() : null);
			form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().txtTNMValue().setValue(selectedTNMRecord.getTNMValueIsNotNull() ? selectedTNMRecord.getTNMValue() : null);
			form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().customTNMMappings().setValue(voCollTaxonomy != null ? voCollTaxonomy : null);
		}
	}

	protected void onlyrConfigTabChanged(LayerBridge tab)
	{
		// If we are in Edit mode and Previous tab was edited ....we need to save this change
		if (form.getLocalContext().getCurrentSelectedTabIsNotNull() && isEditMode())
		{
			populateDataFromValuesTabs(form.getLocalContext().getCurrentSelectedTab());
			populateDataFromMappingsTabs(form.getLocalContext().getCurrentSelectedTab());
		}

		if (tab instanceof tabTCategoryContainer)
		{
			form.getLocalContext().setCurrentSelectedTab(TumourCategoryGroupSiteSelectedTab.CATEGORY);

		}
		else if (tab instanceof tabHistologyGradeContainer)
		{
			if (FormMode.EDIT.equals(form.getMode()))
			{
				form.getLocalContext().setRefreshHistologicGradeRecords(Boolean.TRUE);
			}
			
			HistopathologicGradeVoCollection voFullCollection = domain.listAllTumourDiffs();
			form.getLocalContext().setDifferentationCollection(voFullCollection);

			try
			{
				populateEmbeddedTab(form.lyrConfig().tabHistologyGrade(), (TumourGroupVo) form.getLocalContext().getSelectedRecord());
			}
			catch (PresentationLogicException e)
			{
				e.printStackTrace();
			}
			
			updateGenericContextMenu();
			enableClassificationContextMenu(Boolean.FALSE);
		}
		else if (tab instanceof tabSpecialtiesContainer)
		{
			if (FormMode.EDIT.equals(form.getMode()))
			{
				form.getLocalContext().setRefreshSpecialtyRecords(Boolean.TRUE);
			}

			updateGenericContextMenu();
			enableClassificationContextMenu(Boolean.FALSE);

			if (!form.getLocalContext().getbTumourGroupSpecialtyLoaded())
			{
				try
				{
					populateEmbeddedTab(form.lyrConfig().tabSpecialties(), (TumourGroupVo) form.getLocalContext().getSelectedRecord());
				}
				catch (PresentationLogicException e)
				{
					e.printStackTrace();
				}
			}
		}
		else if (tab instanceof tabPagTaxonomyContainer)
		{
			if (!form.getLocalContext().getbTumourGroupTaxonomyMappingsLoaded())
			{
				if (form.getLocalContext().getSelectedRecord() != null)
				{
					if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
					{
						TumourGroupVo voGroup = (TumourGroupVo) form.getLocalContext().getSelectedRecord();
						form.lyrConfig().tabPagTaxonomy().customGroupMapping().setValue(voGroup.getTaxonomyMap());
					}
				}
				form.getLocalContext().setbTumourGroupTaxonomyMappingsLoaded(true);
			}
		}
		else if (tab instanceof tabTSiteContainer)
		{

		}
		else if (tab instanceof tabTGroupContainer)
		{
			if (isEditMode())
				populateDataFromValuesTabs(form.getLocalContext().getCurrentSelectedTab());
		}
		// *********************
		// *** Tab TNM ***
		// *********************
		else if (tab instanceof tabTNMContainer)
		{
			engine.setCurrentLayoutState(UILayoutState.DEFAULT);
			populateTitleLabels(form.lyrConfig().tabTNM().lblTitle());
			form.getLocalContext().setCurrentSelectedTab(TumourCategoryGroupSiteSelectedTab.TNM);
			// if (isEditMode())
			// populateDataFromValuesTabs(form.getLocalContext().getCurrentSelectedTab());

			form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().setHeaderVisible(false);
			form.lyrConfig().tabTNM().lyrTNM().showtabTNMValues();
			form.lyrConfig().tabTNM().GroupTNMValues().setValue(GroupTNMValuesEnumeration.rdoAll);

			TumourGroupVo voGroup = null;
			TumourSiteVo voSite = null;

			if (form.getLocalContext().getSelectedRecordIsNotNull() && form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
			{
				voGroup = (TumourGroupVo) form.getLocalContext().getSelectedRecord();

				if (voGroup.getTNMValuesIsNotNull())
				{
					form.getLocalContext().setSelectedTNMCollection(voGroup.getTNMValues());
					form.lyrConfig().tabTNM().lyrTNM().showtabTNMValues();
					onlyrTNMTabChanged(tab);
					form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().setValue(null);
				}
				else
					form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getRows().clear();
			}
			if (form.getLocalContext().getSelectedRecordIsNotNull() && form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
			{
				voSite = (TumourSiteVo) form.getLocalContext().getSelectedRecord();

				if (voSite.getTNMValuesIsNotNull())
				{
					form.getLocalContext().setSelectedTNMCollection(voSite.getTNMValues());
					form.lyrConfig().tabTNM().lyrTNM().showtabTNMValues();
					onlyrTNMTabChanged(tab);
					form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().setValue(null);
				}
				else
					form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getRows().clear();
			}

			enableTNMContextMenu(Boolean.TRUE);

			/*
			 * if (form.getMode().equals(FormMode.EDIT)) form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().setEnabled(true);
			 * 
			 * if (form.getLocalContext().getHasOverallIsNotNull() && form.getLocalContext().getHasOverall()) { enableTNMContextMenu(Boolean.FALSE); if (form.getMode().equals(FormMode.EDIT)) form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().setReadOnly(true); }
			 */
		}
		// *************************
		// *** Tab Histology ***
		// *************************
		else if (tab instanceof tabHistologyTypeContainer)
		{
			if (FormMode.EDIT.equals(form.getMode()))
			{
				form.getLocalContext().setRefreshHistologyTypeRecords(Boolean.TRUE);
			}


			populateTitleLabels(form.lyrConfig().tabHistologyType().lblTitleHistology());
			form.getLocalContext().setCurrentSelectedTab(TumourCategoryGroupSiteSelectedTab.HISTOLOGY);
			// if (isEditMode())
			// populateDataFromValuesTabs(form.getLocalContext().getCurrentSelectedTab());
			enableHistologyContextMenu(Boolean.TRUE);
			TumourGroupVo voGroup = null;
			TumourSiteVo voSite = null;

			if (form.getLocalContext().getSelectedRecordIsNotNull() && form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
			{
				voGroup = (TumourGroupVo) form.getLocalContext().getSelectedRecord();

				if (voGroup.getHistologiesIsNotNull())
				{
					form.getLocalContext().setSelectedHistologyCollection(voGroup.getHistologies());
					
					// Clear histology type grid
					form.lyrConfig().tabHistologyType().grdHistology().getRows().clear();
					
					for (TumourGroupHistologyVo histology : voGroup.getHistologies())
					{
						grdHistologyRow histologyRow = form.lyrConfig().tabHistologyType().grdHistology().getRows().newRow();
						
						histologyRow.setColHistology(histology.getAssociatedHistology().getHistologyDescription());
						
						histologyRow.setTextColor(Boolean.TRUE.equals(histology.getIsActive()) ? Color.Black : Color.Gray);
						
						histologyRow.setValue(histology);
					}
					
				}
			}
			if (form.getLocalContext().getSelectedRecordIsNotNull() && form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
			{
				voSite = (TumourSiteVo) form.getLocalContext().getSelectedRecord();

				if (voSite.getHistologiesIsNotNull())
				{
					form.getLocalContext().setSelectedHistologyCollection(voSite.getHistologies());
					
					// Clear histology type grid
					form.lyrConfig().tabHistologyType().grdHistology().getRows().clear();
					
					for (TumourGroupHistologyVo histology : voSite.getHistologies())
					{
						grdHistologyRow histologyRow = form.lyrConfig().tabHistologyType().grdHistology().getRows().newRow();

						histologyRow.setColHistology(histology.getAssociatedHistology().getHistologyDescription());
						
						histologyRow.setTextColor(Boolean.TRUE.equals(histology.getIsActive()) ? Color.Black : Color.Gray);
						
						histologyRow.setValue(histology);
					}
				}
			}
			
			updateHistologyContextMenu();
		}
		// ***********************
		// *** Serum Markers ***
		// ***********************
		else if (tab instanceof tabSerumMarkerContainer)
		{
			if (FormMode.EDIT.equals(form.getMode()))
			{
				form.getLocalContext().setRefreshSerumMarkerRecords(Boolean.TRUE);
			}


			engine.setCurrentLayoutState(UILayoutState.DEFAULT);
			populateTitleLabels(form.lyrConfig().tabSerumMarker().lblTitleSerum());
			form.getLocalContext().setCurrentSelectedTab(TumourCategoryGroupSiteSelectedTab.SERUM);
			// if (isEditMode())
			// populateDataFromValuesTabs(form.getLocalContext().getCurrentSelectedTab());
			enableSerumMarkersContextMenu(Boolean.TRUE);

			TumourGroupVo voGroup = null;

			if (form.getLocalContext().getSelectedRecordIsNotNull() && form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
			{
				voGroup = (TumourGroupVo) form.getLocalContext().getSelectedRecord();

				if (voGroup.getSerumMarkersIsNotNull())
				{
					form.getLocalContext().setSelectedSerumCollection(voGroup.getSerumMarkers());

					// Clear serum markers grid
					form.lyrConfig().tabSerumMarker().grdSerumMarkers().getRows().clear();
					
					
					for (TumourSerumMarkersLiteVo serumMarker : voGroup.getSerumMarkers())
					{
						grdSerumMarkersRow serumMarkerRow = form.lyrConfig().tabSerumMarker().grdSerumMarkers().getRows().newRow();
						
						serumMarkerRow.setColValue(serumMarker.getSerumMarkerValue());
						serumMarkerRow.setColDescription(serumMarker.getSerumMarkerDescription());
						
						serumMarkerRow.setValue(serumMarker);
					}
				}
			}
			
			updateSerumContextMenu();
		}

		form.getLocalContext().setPreviousTopLevelTab(tab);
		
		updateHistologyContextMenu();
	}

	private boolean isEditMode()
	{
		return form.getMode().equals(FormMode.EDIT);
	}

	@Override
	protected void onlyrGroupDetailsTabChanged(LayerBridge tab)
	{
//		if (tab instanceof tabClassificationContainer)
//		{
//			enableClassificationContextMenu(Boolean.TRUE);
//			updateGenericContextMenu();
//			try
//			{
//				populateEmbeddedTab(form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification(), (TumourGroupVo) form.getLocalContext().getSelectedRecord());
//			}
//			catch (PresentationLogicException e)
//			{
//				e.printStackTrace();
//			}
//		}
		
		if (tab instanceof tabPageTumourLocationContainer)
		{
			if (FormMode.EDIT.equals(form.getMode()))
			{
				form.getLocalContext().setRefreshTumourLocationRecords(Boolean.TRUE);
			}
			
			populateTabPageTumourLocationContainer(form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo ? (TumourGroupVo) form.getLocalContext().getSelectedRecord() : null);
		}
		if (tab instanceof tabPageRiskCategoryContainer)
		{
			if (FormMode.EDIT.equals(form.getMode()))
			{
				form.getLocalContext().setRefreshRiskCategoryRecords(Boolean.TRUE);
			}

			populateTabPageTumourRiskCategoryContainer(form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo ? (TumourGroupVo) form.getLocalContext().getSelectedRecord() : null);
		}
		if (tab instanceof tabPagePSAContainer)
		{
			if (FormMode.EDIT.equals(form.getMode()))
			{
				form.getLocalContext().setRefreshPSARecords(Boolean.TRUE);
			}
			
			populateTabPageTumourPSAContainer(form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo ? (TumourGroupVo) form.getLocalContext().getSelectedRecord() : null);
		}
		if (tab instanceof tabPageGleasonContainer)
		{
			if (FormMode.EDIT.equals(form.getMode()))
			{
				form.getLocalContext().setRefreshGleasonRecords(Boolean.TRUE);
			}

			populateTabPageGleasonContainer(form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo ? (TumourGroupVo) form.getLocalContext().getSelectedRecord() : null);
		}
		
		updateControlsState();
	}

	/**
	 * 
	 * @param tumourGroup
	 */
	private void populateTabPageGleasonContainer(TumourGroupVo tumourGroup)
	{
		// Check if refresh is needed
		if (!Boolean.TRUE.equals(form.getLocalContext().getRefreshGleasonTab()))
			return;
		
		// Mark this tab as have been populated
		form.getLocalContext().setRefreshGleasonTab(Boolean.FALSE);

		// Clear grid
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGleason().grdGleason().getRows().clear();
		
		// Check tumour group and records
		if (tumourGroup == null || !tumourGroup.getPrognosticGroupingConfigIsNotNull() || !tumourGroup.getPrognosticGroupingConfig().getGleasonIsNotNull())
			return;
		
		// Populate records to grid
		for (GleasonConfigLiteVo gleasonRecord : tumourGroup.getPrognosticGroupingConfig().getGleason())
		{
			grdGleasonRow gleasonRow = form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGleason().grdGleason().getRows().newRow();
			
			gleasonRow.setColGleason(gleasonRecord.getGleasonName());
			
			gleasonRow.setValue(gleasonRecord);
		}
	}

	/**
	 * 
	 * @param tumourGroup
	 */
	private void populateTabPageTumourPSAContainer(TumourGroupVo tumourGroup)
	{
		// Check if refresh is needed
		if (!Boolean.TRUE.equals(form.getLocalContext().getRefreshPSATab()))
			return;
		
		// Mark this tab as have been populated
		form.getLocalContext().setRefreshPSATab(Boolean.FALSE);

		// Clear grid
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPagePSA().grdPSA().getRows().clear();
		
		// Check tumour group and records
		if (tumourGroup == null || !tumourGroup.getPrognosticGroupingConfigIsNotNull() || !tumourGroup.getPrognosticGroupingConfig().getPSAIsNotNull())
			return;
		
		// Populate records to grid
		for (PSAConfigVo psaRecord : tumourGroup.getPrognosticGroupingConfig().getPSA())
		{
			grdPSARow psaRow = form.lyrConfig().tabTGroup().lyrGroupDetails().tabPagePSA().grdPSA().getRows().newRow();
			
			psaRow.setColPSA(psaRecord.getPSAName());
			
			psaRow.setValue(psaRecord);
		}
	}

	/**
	 * 
	 * @param tumourGroup
	 */
	private void populateTabPageTumourRiskCategoryContainer(TumourGroupVo tumourGroup)
	{
		// Check if refresh is needed
		if (!Boolean.TRUE.equals(form.getLocalContext().getRefreshRiskCategoryTab()))
			return;
		
		// Mark this tab as have been populated
		form.getLocalContext().setRefreshRiskCategoryTab(Boolean.FALSE);

		// Clear grid
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageRiskCategory().grdRiskCategory().getRows().clear();
		
		// Check tumour group and records
		if (tumourGroup == null || !tumourGroup.getPrognosticGroupingConfigIsNotNull() || !tumourGroup.getPrognosticGroupingConfig().getRiskIsNotNull())
			return;
		
		// Populate records to grid
		for (PrognosticRiskConfigVo riskRecord : tumourGroup.getPrognosticGroupingConfig().getRisk())
		{
			grdRiskCategoryRow riskRow = form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageRiskCategory().grdRiskCategory().getRows().newRow();
			
			riskRow.setColRiskCategory(riskRecord.getRiskName());
			
			riskRow.setValue(riskRecord);
		}
	}

	/**
	 * 
	 * @param tumourGroup
	 */
	private void populateTabPageTumourLocationContainer(TumourGroupVo tumourGroup)
	{
		// Check if refresh is needed
		if (!Boolean.TRUE.equals(form.getLocalContext().getRefreshTumourLocationTab()))
			return;
		
		// Mark this tab as have been populated
		form.getLocalContext().setRefreshTumourLocationTab(Boolean.FALSE);
		
		// Clear grid
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageTumourLocation().grdPrognosticLocation().getRows().clear();
		
		// Check tumour group and records
		if (tumourGroup == null || !tumourGroup.getPrognosticGroupingConfigIsNotNull() || !tumourGroup.getPrognosticGroupingConfig().getLocationIsNotNull())
			return;
		
		// Populate records to grid
		for (PrognosticLocationConfigVo prognosticLocation : tumourGroup.getPrognosticGroupingConfig().getLocation())
		{
			grdPrognosticLocationRow prognosticLocationRow = form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageTumourLocation().grdPrognosticLocation().getRows().newRow();
			
			prognosticLocationRow.setColTumourLocation(prognosticLocation.getLocationName());
			
			prognosticLocationRow.setValue(prognosticLocation);
		}
	}

	protected final void bindOverallValue(DynamicGridCell typeCell)
	{
		TumourOverallStageCollection lookupCollection = LookupHelper.getTumourOverallStage(domain.getLookupService());
		for (int x = 0; x < lookupCollection.size(); x++)
		{
			typeCell.getItems().newItem(lookupCollection.get(x), lookupCollection.get(x).getText(), lookupCollection.get(x).getImage(), lookupCollection.get(x).getTextColor());
		}
	}

	@Override
	protected void onChkCatActiveValueChanged() throws PresentationLogicException
	{
		if (checkFostActiveGroupsOrSitesRecords())
			form.lyrConfig().tabTCategory().chkCatActive().setValue(true);

	}

	@Override
	protected void onChkGroupActiveValueChanged() throws PresentationLogicException
	{
		if (checkFostActiveGroupsOrSitesRecords())
			form.lyrConfig().tabTGroup().chkGroupActive().setValue(true);

	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see ims.clinicaladmin.forms.tumourcategorygroupsites.Handlers#onGrdSerumMarkersSelectionChanged()
	 */
	@Override
	protected void onGrdSerumMarkersSelectionChanged() throws PresentationLogicException
	{
		if (form.lyrConfig().tabSerumMarker().grdSerumMarkers().getSelectedRow() != null && form.lyrConfig().tabSerumMarker().grdSerumMarkers().getSelectedRow().getValue() != null)
		{
			enableSerumMarkersContextMenu(Boolean.TRUE);

			form.lyrConfig().tabSerumMarker().setEnabled(true);

			grdSerumMarkersRow row = form.lyrConfig().tabSerumMarker().grdSerumMarkers().getSelectedRow();

			TumourSerumMarkersLiteVo voSerum = row.getValue();

			if (voSerum == null)
				voSerum = new TumourSerumMarkersVo();

			voSerum = row.getValue();
			row.setValue(voSerum);
			form.getLocalContext().setSelectedSerumRecord(voSerum);
		}
		
		updateSerumContextMenu();
	}

	@Override
	protected void onChkReqDiffValueChanged() throws PresentationLogicException
	{
		if (form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqDiff().getValue() == false)
		{
			if (form.getLocalContext().getSelectedRecordIsNotNull())
			{
				if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
				{
					if (form.getLocalContext().getHasOverallIsNotNull() && form.getLocalContext().getHasOverall() == true && ((TumourGroupVo) form.getLocalContext().getSelectedRecord()).getTnmRequiresDiffIsNotNull() && ((TumourGroupVo) form.getLocalContext().getSelectedRecord()).getTnmRequiresDiff())
					{
						displayErrorMessage("An Overall configuration exists!", true);
						form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqDiff().setValue(true);
					}
				}
			}
		}
	}

	@Override
	protected void onChkReqHistologyValueChanged() throws PresentationLogicException
	{
		if (form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqHistology().getValue() == false)
		{
			if (form.getLocalContext().getSelectedRecordIsNotNull())
			{
				if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
				{
					if (form.getLocalContext().getHasOverallIsNotNull() && form.getLocalContext().getHasOverall() == true && ((TumourGroupVo) form.getLocalContext().getSelectedRecord()).getTnmRequiresHistoIsNotNull() && ((TumourGroupVo) form.getLocalContext().getSelectedRecord()).getTnmRequiresHisto())
					{
						displayErrorMessage("An Overall configuration exists!", true);
						form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqHistology().setValue(true);
					}
				}
			}
		}
	}

	@Override
	protected void onChkReqO45ValueChanged() throws PresentationLogicException
	{
		if (form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqO45().getValue() == false)
		{
			if (form.getLocalContext().getSelectedRecordIsNotNull())
			{
				if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
				{
					if (form.getLocalContext().getHasOverallIsNotNull() && form.getLocalContext().getHasOverall() == true && ((TumourGroupVo) form.getLocalContext().getSelectedRecord()).getTnmRequiresOver45IsNotNull() && ((TumourGroupVo) form.getLocalContext().getSelectedRecord()).getTnmRequiresOver45())
					{
						displayErrorMessage("An Overall configuration exists!", true);
						form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqO45().setValue(true);
					}
				}
			}
		}
	}

	@Override
	protected void onTreOtherClassificationTreeViewSelectionChanged(TreeNode node) throws PresentationLogicException
	{
		form.getContextMenus().Oncology.getTumourGroupOtherClassificationRemoveClassificationItem().setVisible(form.getMode().equals(FormMode.EDIT) && form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getSelectedNode() != null);//WDEV-16926
		form.getContextMenus().Oncology.getTumourGroupOtherClassificationRemoveClassificationItem().setEnabled(form.getMode().equals(FormMode.EDIT) && form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().getSelectedNode() != null);//WDEV-16926
	}

	@Override
	protected void onTreSpecialtyTreeViewSelectionChanged(TreeNode node) throws PresentationLogicException
	{
		updateGenericContextMenu();
	}

	@Override
	protected void onChkSiteSpecificHistologyValueChanged() throws PresentationLogicException
	{
		if (form.getMode().equals(FormMode.EDIT))
		{
			if (form.lyrConfig().tabTSite().chkSiteSpecificHistology().getValue())
			{}
			else
			{
				if (form.getLocalContext().getSelectedRecordIsNotNull())
				{
					if (form.getLocalContext().getSelectedRecord() instanceof TumourSiteVo)
					{
						if (((TumourSiteVo) form.getLocalContext().getSelectedRecord()).getID_TumourSiteIsNotNull() && ((TumourSiteVo) form.getLocalContext().getSelectedRecord()).getHistologiesIsNotNull() && ((TumourSiteVo) form.getLocalContext().getSelectedRecord()).getHistologies().size() > 0)
						{
							displayErrorMessage("A Histology configuration exists!", true);
							form.lyrConfig().tabTSite().chkSiteSpecificHistology().setValue(true);
						}
					}
				}
			}
		}
	}

	@Override
	protected void onCmbVersionValueChanged() throws PresentationLogicException
	{
		populateVersionDetails(form.lyrConfig().tabTVersion().cmbVersion().getValue());
	}

	private void populateVersions(TNMStagingClassificationVersionLiteVoCollection groupVersions)
	{
		// Clear the query combobox
		form.lyrConfig().tabTVersion().cmbVersion().clear();
		clearVersionDetails();
		
		if (groupVersions == null)
			return;
		
		for (TNMStagingClassificationVersionLiteVo version : groupVersions)
		{
			form.lyrConfig().tabTVersion().cmbVersion().newRow(version, version.getVersionNumber());
		}
	}

	private void populateVersionDetails(TNMStagingClassificationVersionLiteVo version)
	{
		clearVersionDetails();
		
		if (version == null)
			return;
		
		form.lyrConfig().tabTVersion().dteActiveFrom().setValue(version.getActiveFrom());
		form.lyrConfig().tabTVersion().dteActiveTo().setValue(version.getActiveTo());
		
		form.lyrConfig().tabTVersion().txtDescription().setValue(version.getVersionDescription());
	}

	private void clearVersionDetails()
	{
		form.lyrConfig().tabTVersion().dteActiveFrom().setValue(null);
		form.lyrConfig().tabTVersion().dteActiveTo().setValue(null);
		
		form.lyrConfig().tabTVersion().txtDescription().setValue(null);
	}

	@Override
	protected void onQmbLinkedAssessmentTextSubmited(String value) throws PresentationLogicException
	{
		populateAssessments(domain.listUserAssessments(value));
	}

	private void populateAssessments(UserAssessmentLiteVoCollection assessments)
	{
		// Clear assessments
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().qmbLinkedAssessment().clear();
		
		if (assessments == null)
			return;
		
		for (UserAssessmentLiteVo userAssessment : assessments)
		{
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().qmbLinkedAssessment().newRow(userAssessment, userAssessment.getName());
		}
		
		if (assessments.size() == 1)
		{
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().qmbLinkedAssessment().setValue(assessments.get(0));
		}
		else
		{
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().qmbLinkedAssessment().showOpened();
		}
	}

	@Override
	protected void onChkPrognosticGroupingValueChanged() throws PresentationLogicException
	{
		// Need to call controls state
		updateControlsState();
	}

	@Override
	protected void onChkGleasonPrognosticGroupingValueChanged() throws PresentationLogicException
	{
		updateControlsState();
	}

	@Override
	protected void onChkPSAPrognosticGroupingValueChanged() throws PresentationLogicException
	{
		updateControlsState();
	}

	@Override
	protected void onChkRiskCategoryPrognosticGroupingValueChanged() throws PresentationLogicException
	{
		updateControlsState();
	}

	@Override
	protected void onChkTumourLocationPrognosticGroupingValueChanged() throws PresentationLogicException
	{
		updateControlsState();
	}

	/**
	 * Function used to set the state for controls (Visible/Hidden or Enable/Disable)
	 */
	private void updateControlsState()
	{
		lyrGroupDetailsLayer lyrGroupDetails = form.lyrConfig().tabTGroup().lyrGroupDetails();

		// Region for check boxes on TumourGroup tab
		boolean isSelectedTumourGroupOverallCompleted = form.getLocalContext().getSelectedRecord() instanceof TumourGroupRefVo && Boolean.TRUE.equals(form.getLocalContext().getHasOverall());
		boolean isSelectedTumourGroupOverallPrognostic = form.getLocalContext().getSelectedRecord() instanceof TumourGroupRefVo && Boolean.TRUE.equals(form.getLocalContext().getHasPrognosticGrouping());
		boolean isSelectedTumourSiteOverallCompleted = form.getLocalContext().getSelectedRecord() instanceof TumourSiteRefVo && Boolean.TRUE.equals(form.getLocalContext().getHasOverall());

		// Region for Tumour Group sub-tabs
		boolean isTNMStagingChecked = form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkHasTNM().getValue();
		boolean isOtherClassificationChecked = form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkOtherClassifications().getValue();

		boolean isPrognosticGroupingChecked = form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkPrognosticGrouping().getValue();

		boolean isTumourLocationChecked = lyrGroupDetails.tabPrognosticGrouping().chkTumourLocationPrognosticGrouping().getValue();
		boolean isRiskCategoryChecked = lyrGroupDetails.tabPrognosticGrouping().chkRiskCategoryPrognosticGrouping().getValue();
		boolean isPSAChecked = lyrGroupDetails.tabPrognosticGrouping().chkPSAPrognosticGrouping().getValue();
		boolean isGleasonChecked = lyrGroupDetails.tabPrognosticGrouping().chkGleasonPrognosticGrouping().getValue();

		if (FormMode.EDIT.equals(form.getMode()))
		{
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkHasTNM().setEnabled(!isSelectedTumourGroupOverallCompleted				// The current TumourGroup record doesn't have an Overall Staging
																											&& !isSelectedTumourGroupOverallPrognostic);	// and it doesn't have an Overall Prognostic saved
			
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkPrognosticGrouping().setEnabled(!isSelectedTumourGroupOverallPrognostic);		// The current TumourGroup record doesn't have an Overall Prognostic saved
			
			form.lyrConfig().tabTSite().chkSiteSpecificTNM().setEnabled(!isSelectedTumourSiteOverallCompleted);
			form.lyrConfig().tabTSite().chkSiteSpecificHistology().setEnabled(!isSelectedTumourSiteOverallCompleted);

//          form.lyrConfig().tabTGroup().chkHasTNM().setEnabled(!isSelectedTumourGroupOverallCompleted);
//          form.lyrConfig().tabTGroup().chkOtherClassifications().setEnabled(!isSelectedTumourGroupOverallCompleted);

			form.lyrConfig().tabTGroup().lyrGroupDetails().settabGroupTNMEnabled(true);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqHistology().setEnabled(!isSelectedTumourGroupOverallCompleted);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqSerumMarkers().setEnabled(!isSelectedTumourGroupOverallCompleted);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqDiff().setEnabled(!isSelectedTumourGroupOverallCompleted);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqO45().setEnabled(!isSelectedTumourGroupOverallCompleted);
			
			lyrGroupDetails.tabPrognosticGrouping().chkUsesTValues().setEnabled(!isSelectedTumourGroupOverallPrognostic);
			lyrGroupDetails.tabPrognosticGrouping().chkUsesNValues().setEnabled(!isSelectedTumourGroupOverallPrognostic);
			lyrGroupDetails.tabPrognosticGrouping().chkUsesMValues().setEnabled(!isSelectedTumourGroupOverallPrognostic);
			
			lyrGroupDetails.tabPrognosticGrouping().chkHistologyTypePrognosticGrouping().setEnabled(!isSelectedTumourGroupOverallPrognostic);
			lyrGroupDetails.tabPrognosticGrouping().chkHistologicalGradePrognosticGrouping().setEnabled(!isSelectedTumourGroupOverallPrognostic);
			lyrGroupDetails.tabPrognosticGrouping().chkTumourLocationPrognosticGrouping().setEnabled(!isSelectedTumourGroupOverallPrognostic);
			lyrGroupDetails.tabPrognosticGrouping().chkRiskCategoryPrognosticGrouping().setEnabled(!isSelectedTumourGroupOverallPrognostic);
			lyrGroupDetails.tabPrognosticGrouping().chkPSAPrognosticGrouping().setEnabled(!isSelectedTumourGroupOverallPrognostic);
			lyrGroupDetails.tabPrognosticGrouping().chkGleasonPrognosticGrouping().setEnabled(!isSelectedTumourGroupOverallPrognostic);
		}

		// Set TNM Staging tab state (Visible / Hidden)
		lyrGroupDetails.tabGroupTNM().setHeaderVisible(isTNMStagingChecked);
		// Set Other Classification tab state (Visible / Hidden)
		lyrGroupDetails.tabClassification().setHeaderVisible(isOtherClassificationChecked);

		// Set Prognostic Grouping tab state (Visible / Hidden)
		lyrGroupDetails.tabPrognosticGrouping().setHeaderVisible(isPrognosticGroupingChecked && isTNMStagingChecked);

		// Set Tumour Location tab for Prognostic Grouping state (Visible / Hidden)
		lyrGroupDetails.tabPageTumourLocation().setHeaderVisible(isTumourLocationChecked && isPrognosticGroupingChecked && isTNMStagingChecked);
		// Set Risk Category tab for Prognostic Grouping state (Visible / Hidden)
		lyrGroupDetails.tabPageRiskCategory().setHeaderVisible(isRiskCategoryChecked && isPrognosticGroupingChecked && isTNMStagingChecked);
		// Set PSA tab for Prognostic Grouping state (Visible / Hidden)
		lyrGroupDetails.tabPagePSA().setHeaderVisible(isPSAChecked && isPrognosticGroupingChecked && isTNMStagingChecked);
		// Set Gleason tab for Prognostic Grouping state (Visible / Hidden)
		lyrGroupDetails.tabPageGleason().setHeaderVisible(isGleasonChecked && isPrognosticGroupingChecked && isTNMStagingChecked);
		
		updateContextMenuState();
	}

	private void updateContextMenuState()
	{
		boolean isSelectedTumourGroupOverallPrognostic = form.getLocalContext().getSelectedRecord() instanceof TumourGroupRefVo
																	&& Boolean.TRUE.equals(form.getLocalContext().getHasPrognosticGrouping());
		
		// Update state for Tumour Location context menu
		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticLocationADDItem().setVisible(FormMode.EDIT.equals(form.getMode()));	// This condition is to fix old theme problem where a context menu shows on disabled grid
		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticLocationREMOVEItem().setVisible(form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageTumourLocation().grdPrognosticLocation().getSelectedRow() != null
																											&& !isSelectedTumourGroupOverallPrognostic);
		
		// Update state for Risk Category context menu
		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticRiskADDItem().setVisible(FormMode.EDIT.equals(form.getMode()));		// This condition is to fix old theme problem where a context menu shows on disabled grid
		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticRiskREMOVEItem().setVisible(form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageRiskCategory().grdRiskCategory().getSelectedRow() != null
																											&& !isSelectedTumourGroupOverallPrognostic);
		
		// Update state for PSA context menu
		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticPSAADDItem().setVisible(FormMode.EDIT.equals(form.getMode()));			// This condition is to fix old theme problem where a context menu shows on disabled grid
		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticPSAREMOVEItem().setVisible(form.lyrConfig().tabTGroup().lyrGroupDetails().tabPagePSA().grdPSA().getSelectedRow() != null
																											&& !isSelectedTumourGroupOverallPrognostic);
		
		// Update state for Gleason context menu
		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticGleasonADDItem().setVisible(FormMode.EDIT.equals(form.getMode()));		// This condition is to fix old theme problem where a context menu shows on disabled grid
		form.getContextMenus().ClinicalAdmin.getTumourGroupPrognosticGleasonREMOVEItem().setVisible(form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGleason().grdGleason().getSelectedRow() != null
																											&& !isSelectedTumourGroupOverallPrognostic);
	}

	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//	Region data exchange for Tumour Group records 
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// WDEV-11684 - entire function
	private TumourGroupVo populateDataFromScreenForLyrConfigTabGroup(TumourGroupVo voGroup)
	{
		if (voGroup == null)
		{
			voGroup = new TumourGroupVo();
			voGroup.setTNMVersion(form.customTree().getSelectedBranchVersion());
		}

		voGroup.setGroupName(form.lyrConfig().tabTGroup().txtGroupName().getValue() != null ? form.lyrConfig().tabTGroup().txtGroupName().getValue().trim() : null);
		voGroup.setGroupDescription(form.lyrConfig().tabTGroup().txtGroupDescription().getValue() != null ? form.lyrConfig().tabTGroup().txtGroupDescription().getValue().trim() : null);
		voGroup.setIsActive(form.lyrConfig().tabTGroup().chkGroupActive().getValue());

		if (form.getLocalContext().getbTumourGroupTaxonomyMappingsLoaded())
			voGroup.setTaxonomyMap(form.lyrConfig().tabPagTaxonomy().customGroupMapping().getValue());

		voGroup.setHasTNM(form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkHasTNM().getValue());
		voGroup.setHasOtherClassifications(form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkOtherClassifications().getValue());
		
		voGroup.setAssessment(form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().qmbLinkedAssessment().getValue());

		// If group supports TNM Staging, populate data from tabTNM
//		if (form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkHasTNM().getValue())
//		{
			if (!form.lyrConfig().tabTNM().isHeaderVisible())
			{
				// voGroup.setTNMValues(populateDataFromScreenForLyrConfigTabTNM(voGroup.getTNMValues()));
				voGroup.setTNMValues(((TumourGroupVo) form.getLocalContext().getOriginalRecord()).getTNMValues());
			}
			else
			{
				//wdev-13038
				if (form.getLocalContext().getSelectedRecord() instanceof TumourGroupVo)
					form.getLocalContext().setSelectedTNMCollection(((TumourGroupVo)form.getLocalContext().getSelectedRecord()).getTNMValues());
				//-------
				populateDataFromValuesTabs(form.getLocalContext().getCurrentSelectedTab());
				populateDataFromMappingsTabs(form.getLocalContext().getCurrentSelectedTab());

				// WDEV-11243
				voGroup.setTNMValues(form.getLocalContext().getSelectedTNMCollection());
			}
//		}

		// Populate tabSpecialty - check if they were changed
		if (Boolean.TRUE.equals(form.getLocalContext().getRefreshSpecialtyRecords()))
			voGroup.setAssociatedSpecialties(populateDataFromScreenForTabSpecialty(form.getLocalContext().getSpecialtiesSavedCollection()));

		// Populate tabClassification
		// if (form.getLocalContext().getbTumourStagingClassificationVoLoaded())
		voGroup.setOtherClassifications(populateDataFromScreenForTabClassification(form.getLocalContext().getOtherClassificationSavedCollection()));

		// Populate tabHistologyType - check if they were changed first
		if (Boolean.TRUE.equals(form.getLocalContext().getRefreshHistologyTypeRecords()))
		{
			voGroup.setHistologies(populateDataFromScreenForTabHistology(voGroup.getHistologies()));
		}

		// Populate tabHistologyGrades - check if they were changed first
		if (Boolean.TRUE.equals(form.getLocalContext().getRefreshHistologicGradeRecords()))
		{
			voGroup.setHistopathologicGrades(populateDataFromScreenForTabHistologicGrade(voGroup.getHistopathologicGrades()));
		}

		// Populate tabSerum
		if (Boolean.TRUE.equals(form.getLocalContext().getRefreshSerumMarkerRecords()))
		{
			voGroup.setSerumMarkers(populateDataFromScreenForTabSerum(voGroup.getSerumMarkers()));
		}

		// Populate over45
		voGroup.setTnmRequiresOver45(form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqO45().getValue() == false ? null : Boolean.TRUE);

		// Populate RequiresSerum
		voGroup.setTnmRequiresSMarkers(new Boolean(form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqSerumMarkers().getValue()));

		// Populate RequiresHistology
		voGroup.setTnmRequiresHisto(new Boolean(form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqHistology().getValue()));

		// Populate RequiresDifferentation
		voGroup.setTnmRequiresDiff(new Boolean(form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqDiff().getValue()));
		
		// Group Prognostic classification values
		voGroup.setIsPrognosticGroupingRelevant(form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkPrognosticGrouping().getValue());
		
		if (Boolean.TRUE.equals(voGroup.getIsPrognosticGroupingRelevant()) && !voGroup.getPrognosticGroupingConfigIsNotNull())
		{
			voGroup.setPrognosticGroupingConfig(new PrognosticGroupingCongfigVo());
		}
		
		if (voGroup.getPrognosticGroupingConfigIsNotNull())
		{
			// Populate Prognostic Tumour Location values
			tabPrognosticGroupingContainer tabPrognosticGrouping = form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping();
			// Set Prognostic relevant fields values
			voGroup.getPrognosticGroupingConfig().setUseTValues(tabPrognosticGrouping.chkUsesTValues().getValue());
			voGroup.getPrognosticGroupingConfig().setUseNValues(tabPrognosticGrouping.chkUsesNValues().getValue());
			voGroup.getPrognosticGroupingConfig().setUseMValues(tabPrognosticGrouping.chkUsesMValues().getValue());
			voGroup.getPrognosticGroupingConfig().setIsHistologicalTypePertinent(tabPrognosticGrouping.chkHistologyTypePrognosticGrouping().getValue());
			voGroup.getPrognosticGroupingConfig().setIsHistologicalGradePertinent(tabPrognosticGrouping.chkHistologicalGradePrognosticGrouping().getValue());
			voGroup.getPrognosticGroupingConfig().setIsTumourLocationPertinent(tabPrognosticGrouping.chkTumourLocationPrognosticGrouping().getValue());
			voGroup.getPrognosticGroupingConfig().setIsRiskCategoryPertinent(tabPrognosticGrouping.chkRiskCategoryPrognosticGrouping().getValue());
			voGroup.getPrognosticGroupingConfig().setIsPSAPertinent(tabPrognosticGrouping.chkPSAPrognosticGrouping().getValue());
			voGroup.getPrognosticGroupingConfig().setIsGleasonPertinent(tabPrognosticGrouping.chkGleasonPrognosticGrouping().getValue());

			// Get prognostic location, risk, PSA and gleason collections
			if (Boolean.TRUE.equals(form.getLocalContext().getRefreshTumourLocationRecords()))
				voGroup.getPrognosticGroupingConfig().setLocation(form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageTumourLocation().grdPrognosticLocation().getValues());
			if (Boolean.TRUE.equals(form.getLocalContext().getRefreshRiskCategoryRecords()))
				voGroup.getPrognosticGroupingConfig().setRisk(form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageRiskCategory().grdRiskCategory().getValues());
			if (Boolean.TRUE.equals(form.getLocalContext().getRefreshPSARecords()))
				voGroup.getPrognosticGroupingConfig().setPSA(form.lyrConfig().tabTGroup().lyrGroupDetails().tabPagePSA().grdPSA().getValues());
			if (Boolean.TRUE.equals(form.getLocalContext().getRefreshGleasonRecords()))
				voGroup.getPrognosticGroupingConfig().setGleason(form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGleason().grdGleason().getValues());
		}

		return voGroup;
	}
	
	@SuppressWarnings("unused")
	private void clearInstanceControls()
	{
		// Clear Category instance controls
		form.lyrConfig().tabTCategory().txtCatName().setValue(null);
		form.lyrConfig().tabTCategory().txtCatDescription().setValue(null);
		form.lyrConfig().tabTCategory().chkCatActive().setValue(null);
		form.lyrConfig().tabTCategory().customMappings().setValue(null);
		
		// Clear Version instance controls
		form.lyrConfig().tabTVersion().cmbVersion().clear();
		form.lyrConfig().tabTVersion().txtDescription().setValue(null);
		form.lyrConfig().tabTVersion().dteActiveTo().setValue(null);
		form.lyrConfig().tabTVersion().txtDescription().setValue(null);
		
		// Clear Group instance controls
		form.lyrConfig().tabTGroup().txtGroupName().setValue(null);
		form.lyrConfig().tabTGroup().txtGroupDescription().setValue(null);
		form.lyrConfig().tabTGroup().chkGroupActive().setValue(null);
		
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkHasTNM().setValue(null);
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().chkOtherClassifications().setValue(null);
		form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGroupDetails().qmbLinkedAssessment().clear();
		
			// Clear Group Details controls - TNM
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqHistology().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqSerumMarkers().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqDiff().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkReqO45().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabGroupTNM().chkPrognosticGrouping().setValue(null);
			
			// Clear Group Details controls - Other Classification
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabClassification().treOtherClassification().clear();
			
			// Clear Group Details controls - Prognostic Grouping
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkUsesTValues().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkUsesNValues().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkUsesMValues().setValue(null);

			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkHistologyTypePrognosticGrouping().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkHistologicalGradePrognosticGrouping().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkTumourLocationPrognosticGrouping().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkRiskCategoryPrognosticGrouping().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkPSAPrognosticGrouping().setValue(null);
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPrognosticGrouping().chkGleasonPrognosticGrouping().setValue(null);
			
			// Clear Group Details controls - Prognostic collections
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageTumourLocation().grdPrognosticLocation().getRows().clear();
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageRiskCategory().grdRiskCategory().getRows().clear();
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPagePSA().grdPSA().getRows().clear();
			form.lyrConfig().tabTGroup().lyrGroupDetails().tabPageGleason().grdGleason().getRows().clear();
			
		// Clear Group instance controls - TNM tab
		form.lyrConfig().tabTNM().chkActiveTNM().setValue(null);
		form.lyrConfig().tabTNM().GroupTNMValues().setValue(null);
		form.lyrConfig().tabTNM().lyrTNM().tabTNMValues().dynTNM().getRows().clear();
		form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().txtTNMValue().setValue(null);
		form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().txtTNMDescription().setValue(null);
		form.lyrConfig().tabTNM().lyrTNM().tabTNMMappings().customTNMMappings().clear();
		
		// Clear Group instance controls - Histology Type tab
		form.lyrConfig().tabHistologyType().grdHistology().getRows().clear();
		
		// Clear Group instance controls - Histological Grade tab
		form.lyrConfig().tabHistologyGrade().dyngrdDifferentation().getRows().clear();
		
		// Clear Group instance controls - Specialty Grade tab
		form.lyrConfig().tabSpecialties().treSpecialty().clear();
		
		// Clear Group instance controls - Serum Markers
		form.lyrConfig().tabSerumMarker().grdSerumMarkers().getRows().clear();
		
		// Clear Site instance controls
		form.lyrConfig().tabTSite().txtSiteName().setValue(null);
		form.lyrConfig().tabTSite().txtSiteDescription().setValue(null);
		form.lyrConfig().tabTSite().chkSiteActive().setValue(null);
		form.lyrConfig().tabTSite().chkSiteSpecificTNM().setValue(null);
		form.lyrConfig().tabTSite().chkSiteSpecificHistology().setValue(null);
		
		form.lyrConfig().tabTSite().customSiteMappings().clear();
		
		// Clear Taxonomy
		form.lyrConfig().tabPagTaxonomy().customGroupMapping().clear();
	}

	@Override
	protected void onGrdPrognosticLocationSelectionChanged() throws PresentationLogicException
	{
		updateControlsState();
	}

	@Override
	protected void onGrdPrognosticLocationSelectionCleared() throws PresentationLogicException
	{
		updateControlsState();
	}

	@Override
	protected void onGrdRiskCategorySelectionChanged() throws PresentationLogicException
	{
		updateControlsState();
	}

	@Override
	protected void onGrdRiskCategorySelectionCleared() throws PresentationLogicException
	{
		updateControlsState();
	}

	@Override
	protected void onGrdPSASelectionChanged() throws PresentationLogicException
	{
		updateControlsState();
	}

	@Override
	protected void onGrdPSASelectionCleared() throws PresentationLogicException
	{
		updateControlsState();
	}

	@Override
	protected void onGrdGleasonSelectionChanged() throws PresentationLogicException
	{
		updateControlsState();
	}

	@Override
	protected void onGrdGleasonSelectionCleared() throws PresentationLogicException
	{
		updateControlsState();
	}
}
