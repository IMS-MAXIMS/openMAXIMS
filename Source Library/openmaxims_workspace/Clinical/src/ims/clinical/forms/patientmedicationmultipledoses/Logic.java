//#############################################################################
//#                                                                           #
//#  Copyright (C) <2015>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#  IMS MAXIMS provides absolutely NO GUARANTEE OF THE CLINICAL SAFTEY of    #
//#  this program.  Users of this software do so entirely at their own risk.  #
//#  IMS MAXIMS only ensures the Clinical Safety of unaltered run-time        #
//#  software that it builds, deploys and maintains.                          #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Richard Reynolds using IMS Development Environment (version 1.80 build 5465.13953)
// Copyright (C) 1995-2015 IMS MAXIMS. All rights reserved.

package ims.clinical.forms.patientmedicationmultipledoses;

//This code was generated by Rory Fitzpatrick using IMS Development Environment (version 1.45 build 2287.24499)
//Copyright (C) 1995-2006 IMS MAXIMS plc. All rights reserved.

import ims.clinical.helper.MedicationDosesDynamicGridPopulation;
import ims.clinical.vo.ClinicalCodingVo;
import ims.clinical.vo.DiscontinueMedicationReasonValuesVo;
import ims.clinical.vo.MedicationOverViewFilterVo;
import ims.clinical.vo.MedicationOverViewLiteVo;
import ims.clinical.vo.MedicationOverViewLiteVoCollection;
import ims.clinical.vo.MedicationOverViewVo;
import ims.clinical.vo.lookups.CodingItemType;
import ims.clinical.vo.lookups.MedicationSnapShot;
import ims.configuration.gen.ConfigFlag;
import ims.core.patient.vo.PatientRefVo;
import ims.core.vo.Hcp;
import ims.core.vo.HcpCollection;
import ims.core.vo.HcpFilter;
import ims.core.vo.MedicationDose;
import ims.core.vo.MedicationDoseCollection;
import ims.core.vo.MedicationLiteVo;
import ims.core.vo.PatientMedicationVo;
import ims.core.vo.PatientMedicationVoCollection;
import ims.core.vo.PersonName;
import ims.core.vo.lookups.HcpDisType;
import ims.core.vo.lookups.LookupHelper;
import ims.core.vo.lookups.MedicationCommencedDiscontinuedType;
import ims.core.vo.lookups.MedicationCommencedDiscontinuedTypeCollection;
import ims.core.vo.lookups.MedicationRoute;
import ims.core.vo.lookups.MedicationRouteCollection;
import ims.core.vo.lookups.MedicationTimesOfAdministration;
import ims.core.vo.lookups.MedicationTimesOfAdministrationCollection;
import ims.domain.exceptions.StaleObjectException;
import ims.framework.controls.DynamicGridCell;
import ims.framework.controls.DynamicGridColumn;
import ims.framework.controls.DynamicGridRow;
import ims.framework.enumerations.DialogResult;
import ims.framework.enumerations.DynamicCellType;
import ims.framework.enumerations.FormMode;
import ims.framework.exceptions.CodingRuntimeException;
import ims.framework.exceptions.PresentationLogicException;
import ims.framework.utils.Date;
import ims.framework.utils.Image;
import ims.vo.interfaces.IClinicalCodingValue;

public class Logic extends BaseLogic
{		

	private static final Integer COL_DOSE_DOSE = new Integer(1);
	private static final Integer COL_DOSE_ROUTE = new Integer(2);
	private static final Integer COL_DOSE_TIMES = new Integer(3);
	private static final Integer COL_DOSE_COMMENCED_BY_TYPE = new Integer(4);
	private static final Integer COL_DOSE_COMMENCED_BY = new Integer(5);
	private static final Integer COL_DOSE_COMMENCED_DATE = new Integer(6);
	private static final Integer COL_DOSE_COMMENT = new Integer(7);

	private static final long serialVersionUID = 1L;

	protected void onFormOpen() throws ims.framework.exceptions.PresentationLogicException
	{
		initialize();
		initializeCustomControl();
		open(true);
		if (isDialog())
		{
			newMedicationInstance();
			return;
		}
		
		if (isMedicationMultipleDosesPatientLevel())
		{
			if (!(form.getGlobalContext().Core.getPatientShortIsNotNull() 
					&& form.getGlobalContext().Clinical.getMedMultipleDosesPatSearchCriteriaIsNotNull() 
					&& form.getGlobalContext().Core.getPatientShort().equals(form.getGlobalContext().Clinical.getMedMultipleDosesPatSearchCriteria().getPatientRef())))
			{
					form.getGlobalContext().Clinical.setMedMultipleDosesPatSearchCriteria(null);
			}
			setPatientSearchCriteria(form.getGlobalContext().Clinical.getMedMultipleDosesPatSearchCriteria());
		}
	}

	
	private MedicationOverViewFilterVo getSearchCriteria()
	{
		MedicationOverViewFilterVo searchCriteria = new MedicationOverViewFilterVo();
		
		searchCriteria.setType(form.getLocalContext().getScreenType());
		searchCriteria.setFilter(Boolean.TRUE.equals(form.chkFilter().getValue()) ? true : false);
		searchCriteria.setPatientRef(form.getGlobalContext().Core.getPatientShort());
		searchCriteria.setSelectedMedication(form.recbrOverviews().getValue());

		if (isMedicationMultipleDosesPatientLevel())
		{
			searchCriteria.setSelectedMedication(form.recbrOverviews().getValue());
		}
		
		return searchCriteria;
	}
	
	
	private void setPatientSearchCriteria(MedicationOverViewFilterVo medicationOverViewFilterVo)
	{
		if (form.chkFilter().isVisible() 
				&& medicationOverViewFilterVo != null 
				&& medicationOverViewFilterVo.getSelectedMedication() != null)
		{
			form.chkFilter().setValue(medicationOverViewFilterVo.getFilter());
			try
			{
				filterValueChange(false);
				form.recbrOverviews().setValue(medicationOverViewFilterVo.getSelectedMedication());
				onRecbrOverviewsValueChanged();
			}
			catch (PresentationLogicException e)
			{ e.printStackTrace(); }
			
			openOverview(domain.getMedicationOverView(form.recbrOverviews().getValue()));
		}
	}
	
	
	private void initializeCustomControl() 
	{
		form.ctnDetails().customControlCodingItem().setCodingItemType(CodingItemType.MEDICATION);
		form.ctnDetails().customControlCodingItem().setHotlist(new Boolean(false));	
		form.ctnDetails().customControlCodingItem().setIsRequired(true);
		form.customControlAuthoringInfo().setIsRequiredPropertyToControls(true);
	}

	
	private void initialize() 
	{
		form.setMode(FormMode.VIEW);
		
		MedicationDosesDynamicGridPopulation gridPopulation = getHelper();
		gridPopulation.initializeGrid();
		
		formatMedicationAndDosesGrids();
		
		if (isMedicationMultipleDosesPatientLevel())
			form.getLocalContext().setScreenType(MedicationSnapShot.PATIENT);
		
		if ( (form.getGlobalContext().Clinical.getReturnToFormNameIsNotNull())
			&& (form.getGlobalContext().Clinical.getReturnToFormName().equals(engine.getPreviousNonDialogFormName())) )
		{
			isBtnCloseVisible(true);
			form.lnkReturn().setVisible(true);
		}
		else
		{
			isBtnCloseVisible(false);
			form.lnkReturn().setVisible(false);
		}

		displayOrHideEnableDisableScreenSpecificControls();
	}

	
	private void displayOrHideEnableDisableScreenSpecificControls() 
	{
		form.ctnDetails().lblIncludeinTTO().setVisible(false);
		form.ctnDetails().chkTTO().setVisible(false);
		form.ctnDetails().lblNumDays().setVisible(false);
		form.ctnDetails().intNumDays().setVisible(false);
		form.recbrOverviews().setVisible(false);
		
		MedicationSnapShot screenType = form.getLocalContext().getScreenType();
		if (screenType != null)
		{
			if (form.getMode().equals(FormMode.VIEW) )
			{
				form.chkFilter().setVisible(false);
				form.setcustomControlAuthoringInfoEnabled(false);
				if (form.getLocalContext().getCurrentOverViewIsNotNull()) 
					form.chkFilter().setVisible(true);
			}
			else
			{
				form.setcustomControlAuthoringInfoEnabled(true);
				if (isDialog())
					isBtnCloseVisible(true);
			}
		}
	}

	
	protected void onFormDialogClosed(ims.framework.FormName formName, ims.framework.enumerations.DialogResult result) throws ims.framework.exceptions.PresentationLogicException
	{
		if (formName.equals(form.getForms().Clinical.MedicationDiscontinue) 
				&& result.equals(DialogResult.OK))
		{
			if (form.getLocalContext().getbDiscontinueMed().booleanValue())
			{
				PatientMedicationVo voMed = form.getLocalContext().getSelectedInstance();
				DiscontinueMedicationReasonValuesVo voReason = form.getGlobalContext().Clinical.getDiscontinueMedicationReasonValues();

				voMed.setIsDiscontinued(Boolean.TRUE);
				voMed.setIsDiscontinuedDate(voReason.getStoppedDate());
				voMed.setIsDiscontinuedHcp(voReason.getStoppedHCP());
				voMed.setDiscontinuedByType(voReason.getStoppedByType());
				voMed.setIsDiscontinuedReason(voReason.getStoppedReason());
				voMed.setIsDiscontinuedReasonText(voReason.getStoppedReasonDesc());
				
				for (int i = 0 ; i < voMed.getPrescribedDoses().size() ; i++)
				{
					MedicationDose voDose = voMed.getPrescribedDoses().get(i);

					voDose.setIsStopped(Boolean.TRUE);
					voDose.setIsStoppedDate(voReason.getStoppedDate());
					voDose.setIsStoppedHcp(voReason.getStoppedHCP());
					voDose.setStoppedByType(voReason.getStoppedByType());
					voDose.setIsStoppedReason(voReason.getStoppedReason());
					voDose.setIsStoppedReasonText(voReason.getStoppedReasonDesc());

					voMed.getPrescribedDoses().set(i, voDose);
				}

				form.getLocalContext().setSelectedInstance(voMed);
				
				MedicationOverViewVo voOverView = form.getLocalContext().getCurrentOverView();
				for (int i = 0 ; i < voOverView.getMedication().size() ; i++)
				{
					if (voMed.getID_PatientMedication().equals(voOverView.getMedication().get(i).getID_PatientMedication()))
						voOverView.getMedication().set(i, voMed);
				}

				String[] errors = voOverView.validate();
				if (errors != null)
				{
					engine.showErrors(errors);
				}
				
				try
				{
					PatientRefVo voPat = new PatientRefVo();
					voPat.setID_Patient(form.getGlobalContext().Core.getPatientShort().getID_Patient());
					form.getLocalContext().setCurrentOverView(domain.saveMedicationOverviewVo(voOverView, voPat));
				} 
				catch (StaleObjectException e) 
				{			
					engine.showMessage(e.getMessage());
				}		
				open(true);
			}
			
			else if (form.getLocalContext().getbDiscontinueDose().booleanValue())
			{
				MedicationDose voDose = (MedicationDose)form.ctnDetails().dyngrdDoses().getSelectedRow().getValue();
				DiscontinueMedicationReasonValuesVo voReason = form.getGlobalContext().Clinical.getDiscontinueMedicationReasonValues();

				voDose.setIsStopped(Boolean.TRUE);
				voDose.setIsStoppedDate(voReason.getStoppedDate());
				voDose.setIsStoppedHcp(voReason.getStoppedHCP());
				voDose.setIsStoppedReason(voReason.getStoppedReason());
				voDose.setIsStoppedReasonText(voReason.getStoppedReasonDesc());
				
				form.ctnDetails().dyngrdDoses().getSelectedRow().setValue(voDose);
				form.ctnDetails().dyngrdDoses().getSelectedRow().setBold(false);
				form.getContextMenus().getMedicationMultipleDosesDISCONTINUE_DOSEItem().setVisible(false);
				
			}
			form.getLocalContext().setbDiscontinueDose(Boolean.FALSE);
			form.getLocalContext().setbDiscontinueMed(Boolean.FALSE);
		}

		if (formName.equals(form.getForms().Core.TaxonomySearch) && result.equals(DialogResult.OK))
		{
		}
	}


	private void setReturnToFormDescription(PatientMedicationVo voOverView) 
	{
		if ( (form.getGlobalContext().Clinical.getReturnToFormNameIsNotNull())
				&& (form.getGlobalContext().Clinical.getReturnToFormName().equals(engine.getPreviousNonDialogFormName())) )
		{
			//Set the CDI Description for the return to form link
			String str = form.getGlobalContext().Clinical.getReturnToFormCDIDescriptionIsNotNull() ? form.getGlobalContext().Clinical.getReturnToFormCDIDescription() : "";
			StringBuffer sb = new StringBuffer();
			sb.append(str);
			if  (sb.length() > 0)
				sb.append(", ");
			
			sb.append(voOverView.getOtherMedicationText());
			
			form.getGlobalContext().Clinical.setReturnToFormCDIDescription(sb.toString());
			form.getGlobalContext().Clinical.setReturnToFormMode(FormMode.EDIT);
		}
	}

	
	private void clearAll()
	{
		form.customControlAuthoringInfo().setValue(null);
		clearInstanceControls();
	}
	
	
	private void open(Boolean search) 
	{		
		form.ctnDetails().setCollapsed(true);
		MedicationOverViewVo voOverView = new MedicationOverViewVo();

		PatientRefVo voPat = new PatientRefVo();
		voPat.setID_Patient(form.getGlobalContext().Core.getPatientShort().getID_Patient());
		MedicationOverViewFilterVo voFilter = getSearchCriteria();
		
		clearAll();

		MedicationOverViewLiteVoCollection voColl = null;
		
		if (search)
		{
 			voColl = domain.listMedicationOverviews(voFilter);
	
 			if (voColl == null)
 			{
 				engine.showMessage("There is no current Medication Overview for this patient.");
 				displayOrHideEnableDisableScreenSpecificControls();
 				return;
 			}
	 
 			for (int i = 0 ; i < voColl.size() ; i++)
 			{
 				MedicationOverViewLiteVo voOverLite = voColl.get(i);
 				StringBuffer sb = new StringBuffer();
 				sb.append(voOverLite.getTypeIsNotNull() ? voOverLite.getType().toString()+ ", " : "");
 				sb.append(voOverLite.getAuthoringInformationIsNotNull() ? voOverLite.getAuthoringInformation().toString(" - ") + ", " : "");
	 				
 				form.recbrOverviews().newRow(voOverLite, sb.toString());
 			}
	 			
 			if (voColl.size() > 0)
 			{
 				form.recbrOverviews().setValue(voColl.get(0));
 			}
		}

		if (form.recbrOverviews().getValue() != null)
		{
			voOverView = domain.getMedicationOverView(form.recbrOverviews().getValue());
			openOverview(voOverView);
		}

		form.setMode(FormMode.VIEW);
		displayOrHideEnableDisableScreenSpecificControls();
		form.getLocalContext().setSelectedInstance(null);
		
	}


	private void openOverview(MedicationOverViewVo voOverView) 
	{
		if (voOverView != null)
			domain.listMedications(voOverView);
		
		form.getLocalContext().setCurrentOverView(voOverView);
		
		MedicationDosesDynamicGridPopulation gridPopulation = getHelper();

		if ( (voOverView != null) && (voOverView.getMedicationIsNotNull()) )
		{
			if (form.chkFilter().getValue())
				gridPopulation.populateHideDiscontinued(voOverView);
			else	
				gridPopulation.populate(voOverView);
				
			//Defaulting Authoring HCP and Date
			form.customControlAuthoringInfo().setValue(voOverView.getAuthoringInformation());
		}
	}

	
	public void updateControlsState()
	{
		form.getContextMenus().hideAllMedicationMultipleMenuItems();
		form.getContextMenus().hideAllMedicationMultipleDosesMenuItems();
		
		boolean isRieMode = engine.isRIEMode();
	
		// Only possible to add/edit medications if current care context is in context
		if (form.getGlobalContext().Core.getCurrentCareContextIsNotNull() )
		{
			form.getContextMenus().getMedicationMultipleNEW_MEDICATIONItem().setVisible(form.getMode().equals(FormMode.VIEW) && !isRieMode);
			form.getContextMenus().getMedicationMultipleNEW_MEDICATIONItem().setEnabled(form.getMode().equals(FormMode.VIEW));
		

			form.getContextMenus().getMedicationMultipleUPDATE_MEDICATIONItem().setVisible( (form.getMode().equals(FormMode.VIEW) ) 
					&& (form.dyngrdMedication().getSelectedRow() != null) && !isRieMode);
			form.getContextMenus().getMedicationMultipleUPDATE_MEDICATIONItem().setEnabled( (form.getMode().equals(FormMode.VIEW) ) 
					&& (form.dyngrdMedication().getSelectedRow() != null) );
	
			form.getContextMenus().getMedicationMultipleDISCONTINUE_MEDICATIONItem().setVisible( (form.getMode().equals(FormMode.VIEW) ) 
					&& (form.dyngrdMedication().getSelectedRow() != null) && !isRieMode );
			form.getContextMenus().getMedicationMultipleDISCONTINUE_MEDICATIONItem().setEnabled( (form.getMode().equals(FormMode.VIEW) ) 
					&& (form.dyngrdMedication().getSelectedRow() != null) );
		
			form.getContextMenus().getMedicationMultipleDosesNEW_DOSEItem().setVisible(form.getMode().equals(FormMode.EDIT));
			form.getContextMenus().getMedicationMultipleDosesNEW_DOSEItem().setEnabled(form.getMode().equals(FormMode.EDIT));
		
			form.getContextMenus().getMedicationMultipleDosesDISCONTINUE_DOSEItem().setVisible( (form.getMode().equals(FormMode.EDIT) ) 
					&& (form.ctnDetails().dyngrdDoses().getSelectedRow() != null) );
			form.getContextMenus().getMedicationMultipleDosesDISCONTINUE_DOSEItem().setEnabled( (form.getMode().equals(FormMode.EDIT) ) 
					&& (form.ctnDetails().dyngrdDoses().getSelectedRow() != null) );
		
			if (form.getMode().equals(FormMode.EDIT))
			{
				form.ctnDetails().setcustomControlCodingItemEnabled(true);
				form.customControlAuthoringInfo().setIsRequiredPropertyToControls(true);
				form.customControlAuthoringInfo().setEnabledAuthoringHCP(true);
			}

		}
		else
		{
			form.customControlAuthoringInfo().setIsRequiredPropertyToControls(false);
			form.customControlAuthoringInfo().setEnabledAuthoringHCP(false);
		}
		
		form.ctnDetails().customControlCodingItem().setParentEditing(new Boolean(form.getMode().equals(FormMode.EDIT)));		
		
		// Adding medications: Only when referral is in context 
//		if (! form.getGlobalContext().Core.getCurrentCareContextIsNotNull() )
//		{
//			form.getContextMenus().getMedicationMultipleNEW_MEDICATIONItem().setEnabled(false);
//			form.getContextMenus().getMedicationMultipleNEW_MEDICATIONItem().setVisible(false);
//			form.getContextMenus().hideAllMedicationMultipleMenuItems();
//			form.getContextMenus().hideAllMedicationMultipleDosesMenuItems();			
//		}
	}


	protected void allowEditingInstanceControls(boolean bEditable)
	{
		/*	
		 * If the Medication chosen is Discontinued, only allow changes to the Source, all other controls to be readonly
		 */
		form.ctnDetails().qmbCommencedBy().setEnabled(bEditable);
		form.ctnDetails().cmbCommencedBy().setEnabled(bEditable);
		form.ctnDetails().dteCommenced().setEnabled(bEditable);
		form.ctnDetails().chkTTO().setEnabled(bEditable);
		form.ctnDetails().intNumDays().setEnabled(bEditable);
		form.ctnDetails().cmbFrequency().setEnabled(bEditable);
		form.ctnDetails().txtComment().setEnabled(bEditable);
		form.ctnDetails().txtComment().setEnabled(!(form.getLocalContext().getSelectedInstance().getIsDiscontinuedIsNotNull() ? form.getLocalContext().getSelectedInstance().getIsDiscontinued().booleanValue() : false));
		
		//For an update to a non-discontinued med only allow editing of Frequency and Source. Not allowed edit Doses. Can only add and remove them.
		form.ctnDetails().cmbFrequency().setEnabled(!(form.getLocalContext().getSelectedInstance().getIsDiscontinuedIsNotNull() ? form.getLocalContext().getSelectedInstance().getIsDiscontinued().booleanValue() : false));
	}
	
	
	protected void onFormModeChanged()
	{
		updateControlsState();
	}
	
	
	protected void onDyngrdMedicationRowSelectionChanged(ims.framework.controls.DynamicGridRow row)
	{
		if(form.getMode().equals(FormMode.EDIT)) return;
		
		form.ctnDetails().setCollapsed(false);
		updateControlsState();

		if (form.dyngrdMedication().getSelectedRow().getValue() instanceof PatientMedicationVo)
		{
			form.getLocalContext().setSelectedInstance((PatientMedicationVo)form.dyngrdMedication().getSelectedRow().getValue());
			populateInstanceControls((PatientMedicationVo)form.dyngrdMedication().getSelectedRow().getValue());

			PatientMedicationVo voMed = (PatientMedicationVo)form.dyngrdMedication().getSelectedRow().getValue();
			if ( (voMed.getIsDiscontinuedIsNotNull()) 
					&& (voMed.getIsDiscontinued().booleanValue()) )
				form.getContextMenus().getMedicationMultipleDISCONTINUE_MEDICATIONItem().setVisible(false);
		}
	}
	
	
	protected void onQmbCommencedByTextSubmited(String value) throws ims.framework.exceptions.PresentationLogicException
	{
		form.ctnDetails().qmbCommencedBy().clear();
		HcpFilter filter = new HcpFilter();
		PersonName name = new PersonName();
		name.setSurname(value);
		filter.setQueryName(name);
//		filter.setHcpType(HcpDisType.MEDICAL);
		
		HcpCollection voHCPColl = domain.listHcps(filter);
		
		if(voHCPColl != null)
		{
			for (int i = 0; i < voHCPColl.size(); i++)
			{
				form.ctnDetails().qmbCommencedBy().newRow(voHCPColl.get(i), voHCPColl.get(i).toString());
			}
			if (voHCPColl.size() == 1)
			{
				form.ctnDetails().qmbCommencedBy().setValue(voHCPColl.get(0));
			}
			else if (voHCPColl.size() > 1)
			{
				form.ctnDetails().qmbCommencedBy().showOpened();		
			}
		}
	}
	
	
	protected void onDyngrdDosesRowSelectionChanged(ims.framework.controls.DynamicGridRow row)
	{
		updateControlsState();
		updateDiscontinueDoseMenu();
	}
	
	
	private void updateDiscontinueDoseMenu() 
	{
		if (form.ctnDetails().dyngrdDoses().getSelectedRow().getValue() instanceof MedicationDose)
		{
			MedicationDose voDose = (MedicationDose)form.ctnDetails().dyngrdDoses().getSelectedRow().getValue();
			if ( (!voDose.getID_PatientMedicationDoseIsNotNull()) 
					|| (voDose != null 
						&& voDose.getIsStopped() != null 
						&& voDose.getIsStopped().booleanValue()))
				form.getContextMenus().getMedicationMultipleDosesDISCONTINUE_DOSEItem().setVisible(false);
		}
	}
	

	protected void onBtnThesarusSearchClick()
	{
		engine.open(form.getForms().Core.TaxonomySearch);
	}

	
	protected void onBtnCancelClick() throws ims.framework.exceptions.PresentationLogicException
	{
//		open(true);
		open(false); //WDEV-21114 Error discovered in UAT
		form.ctnDetails().chkTTO().setEnabled(false);
		form.ctnDetails().intNumDays().setEnabled(false);
	}
	
	
	protected void onBtnSaveClick() throws ims.framework.exceptions.PresentationLogicException
	{
		if (save())
			open(true);		
	}
	
	
	private void newMedicationInstance() 
	{
		form.ctnDetails().setCollapsed(false);
		PatientMedicationVo voNewInstance = new PatientMedicationVo();
		voNewInstance.setIsCopied(new Boolean(false));
		voNewInstance.setCareContext(form.getGlobalContext().Core.getCurrentCareContext());
		voNewInstance.setPatient(form.getGlobalContext().Core.getPatientShort());
		voNewInstance.setIsDiscontinued(Boolean.FALSE);
		form.getLocalContext().setSelectedInstance(voNewInstance);

		clearInstanceControls();
		setDefaultInstanceControls();
		form.setMode(FormMode.EDIT);
		displayOrHideEnableDisableScreenSpecificControls();
		allowEditingInstanceControls(true);
		
		//Defaulting Authoring HCP and Date
		form.ctnDetails().dteCommenced().setValue(new Date());
		form.ctnDetails().cmbCommencedBy().setValue(MedicationCommencedDiscontinuedType.MOS);
		Hcp hcp = (Hcp) domain.getHcpUser();
		if(hcp != null)
		{
			form.ctnDetails().qmbCommencedBy().newRow(hcp, hcp.toString());
			form.ctnDetails().qmbCommencedBy().setValue(hcp);
		}
		
		newMedicationDoseInstance();
		updateDiscontinueDoseMenu();
	}

	
	private void clearInstanceControls() 
	{
		form.ctnDetails().customControlCodingItem().clear();
		form.ctnDetails().cmbSource().setValue(null);
		form.ctnDetails().cmbFrequency().setValue(null);
		form.ctnDetails().qmbCommencedBy().setValue(null);
		form.ctnDetails().cmbCommencedBy().setValue(null);
		form.ctnDetails().dteCommenced().setValue(null);
		form.ctnDetails().chkTTO().setValue(false);
		form.ctnDetails().intNumDays().setValue(null);
		form.ctnDetails().dyngrdDoses().getRows().clear();
		form.ctnDetails().txtComment().setValue(null);
	}

	
	private void setDefaultInstanceControls() 
	{
		form.customControlAuthoringInfo().initializeComponent(HcpDisType.MEDICAL);
	}

	
	private void populateInstanceControls(PatientMedicationVo voSelectedInstance) 
	{
		form.ctnDetails().customControlCodingItem().setValue(voSelectedInstance);		
		form.ctnDetails().cmbSource().setValue(voSelectedInstance.getSourceofInformation());
		form.ctnDetails().cmbFrequency().setValue(voSelectedInstance.getFrequency());

		form.ctnDetails().chkTTO().setValue(voSelectedInstance.getIsInTTOIsNotNull() ? voSelectedInstance.getIsInTTO().booleanValue() : false);
		form.ctnDetails().intNumDays().setValue(voSelectedInstance.getNoDaysSupply());

		form.ctnDetails().cmbCommencedBy().setValue(voSelectedInstance.getCommencedByType());

		if (voSelectedInstance.getHcpCommencedIsNotNull())
		{
			form.ctnDetails().qmbCommencedBy().newRow(voSelectedInstance.getHcpCommenced(), voSelectedInstance.getHcpCommenced().getName().toString());
			form.ctnDetails().qmbCommencedBy().setValue(voSelectedInstance.getHcpCommencedIsNotNull() ? voSelectedInstance.getHcpCommenced() : null);
		}
		else
		{
			form.ctnDetails().qmbCommencedBy().setValue(null);
		}
		
		form.ctnDetails().dteCommenced().setValue(voSelectedInstance.getCommencedDate() != null ? new Date(voSelectedInstance.getCommencedDate()) : null); //WDEV-7141
		form.ctnDetails().txtComment().setValue(voSelectedInstance.getComment());
		
		fillDosesGridReadOnly(voSelectedInstance.getPrescribedDoses());
	}

	

	private void fillDosesGridWritable(MedicationDoseCollection prescribedDoses)
	{
		form.ctnDetails().dyngrdDoses().getRows().clear();
		
		for (int i = 0; i < prescribedDoses.size(); i++)
		{
			DynamicGridRow doseRow = form.ctnDetails().dyngrdDoses().getRows().newRow();
			
			MedicationDose dose = prescribedDoses.get(i);
			
			DynamicGridCell doseCell = doseRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_DOSE), DynamicCellType.STRING);
			doseCell.setStringMaxLength(255);
			doseCell.setValidationMessage("This text is restricted to 255 characters.");
			doseCell.setWidth(60);
			doseCell.setValue(dose.getDose());
			doseCell.setReadOnly(dose.getDose() != null && !"".equals(dose.getDose()));
			
			
			DynamicGridCell routeCell = doseRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_ROUTE), DynamicCellType.ENUMERATION);
			bindCellToLookup(routeCell, MedicationRoute.class);
			routeCell.setTooltip("Please select a Route");
			routeCell.setWidth(100);
			routeCell.setValue(dose.getAdminRoute());
			routeCell.setReadOnly(dose.getAdminRoute() != null);
			
			
			DynamicGridCell timesCell = doseRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_TIMES), DynamicCellType.MULTISELECT);
			bindCellToLookup(timesCell, MedicationTimesOfAdministration.class);
			timesCell.setTooltip("Please select Times");
			timesCell.setWidth(140);
			for (int j = 0; dose.getAdminTimes() != null && j < dose.getAdminTimes().size(); j++)
			{
				for (int k = 0; timesCell.getItems() != null && k < timesCell.getItems().size(); k++)
				{
					MedicationTimesOfAdministration adminTime = dose.getAdminTimes().get(j);
					if (timesCell.getItems().get(k).getValue().equals(adminTime))
						timesCell.getItems().get(k).setChecked(true);
				}	
			}
//			timesCell.setValue(dose.getAdminTimes());
			timesCell.setReadOnly(dose.getAdminTimes() != null && dose.getAdminTimes().size() > 0);
			
			
			DynamicGridCell commencedByTypeCell = doseRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_BY_TYPE), DynamicCellType.ENUMERATION);
			bindCellToLookup(commencedByTypeCell, MedicationCommencedDiscontinuedType.class);
			commencedByTypeCell.setTooltip("Please select a Commenced by Type");
			commencedByTypeCell.setAutoPostBack(true);
			commencedByTypeCell.setWidth(140);
			commencedByTypeCell.setValue(dose.getCommencedByType());
			commencedByTypeCell.setReadOnly(dose.getCommencedByType() != null);
			
			
			DynamicGridCell commencedByCell = doseRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_BY), DynamicCellType.QUERYCOMBOBOX);
			commencedByCell.setAutoPostBack(true);
			commencedByCell.setTooltip("Please select a HCP");
			commencedByCell.setWidth(160);
			if (dose.getDoseStartHcp() != null)
			{
				commencedByCell.getItems().newItem(dose.getDoseStartHcp(), dose.getDoseStartHcp().toString());
				commencedByCell.setValue(dose.getDoseStartHcp());
			}
			commencedByCell.setReadOnly(dose.getDoseStartHcp() != null);
			
			
			DynamicGridCell commencedDateCell = doseRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_DATE), DynamicCellType.DATE);
			commencedDateCell.setTooltip("Please select a Date.");
			commencedDateCell.setWidth(80);
			commencedDateCell.setValue(dose.getDoseStartDate());
			commencedDateCell.setReadOnly(dose.getDoseStartDate() != null);
			
			
			DynamicGridCell commentCell = doseRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENT), DynamicCellType.STRING);
			commentCell.setStringMaxLength(255);
			commentCell.setValidationMessage("This text is restricted to 255 characters.");
			commentCell.setTooltip("Please enter a Comment.");
			commentCell.setWidth(-1);
			commentCell.setValue(dose.getComment());
			commentCell.setReadOnly(dose.getComment() != null && !"".equals(dose.getComment()));
			
			
			doseRow.setValue(dose);
		}
	}

	
	private void fillDosesGridReadOnly(MedicationDoseCollection prescribedDoses) 
	{
		form.ctnDetails().dyngrdDoses().getRows().clear();
		for(int i = 0 ; i < prescribedDoses.size() ; i++)
		{
			DynamicGridRow childRow = form.ctnDetails().dyngrdDoses().getRows().newRow();
			
			MedicationDose voDose = prescribedDoses.get(i);
			
			DynamicGridCell cell1 = childRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_DOSE), DynamicCellType.LABEL);
			cell1.setValue(voDose.getDoseIsNotNull() ? voDose.getDose() : "");
			cell1.setTooltip(voDose.getDiscontinuedTooltip());
			cell1.setIdentifier(voDose.getDose());
//			cell1.setWidth(120);
			cell1.setWidth(60); //WDEV-21114

			DynamicGridCell cell2 = childRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_ROUTE), DynamicCellType.LABEL);
			cell2.setValue(voDose.getAdminRouteIsNotNull() ? voDose.getAdminRoute().toString() : "");
			cell2.setIdentifier(voDose.getAdminRoute());
//			cell2.setWidth(120);
			cell2.setWidth(100); //WDEV-21114

			DynamicGridCell cell3 = childRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_TIMES), DynamicCellType.LABEL);
			cell3.setValue(voDose.getAdminTimesIsNotNull() ? createTimesString(voDose.getAdminTimes()) : "");
			cell3.setTooltip(voDose.getAdminTimesIsNotNull() ? createTimesString(voDose.getAdminTimes()) : "");
			cell3.setIdentifier(voDose.getAdminTimes());
			cell3.setWidth(140);

			DynamicGridCell cell6 = childRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_BY_TYPE), DynamicCellType.LABEL);
			cell6.setValue(voDose.getCommencedByTypeIsNotNull() ? voDose.getCommencedByType().toString() : "");
			cell6.setIdentifier(voDose.getCommencedByType());
			cell6.setWidth(140);

			DynamicGridCell cell4 = childRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_BY), DynamicCellType.LABEL);
			cell4.setValue(voDose.getDoseStartHcpIsNotNull() ? voDose.getDoseStartHcp().toString() : "");
			cell4.setIdentifier(voDose.getDoseStartHcp());
			cell4.setWidth(160);

			DynamicGridCell cell5 = childRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_DATE), DynamicCellType.LABEL);
			cell5.setValue(voDose.getDoseStartDateIsNotNull() ? voDose.getDoseStartDate().toString() : null);
			cell5.setIdentifier(voDose.getDoseStartDate());
			cell5.setWidth(80);
			
			DynamicGridCell cell7 = childRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENT), DynamicCellType.LABEL);
			cell7.setValue(voDose.getCommentIsNotNull() ? voDose.getComment() : null);
			cell7.setIdentifier(voDose.getComment());
			cell7.setWidth(-1);
			
			
			childRow.setValue(voDose);			
			childRow.setExpanded(true);
			
			if ( (voDose.getIsStoppedIsNotNull()) && (voDose.getIsStopped().booleanValue()) )
			{
				childRow.setBold(false);
			}
			else
			{
				childRow.setBold(true);
			}
		}
	}

	
	private PatientMedicationVo populateInstanceData() 
	{
		PatientMedicationVo voSelectedInstance = form.getLocalContext().getSelectedInstance();
		
		if(voSelectedInstance == null)
		{
			voSelectedInstance = new PatientMedicationVo();
			voSelectedInstance.setCareContext(form.getGlobalContext().Core.getCurrentCareContext());
			voSelectedInstance.setPatient(form.getGlobalContext().Core.getPatientShort());
			voSelectedInstance.setIsDiscontinued(Boolean.FALSE);
		}

		IClinicalCodingValue voResult = form.ctnDetails().customControlCodingItem().getValue();

		if(voResult == null)
		{
			ClinicalCodingVo vo = new ClinicalCodingVo();
			vo.setIClinicalCodingValue(form.ctnDetails().customControlCodingItem().getSelectedItem());
			vo.setIClinicalCodingValueDescription(form.ctnDetails().customControlCodingItem().getDescription());
			if(vo.getIClinicalCodingValue()!=null && vo.getIClinicalCodingValueDescription()!=null)
				voResult = vo;
		}
		
		if (voResult != null)
		{
			if (voResult.getIClinicalCodingValue() instanceof MedicationLiteVo)
			{
				voSelectedInstance.setMedication((MedicationLiteVo) voResult.getIClinicalCodingValue());
				voSelectedInstance.setOtherMedicationText(voResult.getIClinicalCodingValueDescription());						
			}
			else
			{
				throw new CodingRuntimeException("MedicationLiteVo expected from component");
			}
		}
		else
		{
			voSelectedInstance.setOtherMedicationText(null);
		}

		voSelectedInstance.setSourceofInformation(form.ctnDetails().cmbSource().getValue());
		voSelectedInstance.setFrequency(form.ctnDetails().cmbFrequency().getValue());
		voSelectedInstance.setComment(form.ctnDetails().txtComment().getValue());

		voSelectedInstance.setIsInTTO(new Boolean(form.ctnDetails().chkTTO().getValue()));		
		voSelectedInstance.setNoDaysSupply(form.ctnDetails().intNumDays().getValue());
		
		voSelectedInstance.setHcpCommenced(form.ctnDetails().qmbCommencedBy().getValue());
		voSelectedInstance.setCommencedDate(form.ctnDetails().dteCommenced().getValue());
		voSelectedInstance.setCommencedByType(form.ctnDetails().cmbCommencedBy().getValue());

		voSelectedInstance.setAuthoringInformation(form.customControlAuthoringInfo().getValue());

		MedicationDoseCollection collDose = new MedicationDoseCollection();
		DynamicGridRow pRow;
		
		for(int i = 0 ; i < form.ctnDetails().dyngrdDoses().getRows().size() ; i++)
		{
			pRow = form.ctnDetails().dyngrdDoses().getRows().get(i);

			MedicationDose voDose = new MedicationDose();

			voDose = (MedicationDose) pRow.getValue();
			
			if (!voDose.getID_PatientMedicationDoseIsNotNull())
			{
				voDose.setDose((String) pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_DOSE)).getValue());
				voDose.setAdminRoute((MedicationRoute) pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_ROUTE)).getValue());
				
				DynamicGridCell cellTimes = pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_TIMES));
				MedicationTimesOfAdministrationCollection coll = new MedicationTimesOfAdministrationCollection();
				
				for(int j = 0 ; j < cellTimes.getItems().size() ; j++)
				{
					if (cellTimes.getItems().get(j).isChecked())
						coll.add((MedicationTimesOfAdministration) cellTimes.getItems().get(j).getValue());
				}

				voDose.setAdminTimes(coll);

				voDose.setCommencedByType((MedicationCommencedDiscontinuedType) pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_BY_TYPE)).getValue());

				voDose.setDoseStartDate((Date) pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_DATE)).getValue());
				voDose.setDoseStartHcp((Hcp) pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_BY)).getValue());

				voDose.setComment((String) pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENT)).getValue()); 

				voDose.setAuthoringInformation(form.customControlAuthoringInfo().getValue());
			}
			else if (voDose.getID_PatientMedicationDose() != null)
			{
				voDose.setDose((String) pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_DOSE)).getValue());
				voDose.setAdminRoute((MedicationRoute) pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_ROUTE)).getValue());

				DynamicGridCell cellTimes = pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_TIMES));
				MedicationTimesOfAdministrationCollection coll = new MedicationTimesOfAdministrationCollection();
				
				for(int j = 0 ; j < cellTimes.getItems().size() ; j++)
				{
					if (cellTimes.getItems().get(j).isChecked())
						coll.add((MedicationTimesOfAdministration) cellTimes.getItems().get(j).getValue());
				}

				voDose.setAdminTimes(coll);

				voDose.setCommencedByType((MedicationCommencedDiscontinuedType) pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_BY_TYPE)).getValue());

				voDose.setDoseStartDate((Date) pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_DATE)).getValue());
				voDose.setDoseStartHcp((Hcp) pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_BY)).getValue());

				voDose.setComment((String) pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENT)).getValue()); 
			}
			
			
			if(voDose.getDoseIsNotNull() 
					|| voDose.getAdminRouteIsNotNull() 
					|| voDose.getAdminTimes().size()>0
					|| voDose.getDoseStartDateIsNotNull() 
					|| voDose.getCommencedByTypeIsNotNull() 
					|| voDose.getDoseStartHcpIsNotNull())
			{
				collDose.add(voDose);
			}
			
		}
		
		voSelectedInstance.setPrescribedDoses(collDose);
		
		return voSelectedInstance;
	}

	
	public boolean save()
	{
		PatientMedicationVo currentInstance = populateInstanceData();
		
		MedicationOverViewVo voOverView = form.getLocalContext().getCurrentOverView();
		if (voOverView == null)
			voOverView = new MedicationOverViewVo();
		
		if (currentInstance.getID_PatientMedication() == null)
		{
			if (voOverView.getMedication() == null)
				voOverView.setMedication(new PatientMedicationVoCollection());
			
			voOverView.getMedication().add(currentInstance);
		}
		else
		{
			for (int i = 0 ; i < voOverView.getMedication().size() ; i++)
			{
				if (currentInstance.getID_PatientMedication().equals(voOverView.getMedication().get(i).getID_PatientMedication()))
					voOverView.getMedication().set(i, currentInstance);
			}
		}
		
		voOverView.setType(form.getLocalContext().getScreenType());
		
		if (!voOverView.getCareContextIsNotNull())
			voOverView.setCareContext(form.getGlobalContext().Core.getCurrentCareContext());

		voOverView.setAuthoringInformation(form.customControlAuthoringInfo().getValue());
		
		String[] errors = voOverView.validate(getUIValidationErrors(currentInstance));
		if (errors != null)
		{
			engine.showErrors(errors);
			return false;
		}
		
		try
		{
			PatientRefVo voPat = new PatientRefVo();
			voPat.setID_Patient(form.getGlobalContext().Core.getPatientShort().getID_Patient());
			form.getLocalContext().setCurrentOverView(domain.saveMedicationOverviewVo(voOverView, voPat));
			form.getLocalContext().setSelectedInstance(currentInstance);
			if (isDialog())
			{
				form.getGlobalContext().Clinical.setDialogFormName(engine.getFormName());
			}
		} 
		catch (StaleObjectException e) 
		{			
			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue()); //WDEV-17974
			open(true);
			form.dyngrdMedication().setValue(currentInstance);
			DynamicGridRow selectedRow = form.dyngrdMedication().getSelectedRow();
			if(selectedRow != null)
				onDyngrdMedicationRowSelectionChanged(selectedRow);
							
			return false;
		}		
		
		setReturnToFormDescription(currentInstance);
		return true;
	}

	private String[] getUIValidationErrors(PatientMedicationVo voPatientMedication)
	{
		if (voPatientMedication != null && voPatientMedication.getID_PatientMedication() == null && voPatientMedication.getPrescribedDoses().size() == 0)
		{
			return new String[]{"You must save at least one Dose with a new medication record"};
			
		}
		
		return null;
	}

	protected void onLnkReturnClick() throws ims.framework.exceptions.PresentationLogicException
	{
		engine.open(form.getGlobalContext().Clinical.getReturnToFormName());
	}
	
	private void formatMedicationAndDosesGrids() 
	{
		form.ctnDetails().dyngrdDoses().clear();
		
		form.ctnDetails().dyngrdDoses().setSelectable(true);
		
		DynamicGridColumn column = form.ctnDetails().dyngrdDoses().getColumns().newColumn("Dose");
		column.setIdentifier(COL_DOSE_DOSE);
//		column.setWidth(120);
		column.setWidth(60); //WDEV-21114
		column.setDynamicWidthSupported(true);
	
		column = form.ctnDetails().dyngrdDoses().getColumns().newColumn("Route");
		column.setIdentifier(COL_DOSE_ROUTE);
//		column.setWidth(120);
		column.setWidth(100); //WDEV-21114
		column.setDynamicWidthSupported(true);

		column = form.ctnDetails().dyngrdDoses().getColumns().newColumn("Times");
		column.setIdentifier(COL_DOSE_TIMES);
		column.setWidth(140);
		column.setDynamicWidthSupported(true);

		column = form.ctnDetails().dyngrdDoses().getColumns().newColumn("Commenced By Type");
		column.setIdentifier(COL_DOSE_COMMENCED_BY_TYPE);
		column.setWidth(140);

		column = form.ctnDetails().dyngrdDoses().getColumns().newColumn("Commenced By (HCP)");
		column.setIdentifier(COL_DOSE_COMMENCED_BY);
		column.setWidth(160);
		column.setDynamicWidthSupported(true);

		column = form.ctnDetails().dyngrdDoses().getColumns().newColumn("Date");
		column.setIdentifier(COL_DOSE_COMMENCED_DATE);
		column.setWidth(80);
		column.setDynamicWidthSupported(true);

		column = form.ctnDetails().dyngrdDoses().getColumns().newColumn("Comment");
		column.setIdentifier(COL_DOSE_COMMENT);
		column.setWidth(-1);
		column.setDynamicWidthSupported(true);

	}

	
	private void bindCellToLookup(DynamicGridCell cell, Class class1)
	{
		if(cell == null || class1 == null)
			throw new CodingRuntimeException("Coding Error - cell or class1 is null (bindCellToLookup)");
		
		if(class1.equals(MedicationRoute.class))
		{
			MedicationRouteCollection coll = LookupHelper.getMedicationRoute(domain.getLookupService());
			for(int i = 0 ; i < coll.size() ; i++)
			{
				cell.getItems().newItem(coll.get(i));
			}

			cell.setIdentifier(MedicationRoute.class);
		}
		if(class1.equals(MedicationTimesOfAdministration.class))
		{
			MedicationTimesOfAdministrationCollection coll = LookupHelper.getMedicationTimesOfAdministration(domain.getLookupService());
			for(int i = 0 ; i < coll.size() ; i++) 
				cell.getItems().newItem(coll.get(i));

			cell.setIdentifier(MedicationTimesOfAdministration.class);
		}
		
		if(class1.equals(MedicationCommencedDiscontinuedType.class))
		{
			MedicationCommencedDiscontinuedTypeCollection coll = LookupHelper.getMedicationCommencedDiscontinuedType(domain.getLookupService());
			
			for(int i = 0 ; i < coll.size() ; i++) 
				cell.getItems().newItem(coll.get(i));

			cell.setIdentifier(MedicationCommencedDiscontinuedType.class);
		}
		
		
		
	}

	protected void onContextMenuItemClick(int menuItemID, ims.framework.Control sender) throws ims.framework.exceptions.PresentationLogicException
	{
		if(sender.equals(form.dyngrdMedication()))
		{
			switch(menuItemID)
			{
				case GenForm.ContextMenus.MedicationMultiple.NEW_MEDICATION:
					newMedicationInstance();
				break;
				
				case GenForm.ContextMenus.MedicationMultiple.UPDATE_MEDICATION:
					updateMedicationInstance();
				break;
				
				case GenForm.ContextMenus.MedicationMultiple.DISCONTINUE_MEDICATION:
					discontinueMedicationInstance();
				break;
				
				default:
			}
		}
		else if(sender.equals(form.ctnDetails().dyngrdDoses()))
		{
			switch(menuItemID)
			{
				case GenForm.ContextMenus.MedicationMultipleDoses.NEW_DOSE:
					newMedicationDoseInstance();
				break;

				case GenForm.ContextMenus.MedicationMultipleDoses.DISCONTINUE_DOSE:
					discontinueMedicationDoseInstance();
				break;
				
				default:
			}
			updateDiscontinueDoseMenu();
		}

	}

	private void discontinueMedicationDoseInstance() 
	{
		DiscontinueMedicationReasonValuesVo voReason = new DiscontinueMedicationReasonValuesVo();
		
		if (form.ctnDetails().dyngrdDoses().getSelectedRow().getValue() instanceof MedicationDose) 
		{
			MedicationDose voDose = (MedicationDose)form.ctnDetails().dyngrdDoses().getSelectedRow().getValue();
			
			voReason.setStoppedDate(voDose.getIsStoppedDate());
			voReason.setStoppedHCP(voDose.getIsStoppedHcp());
			voReason.setStoppedReason(voDose.getIsStoppedReason());
			voReason.setStoppedReasonDesc(voDose.getIsStoppedReasonText());

			if ((voDose.getIsStoppedIsNotNull()) && (voDose.getIsStopped().booleanValue()) )
				form.getGlobalContext().Clinical.setDiscontinueMedicationReasonValues(voReason);
			else
				form.getGlobalContext().Clinical.setDiscontinueMedicationReasonValues(null);
		}

		form.getLocalContext().setbDiscontinueDose(Boolean.TRUE);
		form.getLocalContext().setbDiscontinueMed(Boolean.FALSE);

		engine.open(form.getForms().Clinical.MedicationDiscontinue, "Discontinue Dose");
	}


	private void newMedicationDoseInstance() 
	{
		DynamicGridRow doseRow = form.ctnDetails().dyngrdDoses().getRows().newRow();
		
		
		DynamicGridCell cell1 = doseRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_DOSE), DynamicCellType.STRING);
		
		cell1.setStringMaxLength(255);
		cell1.setValidationMessage("This text is restricted to 255 characters");
		cell1.setReadOnly(false);
		cell1.setTooltip("Please select a Dose");
//		cell1.setWidth(120);
		cell1.setWidth(60); //WDEV-21114

		DynamicGridCell cell2= doseRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_ROUTE), DynamicCellType.ENUMERATION);
		cell2.setReadOnly(false);
		bindCellToLookup(cell2, MedicationRoute.class);
		cell2.setTooltip("Please select a Route");
//		cell2.setWidth(120);
		cell2.setWidth(100); //WDEV-21114

		DynamicGridCell cell3 = doseRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_TIMES), DynamicCellType.MULTISELECT);
		cell3.setReadOnly(false);
		bindCellToLookup(cell3, MedicationTimesOfAdministration.class);
		cell3.setTooltip("Please select Times");
		cell3.setWidth(140);

		DynamicGridCell cell6= doseRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_BY_TYPE), DynamicCellType.ENUMERATION);
		cell6.setReadOnly(false);
		bindCellToLookup(cell6, MedicationCommencedDiscontinuedType.class);
		cell6.setValue(MedicationCommencedDiscontinuedType.MOS);
		cell6.setTooltip("Please select a Commenced by Type");
		cell6.setAutoPostBack(true);
		cell6.setWidth(140);

		
		DynamicGridCell cell4 = doseRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_BY), DynamicCellType.QUERYCOMBOBOX);
		Hcp hcp = (Hcp) domain.getHcpUser();
		if(hcp != null)
		{
			cell4.getItems().newItem(hcp);
			cell4.setValue(hcp);
		}
		cell4.setReadOnly(false);
		cell4.setAutoPostBack(true);
		cell4.setTooltip("Please select a HCP");
		cell4.setWidth(160);

		
		DynamicGridCell cell5 = doseRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_DATE), DynamicCellType.DATE);
		cell5.setValue(new Date());
		cell5.setReadOnly(false);
		cell5.setTooltip("Please select a Date");
		cell5.setWidth(80);
		
		DynamicGridCell cell7 = doseRow.getCells().newCell(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENT), DynamicCellType.STRING);
		cell7.setStringMaxLength(255);
		cell7.setValidationMessage("This text is restricted to 255 characters");
		cell7.setReadOnly(false);
		cell7.setTooltip("Please enter a Comment");
		cell7.setWidth(-1);
		

		doseRow.setExpanded(true);
		
		MedicationDose voNewDose = new MedicationDose();
		voNewDose.setIsCopied(new Boolean(false));
		doseRow.setValue(voNewDose);
		
		if  (!engine.isDialog()){
			form.ctnDetails().dyngrdDoses().resetScrollPosition();
			form.ctnDetails().dyngrdDoses().setSelectedRow(doseRow);
		}
		updateControlsState();
	}

	
	private void discontinueMedicationInstance() 
	{
		DiscontinueMedicationReasonValuesVo voReason = new DiscontinueMedicationReasonValuesVo();
		
		voReason.setStoppedDate(form.getLocalContext().getSelectedInstance().getIsDiscontinuedDate());
		voReason.setStoppedHCP(form.getLocalContext().getSelectedInstance().getIsDiscontinuedHcp());
		voReason.setStoppedReason(form.getLocalContext().getSelectedInstance().getIsDiscontinuedReason());
		voReason.setStoppedReasonDesc(form.getLocalContext().getSelectedInstance().getIsDiscontinuedReasonText());

		if ( (form.getLocalContext().getSelectedInstance().getIsDiscontinuedIsNotNull()) && (form.getLocalContext().getSelectedInstance().getIsDiscontinued().booleanValue()) )
			form.getGlobalContext().Clinical.setDiscontinueMedicationReasonValues(voReason);
		else
			form.getGlobalContext().Clinical.setDiscontinueMedicationReasonValues(null);

		form.getLocalContext().setbDiscontinueDose(Boolean.FALSE);
		form.getLocalContext().setbDiscontinueMed(Boolean.TRUE);
		
		engine.open(form.getForms().Clinical.MedicationDiscontinue);
	}

	
	private void updateMedicationInstance() 
	{
		form.setMode(FormMode.EDIT);
		
		allowEditingInstanceControls(!(form.getLocalContext().getSelectedInstance().getIsDiscontinuedIsNotNull() ? form.getLocalContext().getSelectedInstance().getIsDiscontinued().booleanValue() : false));
			
		if (form.getLocalContext().getSelectedInstance().getPrescribedDosesIsNotNull())
			fillDosesGridWritable(form.getLocalContext().getSelectedInstance().getPrescribedDoses());
		
		displayOrHideEnableDisableScreenSpecificControls();
		
		
		updateControlsState();
	}


	private String createTimesString(MedicationTimesOfAdministrationCollection voTimesColl) 
	{
		StringBuffer sb = new StringBuffer();
		for(int i = 0 ; i < voTimesColl.size() ; i++)
		{
			MedicationTimesOfAdministration lkpTime = voTimesColl.get(i);
			sb.append(lkpTime.toString());
			if (i < voTimesColl.size() - 1)
				sb.append(", ");
		}
		return sb.toString();
	}

	
	protected void onDyngrdDosesCellValueChanged(DynamicGridCell cell) 
	{
		if ( (cell != null)
				&& (cell.getType().getID() == DynamicCellType.ENUMERATION.getID())
				&& (cell.getIdentifier().equals(MedicationCommencedDiscontinuedType.class) ) )
		{
			if (cell.getValue() != null)
			{
				if (cell.getValue().equals(MedicationCommencedDiscontinuedType.MOS) )
				{
					DynamicGridRow pRow  = cell.getRow();
					DynamicGridCell cellQmbBy = pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_BY));
					Hcp hcp = (Hcp) domain.getHcpUser();
					if(hcp != null)
					{
						cellQmbBy.getItems().newItem(hcp);
						cellQmbBy.setValue(hcp);
					}
					cellQmbBy.setReadOnly(false);
					cellQmbBy.setAutoPostBack(true);
					cellQmbBy.setTooltip("Please select a HCP");
					cellQmbBy.setWidth(160);
				}
				else
				{
					DynamicGridRow pRow  = cell.getRow();
					DynamicGridCell cellQmbBy = pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_BY));
					cellQmbBy.setValue(null);
					cellQmbBy.setTypedText("");
				}
			}
			else
			{
				DynamicGridRow pRow  = cell.getRow();
				DynamicGridCell cellQmbBy = pRow.getCells().get(form.ctnDetails().dyngrdDoses().getColumns().getByIdentifier(COL_DOSE_COMMENCED_BY));
				cellQmbBy.setValue(null);
				cellQmbBy.setTypedText("");
			}
		}
	}

	
	protected void onDyngrdDosesCellTextSubmited(DynamicGridCell cell) 
	{
		if(cell.getType().getID() == DynamicCellType.QUERYCOMBOBOX.getID())
		{
			cell.getItems().clear();
			
			HcpFilter filter = new HcpFilter();
			PersonName name = new PersonName();
			name.setSurname(cell.getTypedText());
			filter.setQueryName(name);
//			filter.setHcpType(HcpDisType.MEDICAL);
			
			HcpCollection voHCPColl = domain.listHcps(filter);
			
			if(voHCPColl != null)
			{
				for (int i = 0; i < voHCPColl.size(); i++)
				{
					cell.getItems().newItem(voHCPColl.get(i));
				}
				if (voHCPColl.size() == 1)
				{
					cell.setValue(voHCPColl.get(0));
				}
				else if (voHCPColl.size() > 1)
				{
					cell.showOpened();		
				}
				
			}
		}
	}

	
	protected void onChkFilterValueChanged() throws PresentationLogicException 
	{
		filterValueChange(true);
	}

	
	private void filterValueChange(Boolean doSearch)
	{
		if (isMedicationMultipleDosesOnAdmission() || isDialog())
			form.getGlobalContext().Clinical.setMedMultipleDosesAdmSearchCriteia(getSearchCriteria());
		else if (isMedicationMultipleDosesOnDischarge())
			form.getGlobalContext().Clinical.setMedMultipleDosesDisSearchCriteria(getSearchCriteria());
		else if (isMedicationMultipleDosesOPD())
			form.getGlobalContext().Clinical.setMedMultipleDosesOPDSearchCriteria(getSearchCriteria());
		else if (isMedicationMultipleDosesPatientLevel())
			form.getGlobalContext().Clinical.setMedMultipleDosesPatSearchCriteria(getSearchCriteria());

		open(doSearch);
		
	}

	
	private MedicationDosesDynamicGridPopulation getHelper()
	{
		MedicationDosesDynamicGridPopulation gridPopulation = new MedicationDosesDynamicGridPopulation(form.dyngrdMedication(), form.getImages().Admin.Activity, form.getImages().ICP.Child, getDoImage(), form.getImages().Core.EditDisabled);
		return gridPopulation;
	}
	
	
	private Image getDoImage()
	{
		return isMedicationMultipleDosesOnDischarge() || isMedicationMultipleDosesOPD()?form.getImages().Core.Tick:null;
	}

	
	private boolean isMedicationMultipleDosesOnDischarge()
	{
		return engine.getFormName().equals(form.getForms().Clinical.MedicationMultipleDosesOnDischarge);
	}

	
	private boolean isMedicationMultipleDosesOPD()
	{
		return engine.getFormName().equals(form.getForms().Clinical.MedicationMultipleDosesOPD);
	}
	
	
	private boolean isMedicationMultipleDosesOnAdmission()
	{
		return engine.getFormName().equals(form.getForms().Clinical.MedicationMultipleDosesOnAdmission);
	}

	
	private boolean isMedicationMultipleDosesPatientLevel()
	{
//		return engine.getFormName().equals(form.getForms().Clinical.MedicationMultipleDosesPatientDetails);
		return true;
	}

	
	protected void onRecbrOverviewsValueChanged() throws PresentationLogicException 
	{
		MedicationOverViewVo voOverView = new MedicationOverViewVo();
		voOverView = domain.getMedicationOverView(form.recbrOverviews().getValue());
		
		if (voOverView != null)
			openOverview(voOverView);
		
		form.setMode(FormMode.VIEW);
		displayOrHideEnableDisableScreenSpecificControls();
		form.getGlobalContext().Clinical.setMedMultipleDosesPatSearchCriteria(getSearchCriteria());
	}

	
	protected void onCmbCommencedByValueChanged() throws PresentationLogicException 
	{
		if ( (form.ctnDetails().cmbCommencedBy().getValue() != null)
				&& (form.ctnDetails().cmbCommencedBy().getValue().equals(MedicationCommencedDiscontinuedType.MOS)) )
		{
			form.ctnDetails().qmbCommencedBy().setEnabled(true);
			defaultHCP();
		}
		else
		{
			form.ctnDetails().qmbCommencedBy().setEnabled(false);
			form.ctnDetails().qmbCommencedBy().setValue(null);
		}
		
	}
	
	
	private void defaultHCP() 
	{
		Hcp hcp = (Hcp) domain.getHcpUser();
		if(hcp != null)
		{
			form.ctnDetails().qmbCommencedBy().newRow(hcp, hcp.toString());
			form.ctnDetails().qmbCommencedBy().setValue(hcp);
		}
	}

	
	private boolean isDialog()
	{
		return engine.getFormName().equals(form.getForms().Clinical.MedicationMultipleDoses_Dialog);
	}

	
	private void isBtnCloseVisible(boolean value)
	{
		form.btnClose().setEnabled(value);
		form.btnClose().setVisible(value);
	}
	
	
	protected void onBtnCloseClick() throws PresentationLogicException
	{
		engine.close(DialogResult.OK);
	}
	
	
}
