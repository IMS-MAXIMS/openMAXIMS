//#############################################################################
//#                                                                           #
//#  Copyright (C) <2015>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#  IMS MAXIMS provides absolutely NO GUARANTEE OF THE CLINICAL SAFTEY of    #
//#  this program.  Users of this software do so entirely at their own risk.  #
//#  IMS MAXIMS only ensures the Clinical Safety of unaltered run-time        #
//#  software that it builds, deploys and maintains.                          #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Sean Nesbitt using IMS Development Environment (version 1.65 build 3202.18140)
// Copyright (C) 1995-2008 IMS MAXIMS plc. All rights reserved.

package ims.core.forms.addresssearch;

import java.util.ArrayList;

import ims.configuration.gen.ConfigFlag;
import ims.core.vo.DemographicControlsConfigVo;
import ims.core.vo.DemographicControlsConfigVoCollection;
import ims.core.vo.GeoCoOrdVo;
import ims.core.vo.PersonAddress;
import ims.domain.exceptions.DomainInterfaceException;
import ims.framework.enumerations.DialogResult;
import ims.framework.enumerations.FormMode;
import ims.framework.exceptions.PresentationLogicException;
import ims.framework.interfaces.IAddressProvider;

public class Logic extends BaseLogic
{
	@SuppressWarnings("unused")
	private static final long serialVersionUID = 1L;
	
	//wdev-19528
	private static final String ADDRESS1_DEMOGR 		= "DEM11";
	private static final String ADDRESS2_DEMOGR 		= "DEM12";
	private static final String ADDRESS3_DEMOGR 		= "DEM13";
	private static final String ADDRESS4_DEMOGR 		= "DEM14";
	private static final String ADDRESS5_DEMOGR 		= "DEM15";
	private static final String AREAOFRESIDENCE_DEMOGR 	= "DEM16";
	private static final String POST_CODE_DEMOGR 		= "DEM17";
	private static final String CCG_CODE_DEMOGR 		= "DEM18";
	private static final String COUNTY_DEMOGR 			= "DEM19";
	private static final String PHONE_DEMOGR 			= "DEM20";
	//----------

	private static final String PDS_LINE1					= "House/Building:"; //WDEV-21848
	private static final String PDS_LINE2					= "No. + Street:"; //WDEV-21848
	private static final String PDS_LINE3					= "Locality:";
	private static final String PDS_LINE4					= "Post Town:";
	private static final String PDS_LINE5					= "County:";
	
	@Override
	protected void onFormOpen(Object[] args) throws ims.framework.exceptions.PresentationLogicException
	{
		initialize();
	}

	private void initialize() 
	{
		if (ConfigFlag.UI.DEMOGRAPHICS_TYPE.getValue().equals("UK"))
		{			
			form.lblPostCode().setVisible(true);			
			form.txtPost().setVisible(true);
			form.txtPost().setEnabled(false);
			if (ConfigFlag.UI.DISPLAY_PCT_CODE.getValue())
			{
				form.lblPCTCode().setVisible(false);
				form.txtPctCode().setVisible(false);
				form.txtPctCode().setEnabled(false);
			}
			else
			{
				form.lblPCTCode().setVisible(false);
				form.txtPctCode().setVisible(false);
				form.txtPctCode().setEnabled(false);				
			}
			form.lblCounty().setVisible(false);
			form.cmbCounty().setVisible(false);			
			form.pnlAddressSearch().setVisible(ConfigFlag.UI.CAPSCAN_ENABLED.getValue());
			form.lblSearch().setVisible(ConfigFlag.UI.CAPSCAN_ENABLED.getValue());
			form.txtAddressSearchText().setVisible(ConfigFlag.UI.CAPSCAN_ENABLED.getValue());			
			form.imbPostCodeSearch().setVisible(ConfigFlag.UI.CAPSCAN_ENABLED.getValue());			
			form.txtAddressPhone().setEnabled(false);
			
			//wdev-19176
			form.txtAddress5().setVisible(true);
			form.lblAreaOfResidence1().setVisible(false);
			form.lblAreaOfResidence2().setVisible(false);
			form.cmbAreaOfResidence().setVisible(false);
			//----------
		}
		else if (ConfigFlag.UI.DEMOGRAPHICS_TYPE.getValue().equals("IRISH"))
		{			
			form.lblPostCode().setVisible(true);		//wdev-19176			
			form.txtPost().setVisible(true);			//wdev-19176
			form.lblPostCode().setVisible(true);		//wdev-19176
			form.lblPCTCode().setVisible(false);
			form.txtPctCode().setVisible(false);
			form.lblSearch().setVisible(false);
			form.txtAddressSearchText().setVisible(false);
			form.imbPostCodeSearch().setVisible(false);
			form.pnlAddressSearch().setVisible(false);
			form.lblSearch().setVisible(false);
			//wdev-19176
			form.txtAddress5().setVisible(false);
			form.lblAreaOfResidence1().setVisible(true);
			form.lblAreaOfResidence2().setVisible(true);
			form.cmbAreaOfResidence().setVisible(true);
			//----------
		}
		
		if(ConfigFlag.DOM.HEARTS_REPLICATE_PATIENTS.getValue())
			form.txtAddress5().setVisible(false);
		
		form.imbAddressHistory().setVisible(false);//WDEV-13009 only visible when set in form logic e.g. demographics 
		
		clearControl();	
		
		form.txtAddress5().setVisible(true);
		form.lblCounty().setVisible(false);
		form.cmbCounty().setVisible(false);
		
		form.lblLine1().setValue(isSVUH() ? "Address:" : PDS_LINE1);
		form.lblLine2().setValue(isSVUH() ? "" : PDS_LINE2);
		form.lblLine3().setValue(isSVUH() ? "" : PDS_LINE3);
		form.lblLine4().setValue(isSVUH() ? "" : PDS_LINE4);
		form.lblLine5().setValue(isSVUH() ? "" : PDS_LINE5);
		
		form.lblPostCode().setVisible(usePostCode());			
		form.txtPost().setVisible(usePostCode());
		
		form.txtAddress5().setVisible(!isSVUH());
	}

	private void clearControl() 
	{
		form.txtAddressSearchText().setValue("");
	}
	
	@Override
	protected void onFormDialogClosed(ims.framework.FormName formName, ims.framework.enumerations.DialogResult result) throws ims.framework.exceptions.PresentationLogicException
	{
		if (formName.equals(form.getForms().Core.AddressSelection) && result.equals(DialogResult.OK))
		{
			//display selected personAddress from GC
			form.getLocalContext().setaddressResult(form.getGlobalContext().Core.getPersonAddress());
			displayAddress();			
		}		
	}
		
	protected void displayAddress() 
	{
		//WDEV-15963
		boolean lbBuildingNameDisplayed = false;
		boolean lbBuildingNumberDisplayed = false;
		boolean lbPostTownDisplayed = false;
		boolean lbAddressStreetDisplayed = false;
		//WDEV-15963
		
		//WDEV-17696
		if (form.getMode().equals(FormMode.EDIT))
		{
			//display from local context
			if (form.getLocalContext().getaddressResult() != null)
			{
				if ((form.getLocalContext().getaddressResult().getAddressBuildingName() !=  null && !form.getLocalContext().getaddressResult().getAddressBuildingName().equals("")))
				{
					//address with building name
					if(ConfigFlag.DOM.HEARTS_REPLICATE_PATIENTS.getValue())
					{
						//WDEV-9025
						//WDEV-15963 
						//check length of address and display on available lines.						
						if (form.getLocalContext().getaddressResult().getOrganisationIsNotNull() && !form.getLocalContext().getaddressResult().getOrganisation().equals(""))
						{
							if (form.getLocalContext().getaddressResult().getOrganisation().length() 
									+ form.getLocalContext().getaddressResult().getAddressBuildingName().length() 
									<= ConfigFlag.DOM.HEARTS_ADDRESS_LINE_MAXLEN.getValue()) //including space and comma
							{
								lbBuildingNameDisplayed = true;
								form.txtAddress1().setValue(form.getLocalContext().getaddressResult().getOrganisation() + "," + form.getLocalContext().getaddressResult().getAddressBuildingName());																
							}
							else
							{
								form.txtAddress1().setValue(form.getLocalContext().getaddressResult().getOrganisation().substring(0, form.getLocalContext().getaddressResult().getOrganisation().length()<=30?form.getLocalContext().getaddressResult().getOrganisation().length():30));	
							}
						}
						else
						{
							form.txtAddress1().setValue(form.getLocalContext().getaddressResult().getAddressBuildingName());
							lbBuildingNameDisplayed = true;
						}

						if (lbBuildingNameDisplayed)
						{
							form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressBuildingNumber());
							lbBuildingNumberDisplayed = true;
						}
						else
						{
							if ((form.getLocalContext().getaddressResult().getAddressBuildingName() + "," + form.getLocalContext().getaddressResult().getAddressBuildingNumber()).length() 
									<= ConfigFlag.DOM.HEARTS_ADDRESS_LINE_MAXLEN.getValue())
							{
								form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressBuildingName() + "," + form.getLocalContext().getaddressResult().getAddressBuildingNumber());
								lbBuildingNumberDisplayed = true;
							}
							else
							{
								form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressBuildingName());								
							}							
						}
						 
						String address3 = "";
						if (lbBuildingNumberDisplayed)
						{
							address3 += form.getLocalContext().getaddressResult().getAddressLocality() != null ? form.getLocalContext().getaddressResult().getAddressLocality() : "";
							address3 += form.getLocalContext().getaddressResult().getAddressPostTown() != null ? (address3.length() > 0 ? "," : "") + form.getLocalContext().getaddressResult().getAddressPostTown() : "";
							lbPostTownDisplayed = true;
						}
						else
						{
							address3 += form.getLocalContext().getaddressResult().getAddressBuildingNumber() + ",";
							address3 += form.getLocalContext().getaddressResult().getAddressLocality() != null ? form.getLocalContext().getaddressResult().getAddressLocality() : "";
							
							if ((address3 + form.getLocalContext().getaddressResult().getAddressPostTown()).length() <= ConfigFlag.DOM.HEARTS_ADDRESS_LINE_MAXLEN.getValue())
							{
								address3 += form.getLocalContext().getaddressResult().getAddressPostTown() != null ? (address3.length() > 0 ? "," : "") + form.getLocalContext().getaddressResult().getAddressPostTown() : "";
								lbPostTownDisplayed = true;
							}							
						}
						
						form.txtAddress3().setValue(address3);// 	WDEV-17432
						
						if (lbPostTownDisplayed)
							form.txtAddress4().setValue(form.getLocalContext().getaddressResult().getAddressCounty());
						else
							form.txtAddress4().setValue(form.getLocalContext().getaddressResult().getAddressPostTown() != null ? 
									form.getLocalContext().getaddressResult().getAddressPostTown() + "," + form.getLocalContext().getaddressResult().getAddressCounty() : "" 
									+ form.getLocalContext().getaddressResult().getAddressCounty());
						
						//WDEV-15963
					}
					else
					{
						//WDEV-15963
						//check length of address and display on available lines.						
						if (form.getLocalContext().getaddressResult().getOrganisationIsNotNull() && !form.getLocalContext().getaddressResult().getOrganisation().equals(""))
						{
							if (form.getLocalContext().getaddressResult().getOrganisation().length() + form.getLocalContext().getaddressResult().getAddressBuildingName().length() 
									<= ConfigFlag.DOM.HEARTS_ADDRESS_LINE_MAXLEN.getValue())
							{
								lbBuildingNameDisplayed = true;
								form.txtAddress1().setValue(form.getLocalContext().getaddressResult().getOrganisation() + "," + form.getLocalContext().getaddressResult().getAddressBuildingName());								
							}
							else
							{
								form.txtAddress1().setValue(form.getLocalContext().getaddressResult().getOrganisation().substring(0, form.getLocalContext().getaddressResult().getOrganisation().length()<=30?form.getLocalContext().getaddressResult().getOrganisation().length():30));																
							}
						}
						else
						{
							form.txtAddress1().setValue(form.getLocalContext().getaddressResult().getAddressBuildingName());
							lbBuildingNameDisplayed = true;
						}

						if (form.getLocalContext().getaddressResult().getAddressStreet() != null && !form.getLocalContext().getaddressResult().getAddressStreet().equals(""))
						{
							if (form.getLocalContext().getaddressResult().getAddressLocality() != null && !form.getLocalContext().getaddressResult().getAddressLocality().equals(""))
							{
								//WDEV-15963
								if (lbBuildingNameDisplayed)
								{
									form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressStreet());
									lbBuildingNumberDisplayed = true; // at this point there will be no building number
								}
								else
								{
									//form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressBuildingName() + "," + form.getLocalContext().getaddressResult().getAddressStreet());
									if ((form.getLocalContext().getaddressResult().getAddressBuildingName() + "," + form.getLocalContext().getaddressResult().getAddressStreet()).length() 
											<= ConfigFlag.DOM.HEARTS_ADDRESS_LINE_MAXLEN.getValue())
									{
										form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressBuildingName() + "," + form.getLocalContext().getaddressResult().getAddressBuildingNumber());
										lbBuildingNameDisplayed = true;
										lbBuildingNumberDisplayed = true;
									}
									else
									{
										form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressBuildingName());										
									}							
								}									
								//WDEV-15963
								
								if (!lbBuildingNumberDisplayed)
								{
									form.txtAddress3().setValue(form.getLocalContext().getaddressResult().getAddressBuildingNumber() + "," +
											form.getLocalContext().getaddressResult().getAddressLocality());
								}
								else
									form.txtAddress3().setValue(form.getLocalContext().getaddressResult().getAddressLocality());
								
								form.txtAddress4().setValue(form.getLocalContext().getaddressResult().getAddressPostTown());
								form.txtAddress5().setValue(form.getLocalContext().getaddressResult().getAddressCounty());
								
							}
							else
							{
								//WDEV-15963
								if (lbBuildingNameDisplayed)
								{
									form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressStreet());
									lbBuildingNumberDisplayed = true;
								}
								else
								{
									//form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressBuildingName() + "," + form.getLocalContext().getaddressResult().getAddressStreet());
									if ((form.getLocalContext().getaddressResult().getAddressBuildingName() + "," + form.getLocalContext().getaddressResult().getAddressStreet()).length() 
											<= ConfigFlag.DOM.HEARTS_ADDRESS_LINE_MAXLEN.getValue())
									{
										form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressBuildingName() + "," + form.getLocalContext().getaddressResult().getAddressBuildingNumber());
										lbBuildingNameDisplayed = true;
										lbBuildingNumberDisplayed = true;
									}
									else
									{
										form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressBuildingName());										
									}																
								}
								//WDEV-15963
								
								if (!lbBuildingNumberDisplayed)
								{
									form.txtAddress3().setValue(form.getLocalContext().getaddressResult().getAddressBuildingNumber() + "," +
											form.getLocalContext().getaddressResult().getAddressPostTown());									
								}
								else
									form.txtAddress3().setValue(form.getLocalContext().getaddressResult().getAddressPostTown()!=null?form.getLocalContext().getaddressResult().getAddressPostTown():"");
								
								if (form.getLocalContext().getaddressResult().getAddressCounty() != null 
										&& !form.getLocalContext().getaddressResult().getAddressCounty().equals(form.getLocalContext().getaddressResult().getAddressPostTown()))// 	WDEV-17810
									form.txtAddress4().setValue(form.getLocalContext().getaddressResult().getAddressCounty());
								else
									form.txtAddress4().setValue("");
								form.txtAddress5().setValue("");
							}
						}
						else
						{
							if (form.getLocalContext().getaddressResult().getAddressLocality() != null && !form.getLocalContext().getaddressResult().getAddressLocality().equals(""))
							{
								//WDEV-15963
								if (lbBuildingNameDisplayed)
									form.txtAddress2().setValue("");//WDEV-15211
								else
									form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressBuildingName());
								//WDEV-15963
																
								form.txtAddress3().setValue(form.getLocalContext().getaddressResult().getAddressLocality());
								form.txtAddress4().setValue(form.getLocalContext().getaddressResult().getAddressPostTown());
								form.txtAddress5().setValue(form.getLocalContext().getaddressResult().getAddressCounty());					
							}
							else
							{
								form.txtAddress2().setValue("");//WDEV-15211
								form.txtAddress3().setValue(form.getLocalContext().getaddressResult().getAddressPostTown());
								form.txtAddress4().setValue(form.getLocalContext().getaddressResult().getAddressCounty());
								form.txtAddress5().setValue("");
							}					
						}
					}
				}
				else
				{					
					//WDEV-15963
					if (form.getLocalContext().getaddressResult().getOrganisationIsNotNull() 
							&& !form.getLocalContext().getaddressResult().getOrganisation().equals(""))
					{
						if ((form.getLocalContext().getaddressResult().getOrganisation() + "," + form.getLocalContext().getaddressResult().getAddressStreet()).length()
								<= ims.core.vo.PersonAddress.getLine1MaxLength())
						{
							form.txtAddress1().setValue(form.getLocalContext().getaddressResult().getOrganisation() + "," 
								+ form.getLocalContext().getaddressResult().getAddressStreet());
							lbAddressStreetDisplayed = true;
						}
						else
						{
							form.txtAddress1().setValue(form.getLocalContext().getaddressResult().getOrganisation().substring(0, form.getLocalContext().getaddressResult().getOrganisation().length()<=form.getLocalContext().getaddressResult().getLine1MaxLength()?form.getLocalContext().getaddressResult().getOrganisation().length():form.getLocalContext().getaddressResult().getLine1MaxLength()));
						}						
					}
					else
					{						
						form.txtAddress1().setValue(form.getLocalContext().getaddressResult().getAddressStreet());
						lbAddressStreetDisplayed = true;
					}
					
					
					if (form.getLocalContext().getaddressResult().getAddressLocality() != null && !form.getLocalContext().getaddressResult().getAddressLocality().equals(""))
					{
						if (!lbAddressStreetDisplayed)
						{
							form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressStreet() + "," 
									+ form.getLocalContext().getaddressResult().getAddressLocality());
						}
						else
							form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressLocality());
						
						form.txtAddress3().setValue(form.getLocalContext().getaddressResult().getAddressPostTown());
						
						if (form.getLocalContext().getaddressResult().getAddressCounty() != null && !form.getLocalContext().getaddressResult().getAddressCounty().equals(form.getLocalContext().getaddressResult().getAddressPostTown()))
							form.txtAddress4().setValue(form.getLocalContext().getaddressResult().getAddressCounty());
						else
							form.txtAddress4().setValue("");
						
						form.txtAddress5().setValue("");
					}
					else
					{
						form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressPostTown());
						form.txtAddress3().setValue(form.getLocalContext().getaddressResult().getAddressCounty());
						form.txtAddress4().setValue("");
						form.txtAddress5().setValue("");
					}					
				}

				form.txtPost().setValue(form.getLocalContext().getaddressResult().getAddressPostCode());
				form.txtPctCode().setValue(form.getLocalContext().getaddressResult().getPCT());
			}
		}
		else
		{
			//just display directly what was saved, i.e. no formatting
			form.txtAddress1().setValue(form.getLocalContext().getaddressResult().getAddressBuildingName());
			form.txtAddress2().setValue(form.getLocalContext().getaddressResult().getAddressBuildingNumber());
			form.txtAddress3().setValue(form.getLocalContext().getaddressResult().getAddressLocality());
			form.txtAddress4().setValue(form.getLocalContext().getaddressResult().getAddressPostTown());
			form.txtAddress5().setValue(form.getLocalContext().getaddressResult().getAddressCounty());
			form.cmbCounty().setValue(form.getLocalContext().getaddressResult().getCounty()); //WDEV-16531 - County removal fix
			form.txtPost().setValue(form.getLocalContext().getaddressResult().getAddressPostCode());			
			form.txtPctCode().setValue(form.getLocalContext().getaddressResult().getPCT());
		}
		//WDEV-17696
		
		//wdev-19176
		form.cmbAreaOfResidence().setValue(form.getLocalContext().getaddressResult().getAreaOfResidence());
		//-----
		
		//WDEV-21749
		StringBuffer txtAddress1Tooltip = new StringBuffer();
		StringBuffer txtAddress2Tooltip = new StringBuffer();
		StringBuffer txtAddress3Tooltip = new StringBuffer();
		StringBuffer txtAddress4Tooltip = new StringBuffer();
		StringBuffer txtAddress5Tooltip = new StringBuffer();

		txtAddress1Tooltip.append("House/Building Name");
		if (form.getLocalContext().getaddressResult().getAddressBuildingName() != null)
		{
			txtAddress1Tooltip.append("<br><b>" + form.getLocalContext().getaddressResult().getAddressBuildingName() + "</b>");
		}
		form.txtAddress1().setTooltip(txtAddress1Tooltip.toString());

		txtAddress2Tooltip.append("House/Building No., Street Name and Descriptor");
		if (form.getLocalContext().getaddressResult().getAddressBuildingNumber() != null)
		{
			txtAddress2Tooltip.append("<br><b>" + form.getLocalContext().getaddressResult().getAddressBuildingNumber() + "</b>");
		}
		form.txtAddress2().setTooltip(txtAddress2Tooltip.toString());
		
		txtAddress3Tooltip.append("Locality");
		if (form.getLocalContext().getaddressResult().getAddressLocality() != null)
		{
			txtAddress3Tooltip.append("<br><b>" + form.getLocalContext().getaddressResult().getAddressLocality() + "</b>");
		}
		form.txtAddress3().setTooltip(txtAddress3Tooltip.toString());

		txtAddress4Tooltip.append("Post Town");
		if (form.getLocalContext().getaddressResult().getAddressPostTown() != null)
		{
			txtAddress4Tooltip.append("<br><b>" + form.getLocalContext().getaddressResult().getAddressPostTown() + "</b>");
		}
		form.txtAddress4().setTooltip(txtAddress4Tooltip.toString());

		txtAddress5Tooltip.append("County");
		if (form.getLocalContext().getaddressResult().getAddressCounty() != null)
		{
			txtAddress5Tooltip.append("<br><b>" + form.getLocalContext().getaddressResult().getAddressCounty() + "</b>");
		}
		form.txtAddress5().setTooltip(txtAddress5Tooltip.toString());
		//WDEV-21749
	}
	private void displayPhone() 
	{
		//display phonenumber
		form.txtAddressPhone().setValue(form.getLocalContext().getaddressResult().getPhone());		
	}

	@Override
	protected void onFormModeChanged()
	{
		form.txtPost().setEnabled(form.getMode().equals(FormMode.EDIT));
		form.txtPctCode().setEnabled(form.getMode().equals(FormMode.EDIT));
		form.txtAddressSearchText().setEnabled(form.getMode().equals(FormMode.EDIT));
		form.imbPostCodeSearch().setEnabled(form.getMode().equals(FormMode.EDIT));
		form.txtAddressPhone().setEnabled(form.getMode().equals(FormMode.EDIT));
		form.cmbCounty().setEnabled(form.getMode().equals(FormMode.EDIT));	
		form.cmbAreaOfResidence().setEnabled(form.getMode().equals(FormMode.EDIT));		//wdev-19176
		form.txtAddressSearchText().setTooltip(FormMode.EDIT.equals(form.getMode()) ? "Enter a post code or keywords from the first or second line of the address" : null); //WDEV-17700
	}
	
	@Override
	protected void onImbPostCodeSearchClick() throws PresentationLogicException 
	{
		// Address provider helper
		IAddressProvider l_addressprovider = engine.getAddressProvider();
		if(l_addressprovider == null)
			throw new PresentationLogicException("Please Configure Address Provider");

		PersonAddress personAddress = new PersonAddress();
		PersonAddress[] personAddressResult = new PersonAddress[0];
				
		//Funtionality
		//To initiate search, the user will use either the poscode field or an additional address search field located on the right of the poscode field
		//The poscode field will initiate a search of type POSTCODE
		//the additional address search field will initiate a search of type BROWSE with input ADDR
				
		try
		{			
			if (form.txtAddressSearchText().getValue() != null && !form.txtAddressSearchText().getValue().equals(""))
			{
				personAddress.setAddressSearchText(form.txtAddressSearchText().getValue());// search criteria comma delimited.
				form.getGlobalContext().Core.setAddressSearchType("SEARCH");
			}
			else
			{
				engine.showMessage("Please enter a post code or keywords from the first or second line of the address.");
				return;
			}
			personAddressResult = (PersonAddress[])l_addressprovider.getAddress(personAddress,form.getGlobalContext().Core.getAddressSearchType(),"",""); // return result or ambiglist
		}
		catch (PresentationLogicException pe)
		{
			engine.showMessage(pe.getMessage());
		}
		
		//fill out rest of address fields if somthing found
		if (personAddressResult != null && personAddressResult.length == 1)
		{
			//exact match
			form.getLocalContext().setaddressResult(personAddressResult[0]);
			displayAddress();
		}
		else
		{
			form.getGlobalContext().Core.setAddressSearchText(form.txtAddressSearchText().getValue());
			form.getGlobalContext().Core.setPersonAddress(personAddress);
			engine.open(form.getForms().Core.AddressSelection);
		}						
	}
	//------------------- Component Interface methods ---------------------------
	
	public void setEnabled(Boolean value)
	{
		if (value != null)
		{			
			form.txtAddressSearchText().setEnabled(value);
			form.imbPostCodeSearch().setEnabled(value);
		}
	}
	public void setComponentEnabled(Boolean value)
	{
		if (Boolean.TRUE.equals(value))
		{
				form.setMode(FormMode.EDIT);
				form.txtAddressSearchText().setTooltip("Enter a post code or keywords from the first or second line of the address"); 
		}
			else if (Boolean.FALSE.equals(value))
		{
				form.setMode(FormMode.VIEW);
				form.txtAddressSearchText().setTooltip(null);
		}		
		
		form.txtAddress5().setEnabled(!isPds() && Boolean.TRUE.equals(value));
	}
	
	private boolean isPds()
	{
		return !"None".equals(ConfigFlag.DOM.USE_PDS.getValue());
	}

	public void isRequired(Boolean value) 
	{
		if (value != null)
		{
			if (ConfigFlag.UI.DEMOGRAPHICS_TYPE.getValue().equals("UK"))
			{
				form.txtPost().setRequired(value);
				if (ConfigFlag.UI.DISPLAY_PCT_CODE.getValue())
					form.txtPctCode().setRequired(value);
			}
			else if (ConfigFlag.UI.DEMOGRAPHICS_TYPE.getValue().equals("IRISH"))
			{
				form.txtPost().setVisible(false);
				form.txtPctCode().setVisible(false);
			}
			
			form.getLocalContext().setIsRequired(value);
		}
	}

	public void clear() 
	{
		form.txtAddressSearchText().setValue(null);
	}

	public String getError(String labelName) 
	{
		if (form.getLocalContext().getIsRequiredIsNotNull() && form.getLocalContext().getIsRequired())
		{
			if(labelName == null || (labelName != null && labelName.length() == 0))
			{
				labelName = "Post Code";
			}
			
			String label = labelName.charAt(labelName.length() - 1) == ' ' ? labelName : labelName + " ";
			
			if (form.txtAddressSearchText().getValue() == null)
				return new String(label + "is mandatory");
		}
		
		return null;
	}

	public void setValue(ims.core.vo.PersonAddress address) 
	{
		// fill patient address
		if (address == null)
		{
			address = new PersonAddress();
		}
		
		form.getLocalContext().setaddressResult(address);
		form.getGlobalContext().Core.setPersonAddress(address);
		displayAddress();
		displayPhone();
	}
	
	public ims.core.vo.PersonAddress getValue() 
	{		
		if (form.getLocalContext().getaddressResultIsNotNull())
			return getlines((PersonAddress) form.getLocalContext().getaddressResult().clone());
		return null;		
	}
	
	private PersonAddress getlines(PersonAddress addressResult)
	{
		if (addressResult == null)
			return null;
		
		addressResult.setLine1((form.txtAddress1().getValue()));
		addressResult.setLine2((form.txtAddress2().getValue()));
		addressResult.setLine3((form.txtAddress3().getValue()));
		addressResult.setLine4((form.txtAddress4().getValue()));
		if(ConfigFlag.DOM.HEARTS_REPLICATE_PATIENTS.getValue())
			addressResult.setLine5("");
		else
			addressResult.setLine5((form.txtAddress5().getValue()));
		
		addressResult.setAreaOfResidence(form.cmbAreaOfResidence().getValue());		//wdev-19176
		addressResult.setCounty(form.cmbCounty().getValue()); //WDEV-17700
		addressResult.setPostCode(form.txtPost().getValue()); //WDEV-17700
		
		return addressResult;
	}
	
	public void clearscreen() 
	{
		form.txtAddress1().setValue(null);
		form.txtAddress2().setValue(null);
		form.txtAddress3().setValue(null);
		form.txtAddress4().setValue(null);
		form.txtAddress5().setValue(null);
		form.cmbAreaOfResidence().setValue(null);	//wdev-19176
		form.txtAddressPhone().setValue(null);
		form.txtAddressSearchText().setValue(null);
		form.txtPost().setValue(null);
		form.txtPctCode().setValue(null);
		form.cmbCounty().setValue(null);
		
		form.getLocalContext().setaddressResult(null); //WDEV-14367
	
	}

	@Override
	protected void onCmbCountyValueChanged() throws PresentationLogicException 
	{		
		// update local context
		if (form.getLocalContext().getaddressResult() == null)
		{
			form.getLocalContext().setaddressResult(new PersonAddress());
		}
		form.getLocalContext().getaddressResult().setCounty(form.cmbCounty().getValue()); //WDEV-16531 - County removal fix
		if (form.cmbCounty().getValue() !=  null)
		{
			form.getLocalContext().getaddressResult().setAddressCounty(form.cmbCounty().getValue().getIItemText());
		}		
	}

	@Override
	protected void onTxtAddress1ValueChanged() throws PresentationLogicException 
	{
		// update local context
		if (form.getLocalContext().getaddressResult() == null)
		{
			form.getLocalContext().setaddressResult(new PersonAddress());
		}
		
//		form.getLocalContext().getaddressResult().setAddressBuildingNumber(form.txtAddress1().getValue());
//		form.getLocalContext().getaddressResult().setAddressBuildingName(form.txtAddress1().getValue());
		form.getLocalContext().getaddressResult().setLine1(form.txtAddress1().getValue());
		
	}

	@Override
	protected void onTxtAddress2ValueChanged() throws PresentationLogicException 
	{
		// update local context
		if (form.getLocalContext().getaddressResult() == null)
		{
			form.getLocalContext().setaddressResult(new PersonAddress());
		}
	
//		form.getLocalContext().getaddressResult().setAddressLocality(form.txtAddress2().getValue());		
//		form.getLocalContext().getaddressResult().setAddressBuildingNumber(form.txtAddress2().getValue());
		form.getLocalContext().getaddressResult().setLine2(form.txtAddress2().getValue());
	}

	@Override
	protected void onTxtAddress3ValueChanged() throws PresentationLogicException 
	{
		// update local context
		if (form.getLocalContext().getaddressResult() == null)
		{
			form.getLocalContext().setaddressResult(new PersonAddress());
		}
	
//		form.getLocalContext().getaddressResult().setAddressPostTown((form.txtAddress3().getValue()));				
//		form.getLocalContext().getaddressResult().setAddressLocality((form.txtAddress3().getValue()));
		form.getLocalContext().getaddressResult().setLine3(form.txtAddress3().getValue());
	}

	@Override
	protected void onTxtAddress4ValueChanged() throws PresentationLogicException 
	{
		// update local context
		if (form.getLocalContext().getaddressResult() == null)
		{
			form.getLocalContext().setaddressResult(new PersonAddress());
		}
	
//		form.getLocalContext().getaddressResult().setAddressCounty((form.txtAddress4().getValue()));						
//		form.getLocalContext().getaddressResult().setAddressPostTown((form.txtAddress4().getValue()));
		form.getLocalContext().getaddressResult().setLine4(form.txtAddress4().getValue());
	}

	@Override
	protected void onTxtAddress5ValueChanged() throws PresentationLogicException 
	{
		// update local context
		if (form.getLocalContext().getaddressResult() == null)
		{
			form.getLocalContext().setaddressResult(new PersonAddress());
		}
	
///		form.getLocalContext().getaddressResult().setAddressLine5((form.txtAddress5().getValue()));
		form.getLocalContext().getaddressResult().setLine5(form.txtAddress5().getValue());
	}

	@Override
	protected void onTxtAddressPhoneValueChanged() throws PresentationLogicException 
	{
		// update local context
		if (form.getLocalContext().getaddressResult() == null)
		{
			form.getLocalContext().setaddressResult(new PersonAddress());
		}
	
		form.getLocalContext().getaddressResult().setPhone((form.txtAddressPhone().getValue()));						
		
	}

	@Override
	protected void onTxtPostValueChanged() throws PresentationLogicException 
	{
		// update local context
		if (form.getLocalContext().getaddressResult() == null)
		{
			form.getLocalContext().setaddressResult(new PersonAddress());
		}
	
		form.getLocalContext().getaddressResult().setPostCode((form.txtPost().getValue()));								
	}
	
	protected void onTxtPctCodeValueChanged() throws PresentationLogicException 
	{
		// update local context
		if (form.getLocalContext().getaddressResult() == null)
		{
			form.getLocalContext().setaddressResult(new PersonAddress());
		}
	
		form.getLocalContext().getaddressResult().setPCTcode((form.txtPctCode().getValue()));								
		
	}

	public void setPhoneVisible(Boolean value) 
	{
		form.lblAddressPhone().setVisible(value);
		form.txtAddressPhone().setVisible(value);
	}
	
	public void setHistoricAddressBtnVisible(Boolean value) 
	{
		form.imbAddressHistory().setVisible(value);
	}

	public void setSearchControlsVisible(Boolean value) 
	{
		form.pnlAddressSearch().setVisible(value);
		form.lblSearch().setVisible(value);
		form.txtAddressSearchText().setVisible(value);
		form.imbPostCodeSearch().setVisible(value);
	}
	
	public void setTitle(String title) 
	{
		form.pnlAddressSearch().setValue(title);
	}

	public String verifyPCT(String postCode)
	{
		// Address provider helper
		IAddressProvider l_addressprovider = engine.getAddressProvider();
		if(l_addressprovider == null)
			return null;

		PersonAddress address = new PersonAddress();
		PersonAddress[] personAddressResult = new PersonAddress[0];
		
		String l_pctCode = form.txtPctCode().getValue();
		
		if (ConfigFlag.UI.DISPLAY_PCT_CODE.getValue())
		{		
			if ((l_pctCode != null) && (l_pctCode != ""))
			{
											
				try
				{			
					if (form.txtPost().getValue() != null && !form.txtPost().getValue().equals(""))
					{
						form.getGlobalContext().Core.setAddressSearchType("SEARCH");
					}
					address.setAddressSearchText(postCode);
					personAddressResult = (PersonAddress[])l_addressprovider.getAddress(address,form.getGlobalContext().Core.getAddressSearchType(),"",""); // return result or ambiglist
				}
				catch (PresentationLogicException pe)
				{
					engine.showMessage(pe.getMessage());
				}
				
				boolean l_match = true;
				
				//fill out rest of address fields if somthing found
				if (personAddressResult == null)
					return null;
				
				if (personAddressResult != null && personAddressResult.length == 1)
				{
					//possible exact match
					if (personAddressResult[0].getPCTIsNotNull())
					{
						if (l_pctCode.equalsIgnoreCase(personAddressResult[0].getPCT()))
						{
							l_match = true;
						}
						else
							l_match = false;						
					}
				}
				else
				{
					PersonAddress pa = null;				
					for (int i =0; i< personAddressResult.length; i++)
					{
						pa = personAddressResult[i];
						if (pa.getPctCode() != null)
						{
							if (!l_pctCode.equalsIgnoreCase(pa.getPctCode()))
									l_match = false;
						}
					}
				}						
				
				if (l_match)
					return personAddressResult[0].getPCT();
				else
					return null;
			}
			else
			{
				//automatically fill in the pct if a postcode is given on editing, i.e. not through capscan
				if (form.txtPost().getValue() != "")
				{
					try
					{			
						if (form.txtPost().getValue() != null && !form.txtPost().getValue().equals(""))
						{
							form.getGlobalContext().Core.setAddressSearchType("SEARCH");
						}
						address.setAddressSearchText(postCode);
						personAddressResult = (PersonAddress[])l_addressprovider.getAddress(address,form.getGlobalContext().Core.getAddressSearchType(),"",""); // return result or ambiglist
					}
					catch (PresentationLogicException pe)
					{
						engine.showMessage(pe.getMessage());
					}
					
					//fill out rest of address fields if somthing found
					if (personAddressResult == null)
						return null;
					
					if (personAddressResult != null && personAddressResult.length >= 1)
					{
						//possible match
						if (personAddressResult[0].getPCTIsNotNull() && personAddressResult[0].getPCT() != "")
						{						
							form.txtPctCode().setValue(personAddressResult[0].getPCT());
							if (form.getLocalContext().getaddressResult() != null)
							{
								form.getLocalContext().getaddressResult().setPCT(form.txtPctCode().getValue());
								if (form.getGlobalContext().Core.getPersonAddressIsNotNull())
									form.getGlobalContext().Core.getPersonAddress().setPCT(form.txtPctCode().getValue());
								displayAddress();
							}
							return personAddressResult[0].getPCT();
						}
						else
							return null;
					}	
				}
			}
		}
		
		return null;
	}

	protected void onBtnShowGeoCoOrdsClick() throws PresentationLogicException 
	{
		
		try {
			if (form.txtPost().getValue() != null && form.txtPost().getValue() != "")
			{
				GeoCoOrdVo vo = domain.getGeoCoOrds(form.txtPost().getValue());
				if (vo != null)
				{
					if (vo.getLatitudeIsNotNull() && vo.getLogitudeIsNotNull())
					{
						String format = String.format("Lattitude: %f Longitude: %f",vo.getLatitude(),vo.getLogitude());
						engine.showMessage(format);
					}
				}
			}
		} catch (DomainInterfaceException e) 
		{
			throw new PresentationLogicException(e.getMessage());
		}
		
		/*
		double[] coOrds;
		ims.core.vo.PersonAddress lpa = new ims.core.vo.PersonAddress();
		
		if (form.txtPost().getValue() != null)
		{
			if (form.getGlobalContext().Core.getPersonAddressIsNotNull())
				coOrds = engine.getAddressProvider().getLatitudeLogitude(form.getGlobalContext().Core.getPersonAddress());
			else
			{
				lpa.setAddressPostCode(form.txtPost().getValue());
				coOrds = engine.getAddressProvider().getLatitudeLogitude(lpa);
			}
			
			if (coOrds != null)
			{
				if (coOrds.length == 2)
				{
					String format = String.format("Lattitude: %f Longitude: %f",coOrds[0],coOrds[1]);
					engine.showMessage(format);
				}
			}
		}
		*/
		
	}

	@Override
	protected void onImbAddressHistoryClick() throws PresentationLogicException {
		engine.open(form.getForms().Core.AddressHistoryDlg, new Object[] { form.getGlobalContext().Core.getOtherAddresses() });
		
	}

	//wdev-13268
	public void setRequireAdress(Boolean enable) 
	{				
		if(Boolean.TRUE.equals(enable))
			form.txtAddress1().setRequired(true);
		else
			form.txtAddress1().setRequired(false);
		

		
	}

	//wdev-19176
	protected void onCmbAreaOfResidenceValueChanged() throws PresentationLogicException
	{
		if( form.getLocalContext().getaddressResult() == null)
		{
			form.getLocalContext().setaddressResult(new PersonAddress());
		}
		
		form.getLocalContext().getaddressResult().setAreaOfResidence(form.cmbAreaOfResidence().getValue());
		
	}

	//wdev-19232
	public void setRequireAreaOfResidence(Boolean enable)
	{
		if(Boolean.TRUE.equals(enable))
			form.cmbAreaOfResidence().setRequired(true);
		else
			form.cmbAreaOfResidence().setRequired(false);
		
	}

	//wdev-19528
	public void setConfigurableFields(DemographicControlsConfigVoCollection collfields)
	{
		if( collfields == null || collfields.size() == 0)
			return;
		
		for(int i = 0; i < collfields.size(); i++ )
		{
			DemographicControlsConfigVo tempVo = collfields.get(i); 
			
			if( tempVo != null )
			{
				if( ADDRESS1_DEMOGR.equals(tempVo.getControlIMSID()))
				{
					form.txtAddress1().setRequired(tempVo.getIsMandatory());
				}
				else if( ADDRESS2_DEMOGR.equals(tempVo.getControlIMSID()))
				{
					form.txtAddress2().setRequired(tempVo.getIsMandatory());
				}
				else if( ADDRESS3_DEMOGR.equals(tempVo.getControlIMSID()))
				{
					form.txtAddress3().setRequired(tempVo.getIsMandatory());
				}
				else if( ADDRESS4_DEMOGR.equals(tempVo.getControlIMSID()))
				{
					form.txtAddress4().setRequired(tempVo.getIsMandatory());
				}
				else if( form.txtAddress5().isVisible() && ADDRESS5_DEMOGR.equals(tempVo.getControlIMSID()))
				{
					form.txtAddress5().setRequired(tempVo.getIsMandatory());
				}
				else if( form.cmbAreaOfResidence().getVisible() && AREAOFRESIDENCE_DEMOGR.equals(tempVo.getControlIMSID()))
				{
					form.cmbAreaOfResidence().setRequired(tempVo.getIsMandatory());
				}
				else if( form.txtPost().isVisible() && POST_CODE_DEMOGR.equals(tempVo.getControlIMSID()))
				{
					form.txtPost().setRequired(tempVo.getIsMandatory());
				}
				else if( form.txtPctCode().isVisible() && CCG_CODE_DEMOGR.equals(tempVo.getControlIMSID()))
				{
					form.txtPctCode().setRequired(tempVo.getIsMandatory());
				}
				else if( form.cmbCounty().getVisible() && COUNTY_DEMOGR.equals(tempVo.getControlIMSID()))
				{
					form.cmbCounty().setRequired(tempVo.getIsMandatory());
				}
				else if( PHONE_DEMOGR.equals(tempVo.getControlIMSID()))
				{
					form.txtAddressPhone().setRequired(tempVo.getIsMandatory());
				}
				
			}
		}
		
	}

	//wdev-19528
	public String[] getUIErrorsForConfigurableMode()
	{
		ArrayList<String> errors = new ArrayList<String>();
		
		if( form.txtAddress1().isVisible() && form.txtAddress1().isRequired() && ( form.txtAddress1().getValue() == null || form.txtAddress1().getValue() == ""))
		{
			errors.add("The first line of the Address is mandatory.");
		}
		if( form.txtAddress2().isVisible() && form.txtAddress2().isRequired() && ( form.txtAddress2().getValue() == null || form.txtAddress2().getValue() == ""))
		{
			errors.add("The second line of the Address is mandatory.");
		}
		if( form.txtAddress3().isVisible() && form.txtAddress3().isRequired() && ( form.txtAddress3().getValue() == null || form.txtAddress3().getValue() == ""))
		{
			errors.add("The third line of the Address is mandatory.");
		}
		if( form.txtAddress4().isVisible() && form.txtAddress4().isRequired() && ( form.txtAddress4().getValue() == null || form.txtAddress4().getValue() == ""))
		{
			errors.add("The fourth line of the Address is mandatory.");
		}
		if( form.txtAddress5().isVisible() && form.txtAddress5().isRequired() && ( form.txtAddress5().getValue() == null || form.txtAddress5().getValue() == ""))
		{
			errors.add("The fifth line of the Address is mandatory.");
		}
		if( form.cmbAreaOfResidence().getVisible() && form.cmbAreaOfResidence().isRequired() && form.cmbAreaOfResidence().getValue() == null)
		{
			errors.add("Area of Residence is mandatory.");
		}
		if( form.txtPost().isVisible() && form.txtPost().isRequired() && ( form.txtPost().getValue() == null || form.txtPost().getValue() == ""))
		{
			errors.add("Post Code is mandatory.");
		}
		if( form.txtPctCode().isVisible() && form.txtPctCode().isRequired() && ( form.txtPctCode().getValue() == null || form.txtPctCode().getValue() == ""))
		{
			errors.add("CCG Code: is mandatory.");
		}
		if( form.cmbCounty().getVisible() && form.cmbCounty().isRequired() && form.cmbCounty().getValue() == null)
		{
			errors.add("County is mandatory.");
		}
		if( form.txtAddressPhone().isVisible() && form.txtAddressPhone().isRequired() && ( form.txtAddressPhone().getValue() == null || form.txtAddressPhone().getValue() == ""))
		{
			errors.add("Phone is mandatory.");
		}
		
		if( errors.size() > 0)
		{
			String[] UIErrors = new String[errors.size()];
			errors.toArray(UIErrors);
			return UIErrors;
		}

		return null;
	}
	
	private boolean isSVUH()
	{
		return ims.configuration.gen.ConfigFlag.UI.DEMOGRAPHICS_TYPE.getValue().equals("IRISH");
	}

	private boolean usePostCode()
	{
		return ConfigFlag.UI.DEMOGRAPHICS_USE_POSTCODE.getValue() == true;
	}
	
}
